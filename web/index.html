<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Vea 控制面</title>
    <style>
      :root {
        color-scheme: light;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        background-color: #f3f4f6;
        color: #0f172a;
      }

      body {
        margin: 0;
        display: flex;
        min-height: 100vh;
        background: linear-gradient(180deg, #f9fafb 0%, #e2e8f0 100%);
      }

      .sidebar {
        width: 240px;
        background: rgba(255, 255, 255, 0.9);
        border-right: 1px solid rgba(148, 163, 184, 0.35);
        padding: 32px 24px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: 24px;
        backdrop-filter: blur(8px);
        box-shadow: 12px 0 30px rgba(148, 163, 184, 0.18);
      }

      .brand {
        font-size: 20px;
        font-weight: 600;
        letter-spacing: 0.08em;
        text-transform: uppercase;
      }

      .menu {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .menu button {
        all: unset;
        padding: 12px 16px;
        border-radius: 12px;
        background: rgba(226, 232, 240, 0.6);
        color: #1f2937;
        font-size: 15px;
        cursor: pointer;
        transition: background 0.2s ease, transform 0.2s ease, color 0.2s ease;
      }

      .menu button:hover,
      .menu button.active {
        background: rgba(99, 102, 241, 0.18);
        color: #312e81;
        transform: translateX(4px);
      }

      main {
        flex: 1;
        padding: 48px 56px;
        box-sizing: border-box;
        display: flex;
        flex-direction: column;
        gap: 32px;
      }

      .status-bar {
        min-height: 44px;
        border-radius: 12px;
        background: rgba(255, 255, 255, 0.85);
        border: 1px solid rgba(148, 163, 184, 0.35);
        display: flex;
        align-items: center;
        padding: 0 18px;
        box-sizing: border-box;
        font-size: 14px;
        color: #1f2937;
        opacity: 0;
        transform: translateY(-10px);
        transition: opacity 0.25s ease, transform 0.25s ease;
      }

      .status-bar.visible {
        opacity: 1;
        transform: translateY(0);
      }

      .status-bar.success {
        border-color: rgba(34, 197, 94, 0.4);
        color: #166534;
      }

      .status-bar.error {
        border-color: rgba(248, 113, 113, 0.45);
        color: #7f1d1d;
      }

      .status-bar.info {
        border-color: rgba(99, 102, 241, 0.45);
        color: #312e81;
      }

      .panel {
        display: none;
        gap: 24px;
        flex-direction: column;
      }

      .panel.active {
        display: flex;
      }

      .panel-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        gap: 16px;
      }

      .panel-header h2 {
        margin: 0 0 8px;
        font-size: 28px;
      }

      .panel-header p {
        margin: 0;
        color: #4b5563;
        line-height: 1.6;
        font-size: 15px;
        max-width: 640px;
      }

      .panel-actions {
        display: flex;
        gap: 12px;
      }

      button {
        border: none;
        border-radius: 10px;
        padding: 10px 16px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: transform 0.15s ease, box-shadow 0.15s ease, opacity 0.2s ease;
      }

      button.primary {
        background: #6366f1;
        color: #ffffff;
        box-shadow: 0 8px 14px rgba(99, 102, 241, 0.3);
      }

      button.ghost {
        background: rgba(226, 232, 240, 0.8);
        color: #1f2937;
      }

      button.danger {
        background: #ef4444;
        color: #fff;
      }

      button:hover {
        transform: translateY(-2px);
      }

      button:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        transform: none;
      }

      .card {
        background: rgba(255, 255, 255, 0.92);
        border-radius: 18px;
        border: 1px solid rgba(203, 213, 225, 0.55);
        box-shadow: 0 24px 48px rgba(148, 163, 184, 0.25);
        padding: 24px;
        box-sizing: border-box;
      }

      .card h3 {
        margin: 0 0 16px;
        font-size: 20px;
      }

      .status-card {
        display: grid;
        grid-template-columns: minmax(0, 1fr) minmax(220px, 260px);
        gap: 24px;
        align-items: start;
      }

      .status-card-body {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .status-card-actions {
        display: flex;
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }

      .status-card-actions button {
        width: 100%;
      }

      .node-toolbar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        gap: 16px;
      }

      .node-toolbar-left {
        display: flex;
        align-items: center;
        gap: 16px;
      }

      .node-toolbar-actions {
        display: flex;
        align-items: center;
        gap: 12px;
      }

      .node-tabs {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
        margin: 16px 0 8px;
      }

      .node-tab {
        padding: 8px 14px;
        border-radius: 999px;
        background: rgba(226, 232, 240, 0.8);
        color: #1f2937;
        font-size: 13px;
        cursor: pointer;
        border: 1px solid rgba(203, 213, 225, 0.6);
        transition: background 0.15s ease, color 0.15s ease, transform 0.15s ease;
      }

      .node-tab:hover {
        transform: translateY(-1px);
        background: rgba(99, 102, 241, 0.18);
        color: #312e81;
      }

      .node-tab.active {
        background: rgba(99, 102, 241, 0.25);
        color: #1d4ed8;
        border-color: rgba(99, 102, 241, 0.4);
      }

      .add-node-button {
        width: 48px;
        height: 48px;
        border-radius: 16px;
        font-size: 28px;
        font-weight: 500;
        background: linear-gradient(135deg, #818cf8 0%, #6366f1 100%);
        color: #fff;
        border: none;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        box-shadow: 0 16px 32px rgba(99, 102, 241, 0.45);
        transition: transform 0.15s ease, box-shadow 0.15s ease;
      }

      .add-node-button:hover {
        transform: translateY(-2px);
        box-shadow: 0 20px 36px rgba(99, 102, 241, 0.55);
      }

      .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 16px 20px;
      }

      .component-buttons {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .status-line {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 16px;
      }

      .note {
        font-size: 13px;
        line-height: 1.6;
        color: #4b5563;
      }

      .home-node-card {
        display: flex;
        flex-direction: column;
        gap: 16px;
      }

      .home-node-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 12px 16px;
      }

      .home-node-grid div {
        display: flex;
        flex-direction: column;
        gap: 6px;
        min-width: 0;
      }

      .home-node-grid div > div {
        font-size: 16px;
        color: #0f172a;
        word-break: break-all;
      }

      .node-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
        gap: 18px;
      }

      .node-card {
        position: relative;
        padding: 20px;
        border-radius: 20px;
        background: rgba(255, 255, 255, 0.78);
        color: #0f172a;
        border: 1px solid rgba(203, 213, 225, 0.6);
        backdrop-filter: blur(16px);
        box-shadow: 0 24px 40px rgba(148, 163, 184, 0.28);
        display: flex;
        flex-direction: column;
        gap: 14px;
      }

      .node-card.active-node {
        border-color: rgba(99, 102, 241, 0.65);
        box-shadow: 0 28px 44px rgba(79, 70, 229, 0.35);
      }

      .node-card .muted {
        color: rgba(30, 41, 59, 0.6);
      }

      .node-card-header {
        display: flex;
        justify-content: space-between;
        gap: 12px;
        align-items: flex-start;
      }

      .node-card-title {
        font-size: 18px;
        font-weight: 600;
      }

      .node-card-address {
        font-size: 14px;
        color: rgba(30, 41, 59, 0.55);
        word-break: break-all;
      }

      .node-card-badges {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
        margin-top: 8px;
      }

      .node-card-controls {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
        gap: 8px;
      }

      .node-card .badge {
        background: rgba(99, 102, 241, 0.18);
        color: #312e81;
      }

      .node-card .badge.active {
        background: rgba(56, 189, 248, 0.25);
        color: #0f172a;
      }

      .node-card .badge.warn {
        background: rgba(251, 191, 36, 0.25);
        color: #92400e;
      }

      .node-card .badge.error {
        background: rgba(248, 113, 113, 0.25);
        color: #991b1b;
      }

      .node-card .tag {
        background: rgba(59, 130, 246, 0.18);
        color: #1d4ed8;
      }

      .node-card .node-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .node-card .node-metrics {
        display: flex;
        flex-wrap: wrap;
        gap: 10px 16px;
        font-size: 14px;
      }

      .node-card .node-metrics span {
        background: rgba(226, 232, 240, 0.8);
        padding: 6px 10px;
        border-radius: 12px;
        cursor: pointer;
        transition: background 0.15s ease;
      }

      .node-card .node-metrics span:hover {
        background: rgba(99, 102, 241, 0.18);
      }

      .node-card .node-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }

      .node-card .node-actions button {
        flex: 1 1 calc(50% - 10px);
        min-width: 110px;
      }

      .node-card .node-actions button.danger {
        flex-basis: 100%;
      }

      .node-card .node-select {
        width: 18px;
        height: 18px;
        accent-color: #6366f1;
      }

      .empty-card {
        padding: 40px 0;
        text-align: center;
        border-radius: 18px;
        border: 1px dashed rgba(203, 213, 225, 0.6);
        color: rgba(100, 116, 139, 0.9);
        background: rgba(226, 232, 240, 0.6);
      }

      .modal {
        position: fixed;
        inset: 0;
        display: none;
        align-items: center;
        justify-content: center;
        z-index: 200;
      }

      .modal.open {
        display: flex;
      }

      .modal-backdrop {
        position: absolute;
        inset: 0;
        background: rgba(2, 6, 23, 0.65);
        backdrop-filter: blur(8px);
      }

      .modal-content {
        position: relative;
        width: min(640px, 90%);
        max-height: 90vh;
        overflow-y: auto;
        z-index: 201;
      }

      .modal-close {
        position: absolute;
        top: 12px;
        right: 16px;
        background: transparent;
        border: none;
        color: rgba(226, 232, 240, 0.85);
        font-size: 24px;
        cursor: pointer;
      }

      .modal-form {
        margin-top: 12px;
      }

      .modal-actions {
        grid-column: 1 / -1;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
      }

      .component-buttons .button-group {
        display: flex;
        flex-wrap: wrap;
        gap: 12px;
      }

      .form-grid label {
        display: flex;
        flex-direction: column;
        gap: 6px;
        font-size: 14px;
        color: #1f2937;
      }

      input,
      select,
      textarea {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(203, 213, 225, 0.6);
        border-radius: 10px;
        color: #0f172a;
        padding: 10px 12px;
        font-size: 14px;
        resize: vertical;
      }

      textarea {
        min-height: 110px;
      }

      .form-actions {
        grid-column: 1 / -1;
        display: flex;
        justify-content: flex-end;
        gap: 12px;
      }

      .table-container {
        overflow-x: auto;
      }

      @media (max-width: 1200px) {
      }

      .table-actions {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 12px;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        font-size: 14px;
      }

      #config-table {
        table-layout: fixed;
      }

      #config-table th:first-child,
      #config-table td:first-child {
        width: 32%;
      }

      #config-table td:first-child {
        max-width: 360px;
      }

      #config-table td:first-child .text-break {
        display: block;
      }

      #config-table td:last-child {
        white-space: nowrap;
      }

      th,
      td {
        padding: 12px 14px;
        text-align: left;
        border-bottom: 1px solid rgba(203, 213, 225, 0.55);
      }

      th {
        font-weight: 600;
        color: #1f2937;
        background: rgba(241, 245, 249, 0.9);
      }

      tr:last-child td {
        border-bottom: none;
      }

      .tags {
        display: inline-flex;
        flex-wrap: wrap;
        gap: 6px;
      }

      .tag {
        padding: 4px 8px;
        border-radius: 999px;
        background: rgba(99, 102, 241, 0.25);
        color: #c7d2fe;
        font-size: 12px;
      }

      .empty {
        text-align: center;
        padding: 28px 0;
        color: rgba(100, 116, 139, 0.85);
      }

      .muted {
        color: #64748b;
      }

      .text-break {
        word-break: break-all;
        overflow-wrap: anywhere;
      }

      .badge {
        display: inline-flex;
        align-items: center;
        padding: 4px 8px;
        border-radius: 999px;
        font-size: 12px;
        background: rgba(59, 130, 246, 0.15);
        color: #1e40af;
      }

      .badge.active {
        background: rgba(14, 165, 233, 0.2);
        color: #0f172a;
      }

      .active-node {
        background: rgba(99, 102, 241, 0.12);
      }

      .badge.warn {
        background: rgba(251, 191, 36, 0.2);
        color: #92400e;
      }

      .badge.error {
        background: rgba(239, 68, 68, 0.2);
        color: #991b1b;
      }

      .rules-list {
        display: grid;
        gap: 12px;
      }

      @media (max-width: 1024px) {
        main {
          padding: 32px 24px;
        }
      }

      @media (max-width: 768px) {
        body {
          flex-direction: column;
        }

        .sidebar {
          width: 100%;
          flex-direction: row;
          align-items: center;
          justify-content: space-between;
        }

        .menu {
          flex-direction: row;
          gap: 8px;
        }

        .panel-header {
          flex-direction: column;
        }

        .status-card {
          grid-template-columns: 1fr;
        }

        .node-card .node-actions button {
          flex: 1 1 100%;
        }
      }
    </style>
  </head>
  <body>
    <aside class="sidebar">
      <div class="brand">Vea Console</div>
      <nav class="menu" id="menu">
        <button data-target="panel-home" class="active">主页</button>
        <button data-target="panel1">节点</button>
        <button data-target="panel2">配置</button>
        <button data-target="panel3">核心组件</button>
        <button data-target="panel4">流量策略</button>
        <button data-target="panel-settings">设置</button>
      </nav>
    </aside>
    <main>
      <div id="status" class="status-bar"></div>

      <section id="panel-home" class="panel active">
        <header class="panel-header">
          <div>
            <h2>主页</h2>
            <p>总览当前代理状态与选中节点的实时信息。</p>
          </div>
        </header>

        <div class="card status-card">
          <div class="status-card-body">
            <h3>代理控制</h3>
            <div class="status-line">
              <span id="proxy-status" class="badge warn">未安装</span>
              <span id="proxy-status-desc" class="muted">尚未检测到可用核心，请先安装。</span>
            </div>
            <p class="muted note">该控制区会自动安装缺失核心、启动 Xray 并配置系统代理，忽略主机列表可在“设置”中调整。</p>
          </div>
          <div class="status-card-actions">
            <button type="button" class="primary" id="proxy-toggle" data-mode="">启动代理</button>
          </div>
        </div>

        <div class="card home-node-card">
          <h3>当前节点</h3>
          <div class="home-node-grid">
            <div>
              <span class="muted">名称</span>
              <div id="home-node-name">-</div>
            </div>
            <div>
              <span class="muted">地址</span>
              <div id="home-node-address">-</div>
            </div>
            <div>
              <span class="muted">延迟</span>
              <div id="home-node-latency">~</div>
            </div>
            <div>
              <span class="muted">带宽</span>
              <div id="home-node-speed">~</div>
            </div>
            <div>
              <span class="muted">最后探测</span>
              <div id="home-node-updated">-</div>
            </div>
          </div>
        </div>
      </section>

      <section id="panel1" class="panel">
        <header class="panel-header">
          <div>
            <h2>节点管理</h2>
            <p>注册节点、跟踪探测结果并处理流量统计。标签用逗号分隔，协议输入遵循后端定义（vless、trojan、shadowsocks、vmess）。</p>
          </div>
          <div class="panel-actions">
            <span id="xray-state" class="badge">未安装</span>
            <button type="button" id="node-refresh" class="ghost">刷新</button>
          </div>
        </header>

        <div class="card node-toolbar">
          <div class="node-toolbar-left">
            <button type="button" id="node-add-button" class="add-node-button" title="新增节点">+</button>
          </div>
          <div class="node-toolbar-actions">
            <button type="button" id="node-bulk-ping" class="ghost">全部延迟</button>
            <button type="button" id="node-bulk-speed" class="ghost">全部测速</button>
          </div>
        </div>

        <div id="node-tabs" class="node-tabs"></div>

        <div id="node-grid" class="node-grid">
          <div class="empty-card">加载中…</div>
        </div>
      </section>

      <div id="node-modal" class="modal">
        <div class="modal-backdrop"></div>
        <div class="modal-content card">
          <button type="button" class="modal-close" id="node-modal-close" aria-label="关闭">&times;</button>
          <form id="node-form" class="form-grid modal-form">
            <h3 style="grid-column: 1 / -1; margin-bottom: 8px;">新增节点</h3>
            <label style="grid-column: 1 / -1">
              分享链接（vmess/vless/trojan）
              <input name="shareLink" type="text" placeholder="vmess://..." />
            </label>
            <label>
              名称
              <input name="name" type="text" placeholder="如：东京 01" />
            </label>
            <label>
              地址
              <input name="address" type="text" placeholder="example.com" />
            </label>
            <label>
              端口
              <input name="port" type="number" min="1" max="65535" value="443" />
            </label>
            <label>
              协议
              <select name="protocol">
                <option value="vless">vless</option>
                <option value="trojan">trojan</option>
                <option value="shadowsocks">shadowsocks</option>
                <option value="vmess">vmess</option>
              </select>
            </label>
            <label>
              标签（逗号分隔）
              <input name="tags" type="text" placeholder="premium,asia" />
            </label>
            <div class="form-actions modal-actions">
              <button type="reset" class="ghost" id="node-modal-reset">清空</button>
              <button type="submit" class="primary">保存节点</button>
            </div>
          </form>
        </div>
      </div>

      <section id="panel2" class="panel">
        <header class="panel-header">
          <div>
            <h2>配置中心</h2>
            <p>导入 xray / sing-box 等配置，支持直接粘贴 payload 或提供 sourceUrl 自动抓取；后台会按 `autoUpdateIntervalMinutes` 定期刷新。</p>
          </div>
          <div class="panel-actions">
            <button type="button" id="config-refresh" class="ghost">刷新</button>
          </div>
        </header>

        <form id="config-form" class="card form-grid">
          <h3>新增配置</h3>
          <label>
            名称
            <input name="name" type="text" placeholder="如：东京入口" required />
          </label>
          <label>
            sourceUrl（可选）
            <input name="sourceUrl" type="url" placeholder="https://example.com/config.json" />
          </label>
          <label style="grid-column: 1 / -1">
            订阅/远程链接
            <input name="subscriptionUrl" type="url" placeholder="https://example.com/subscription" />
          </label>
          <label>
            自动更新间隔（分钟）
            <input name="autoUpdateInterval" type="number" min="0" value="60" />
          </label>
          <label style="grid-column: 1 / -1">
            Payload（未提供 sourceUrl 时必填）
            <textarea name="payload" placeholder="{ &quot;outbounds&quot;: [] }"></textarea>
          </label>
          <div class="form-actions">
            <button type="reset" class="ghost">重置</button>
            <button type="submit" class="primary">添加配置</button>
          </div>
        </form>

        <div class="card table-container">
          <table id="config-table">
            <thead>
              <tr>
                <th>名称</th>
                <th>格式</th>
                <th>更新间隔</th>
                <th>上次同步</th>
                <th>状态</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" class="empty">加载中…</td></tr>
            </tbody>
          </table>
        </div>
      </section>

            <section id="panel3" class="panel">
        <header class="panel-header">
          <div>
            <h2>核心组件</h2>
            <p>管理 Xray / sing-box 内核的下载与更新，所有内容解压到 <code>artifacts/core</code>，安装时会自动覆盖旧版本。</p>
          </div>
        </header>

        <div class="card">
          <h3>内核管理</h3>
          <div class="component-buttons">
            <div class="button-group">
              <button type="button" class="primary ensure-component" data-kind="xray">安装 / 更新 Xray</button>
              <button type="button" class="ghost ensure-component" data-kind="singbox">安装 / 更新 sing-box</button>
              <button type="button" id="component-refresh" class="ghost">刷新列表</button>
            </div>
            <span class="muted">按钮会自动补齐缺失的组件记录，并从 GitHub Release 拉取最新版本。</span>
          </div>
          <div class="table-container">
            <table id="component-table">
              <thead>
                <tr>
                  <th>名称</th>
                  <th>类型</th>
                  <th>版本</th>
                  <th>安装目录</th>
                  <th>上次安装</th>
                  <th>状态</th>
                  <th>操作</th>
                </tr>
              </thead>
              <tbody>
                <tr><td colspan="7" class="empty">暂无组件</td></tr>
              </tbody>
            </table>
          </div>
        </div>
      </section>


      <section id="panel4" class="panel">
        <header class="panel-header">
          <div>
            <h2>流量策略</h2>
            <p>配置默认出口、DNS 方案以及分流规则。DNS 服务器可使用逗号或换行分隔。</p>
          </div>
          <div class="panel-actions">
            <button type="button" id="traffic-refresh" class="ghost">刷新</button>
          </div>
        </header>

        <form id="profile-form" class="card form-grid">
          <h3>默认出口与 DNS</h3>
          <label>
            默认节点 ID（可留空）
            <input name="defaultNodeId" type="text" placeholder="节点 ID" />
          </label>
          <label>
            DNS 策略
            <input name="dnsStrategy" type="text" placeholder="ipv4-only / prefer-ipv6 ..." />
          </label>
          <label style="grid-column: 1 / -1">
            DNS 服务器
            <textarea name="dnsServers" placeholder="8.8.8.8, 1.1.1.1"></textarea>
          </label>
          <div class="form-actions">
            <button type="submit" class="primary">保存配置</button>
          </div>
        </form>

        <form id="rule-form" class="card form-grid">
          <h3>新增分流规则</h3>
          <label>
            名称
            <input name="name" type="text" placeholder="Netflix" required />
          </label>
          <label>
            目标（逗号分隔）
            <input name="targets" type="text" placeholder="netflix.com, netflixcdn.com" required />
          </label>
          <label>
            节点 ID
            <input name="nodeId" type="text" placeholder="节点 ID" required />
          </label>
          <label>
            优先级（数字，越大越优先）
            <input name="priority" type="number" value="10" />
          </label>
          <div class="form-actions">
            <button type="reset" class="ghost">重置</button>
            <button type="submit" class="primary">添加规则</button>
          </div>
        </form>

        <div class="card table-container">
          <table id="rule-table">
            <thead>
              <tr>
                <th>名称</th>
                <th>节点</th>
                <th>目标</th>
                <th>优先级</th>
                <th>更新时间</th>
                <th>操作</th>
              </tr>
            </thead>
            <tbody>
              <tr><td colspan="6" class="empty">加载中…</td></tr>
            </tbody>
          </table>
        </div>
      </section>

      <section id="panel-settings" class="panel">
        <header class="panel-header">
          <div>
            <h2>设置</h2>
            <p>管理系统代理及忽略主机列表，如需更多高级选项可编辑配置文件或手动调整系统设置。</p>
          </div>
        </header>

        <div class="card" id="system-proxy-card">
          <h3>系统代理</h3>
          <p class="muted">指向 <code>127.0.0.1:38087</code> 的 SOCKS5 代理，本机地址会被自动忽略。</p>
          <div class="form-grid">
            <p class="muted" style="grid-column: 1 / -1">代理开关已移动到“主页”，此处仅维护忽略主机列表。</p>
            <label style="grid-column: 1 / -1">
              忽略主机（每行一个）
              <textarea id="system-proxy-ignore" placeholder="localhost
127.0.0.0/8
::1"></textarea>
            </label>
            <div class="form-actions">
              <button type="button" class="ghost" id="system-proxy-reset">恢复默认</button>
              <button type="button" class="primary" id="system-proxy-save">保存</button>
            </div>
          </div>
        </div>
      </section>

    </main>
    <script>
      (function () {
        const menu = document.getElementById("menu");
        const panels = document.querySelectorAll(".panel");
        const statusBar = document.getElementById("status");
        let currentPanel = "panel-home";
        let statusTimer = null;

        const api = {
          async request(path, options = {}) {
            const opts = {
              headers: {},
              ...options,
            };
            if (opts.body && !(opts.body instanceof FormData)) {
              opts.headers["Content-Type"] = "application/json";
              opts.body = JSON.stringify(opts.body);
            }
            const res = await fetch(path, opts);
            if (!res.ok) {
              let message = res.statusText;
              const text = await res.text();
              try {
                const parsed = JSON.parse(text);
                message = parsed.error || JSON.stringify(parsed);
              } catch {
                if (text) {
                  message = text;
                }
              }
              throw new Error(message || "请求失败");
            }
            if (res.status === 204) {
              return null;
            }
            const contentType = res.headers.get("content-type") || "";
            if (contentType.includes("application/json")) {
              return res.json();
            }
            return res.text();
          },
          get(path) {
            return this.request(path);
          },
          post(path, body) {
            return this.request(path, { method: "POST", body });
          },
          put(path, body) {
            return this.request(path, { method: "PUT", body });
          },
          delete(path) {
            return this.request(path, { method: "DELETE" });
          },
        };

        function showStatus(message, type = "info", delay = 3200) {
          if (!message) {
            statusBar.classList.remove("visible", "success", "error", "info");
            statusBar.textContent = "";
            return;
          }
          statusBar.textContent = message;
          statusBar.classList.remove("success", "error", "info");
          statusBar.classList.add("visible", type);
          if (statusTimer) {
            clearTimeout(statusTimer);
          }
          if (delay > 0) {
            statusTimer = setTimeout(() => {
              statusBar.classList.remove("visible");
            }, delay);
          }
        }

        function escapeHtml(value) {
          return String(value ?? "")
            .replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#39;");
        }

        function formatTime(value) {
          if (!value) return "-";
          const date = new Date(value);
          if (Number.isNaN(date.getTime())) return value;
          return date.toLocaleString();
        }

        function formatBytes(bytes) {
          const size = Number(bytes);
          if (!size || size <= 0) return "0 B";
          const units = ["B", "KB", "MB", "GB", "TB"];
          const index = Math.min(Math.floor(Math.log(size) / Math.log(1024)), units.length - 1);
          const value = size / Math.pow(1024, index);
          return `${value.toFixed(index === 0 ? 0 : 1)} ${units[index]}`;
        }

        function formatInterval(duration) {
          if (!duration) return "未设置";
          if (typeof duration === "number") {
            if (duration === 0) return "未设置";
            const minutes = Math.round(duration / 60000000000);
            return `${minutes} 分钟`;
          }
          if (typeof duration === "string") {
            if (duration === "0s" || duration === "0") return "未设置";
            return duration.replace("m0s", "m").replace("h0m0s", "h");
          }
          return String(duration);
        }

        function parseNumber(value) {
          const num = Number(value);
          return Number.isFinite(num) ? num : 0;
        }

        function parseList(input) {
          return input
            .split(/[\s,;\n]+/)
            .map((item) => item.trim())
            .filter(Boolean);
        }

        function sleep(ms) {
          return new Promise((resolve) => setTimeout(resolve, ms));
        }

        const SYSTEM_PROXY_DEFAULTS = ["localhost", "127.0.0.0/8", "::1"];
        let systemProxySettings = {
          enabled: false,
          ignoreHosts: [...SYSTEM_PROXY_DEFAULTS],
        };
        const HOME_PING_COOLDOWN = 60000;
        const HOME_SPEEDTEST_COOLDOWN = 60000;
        const homePingState = {
          running: false,
          lastNodeId: "",
          lastTriggeredAt: 0,
        };
        const homeSpeedtestState = {
          running: false,
          lastNodeId: "",
          lastTriggeredAt: 0,
        };
        let nodeTags = [];
        let currentNodeTab = "全部";

let xrayStatus = {
  enabled: false,
  running: false,
  activeNodeId: "",
  binary: "",
};
let nodesCache = [];
let componentsCache = [];
        let nodesPollHandle = null;
        const NODES_POLL_INTERVAL = 1000;

        function ensureNodesPolling() {
          if (nodesPollHandle) {
            return;
          }
          nodesPollHandle = setInterval(() => {
            loadNodes();
          }, NODES_POLL_INTERVAL);
        }

        async function refreshXrayStatus({ notify = false } = {}) {
          try {
            const status = await api.get("/xray/status");
            if ((!status || !status.binary) && componentsCache.length === 0) {
              try {
                const comps = await api.get("/components");
                componentsCache = Array.isArray(comps) ? comps : [];
              } catch {
                componentsCache = [];
              }
            }
            const normalized = {
              enabled: Boolean(status && status.enabled),
              running: Boolean(status && status.running),
              activeNodeId: (status && status.activeNodeId) || "",
              binary: (status && status.binary) || "",
              config: (status && status.config) || "",
            };
            xrayStatus = normalized;
            updateXrayUI(normalized);
            updateHomeNodeStatus();
            if (notify) {
              const text = normalized.enabled
                ? normalized.running
                  ? "Xray 已启动"
                  : "Xray 已启用"
                : "Xray 已停止";
              showStatus(text, "info");
            }
          } catch (err) {
            showStatus(`加载 Xray 状态失败：${err.message}`, "error", 6000);
          }
        }

        function updateXrayUI(status = {}) {
          if (!status || typeof status !== "object") {
            status = {};
          }
          const indicator = document.getElementById("xray-state");
          const proxyStatus = document.getElementById("proxy-status");
          const proxyDesc = document.getElementById("proxy-status-desc");
          const proxyToggle = document.getElementById("proxy-toggle");
          const xrayComponent = Array.isArray(componentsCache)
            ? componentsCache.find((component) => component && component.kind === "xray")
            : null;

          let binaryCandidate = typeof status.binary === "string" ? status.binary.trim() : "";
          if (!binaryCandidate && xrayComponent) {
            const meta = xrayComponent.meta || {};
            if (typeof meta.binary === "string" && meta.binary.trim() != "") {
              binaryCandidate = meta.binary.trim();
            } else if (typeof xrayComponent.installDir === "string" && xrayComponent.installDir.trim() != "") {
              binaryCandidate = `${xrayComponent.installDir.replace(/\/$/, "")}/xray`;
            }
          }
          if (!binaryCandidate) {
            binaryCandidate = "artifacts/core/xray/xray";
          }
          status.binary = binaryCandidate;
          const hasBinary = Boolean(binaryCandidate);

          if (indicator) {
            if (!hasBinary) {
              indicator.className = "badge warn";
              indicator.textContent = "未安装";
            } else if (status.enabled) {
              indicator.className = status.running ? "badge active" : "badge warn";
              indicator.textContent = status.running ? "运行中" : "已启用";
            } else {
              indicator.className = "badge";
              indicator.textContent = "已停止";
            }
          }

          const proxyEnabled = Boolean(systemProxySettings && systemProxySettings.enabled);
          if (!proxyStatus && !proxyToggle && !proxyDesc) {
            return;
          }

          if (!hasBinary) {
            if (proxyStatus) {
              proxyStatus.className = "badge warn";
              proxyStatus.textContent = "未安装";
            }
            if (proxyDesc) {
              proxyDesc.textContent = "尚未检测到可用核心，请先安装 Xray 或 sing-box。";
            }
            if (proxyToggle) {
              proxyToggle.disabled = true;
              proxyToggle.dataset.mode = "";
              proxyToggle.classList.remove("danger");
              proxyToggle.classList.add("primary");
              proxyToggle.textContent = "启动代理";
            }
            return;
          }

          if (proxyStatus) {
            if (status.enabled && status.running && proxyEnabled) {
              proxyStatus.className = "badge active";
              proxyStatus.textContent = "运行中";
              if (proxyDesc) {
                proxyDesc.textContent = "系统代理已指向 127.0.0.1:38087。";
              }
            } else if (status.enabled && !proxyEnabled) {
              proxyStatus.className = "badge warn";
              proxyStatus.textContent = "核心运行";
              if (proxyDesc) {
                proxyDesc.textContent = "核心已运行，系统代理尚未启用。";
              }
            } else if (status.enabled) {
              proxyStatus.className = "badge warn";
              proxyStatus.textContent = "核心待运行";
              if (proxyDesc) {
                proxyDesc.textContent = "核心正在启动，请稍候。";
              }
            } else {
              proxyStatus.className = "badge";
              proxyStatus.textContent = "已停止";
              if (proxyDesc) {
                proxyDesc.textContent = "点击启动代理即可启动核心并切换系统代理。";
              }
            }
          }

          if (proxyToggle) {
            proxyToggle.disabled = false;
            proxyToggle.classList.remove("primary", "danger");
            if (status.enabled && proxyEnabled) {
              proxyToggle.dataset.mode = "stop";
              proxyToggle.classList.add("danger");
              proxyToggle.textContent = "停止代理";
            } else {
              proxyToggle.dataset.mode = "start";
              proxyToggle.classList.add("primary");
              proxyToggle.textContent = "启动代理";
            }
          }
        }

        // Panel loaders
        let activeNodeId = "";

        async function loadNodes({ notify = false } = {}) {
          try {
            const payload = await api.get("/nodes");
            const nodes = Array.isArray(payload.nodes) ? payload.nodes : [];
            activeNodeId = typeof payload.activeNodeId === "string" ? payload.activeNodeId : "";
            nodesCache = nodes;
            updateNodeTabs(nodes);
            renderNodes(nodes, activeNodeId);
            updateHomeNodeStatus();
            refreshXrayStatus();
            if (notify) {
              showStatus("节点列表已刷新", "success");
            }
            if (currentPanel === "panel-home") {
              autoMeasureCurrentNode();
            }
          } catch (err) {
            showStatus(`加载节点失败：${err.message}`, "error", 6000);
            nodesCache = [];
            updateHomeNodeStatus();
          }
        }

        function updateNodeTabs(nodes) {
          if (!nodeTabs) return;
          const tags = new Set();
          nodes.forEach((node) => {
            if (Array.isArray(node.tags)) {
              node.tags.forEach((tag) => {
                const trimmed = String(tag || "").trim();
                if (trimmed) {
                  tags.add(trimmed);
                }
              });
            }
          });
          const sorted = ["全部", ...Array.from(tags).sort((a, b) => a.localeCompare(b, "zh-Hans-CN"))];
          nodeTags = sorted;
          if (!nodeTags.includes(currentNodeTab)) {
            currentNodeTab = "全部";
          }
          nodeTabs.innerHTML = nodeTags
            .map((tag) => {
              const active = tag === currentNodeTab ? "active" : "";
              return `<button type="button" class="node-tab ${active}" data-tag="${escapeHtml(tag)}">${escapeHtml(tag)}</button>`;
            })
            .join("");
        }

        function renderNodes(nodes, currentId = "") {
          if (!nodeGrid) return;
          let filtered = nodes;
          if (currentNodeTab !== "全部") {
            filtered = nodes.filter((node) => Array.isArray(node.tags) && node.tags.includes(currentNodeTab));
          }
          if (!Array.isArray(nodes) || nodes.length === 0) {
            nodeGrid.innerHTML = '<div class="empty-card">暂无节点</div>';
            return;
          }

          if (!Array.isArray(filtered) || filtered.length === 0) {
            nodeGrid.innerHTML = '<div class="empty-card">当前标签下暂无节点</div>';
            return;
          }

          nodeGrid.innerHTML = filtered
            .map((node) => {
              const rowId = escapeHtml(node.id);
              const isActive = currentId && node.id === currentId;
              const protocolBadges = [`<span class="badge">${escapeHtml(node.protocol)}</span>`]
                .filter(Boolean)
                .join(" ");
              const latencyValue =
                typeof node.lastLatencyMs === "number" && node.lastLatencyMs > 0 ? `${node.lastLatencyMs} ms` : "测延迟";
              let speedValue;
              if (typeof node.lastSpeedError === "string" && node.lastSpeedError) {
                speedValue = "测速失败";
              } else if (typeof node.lastSpeedMbps === "number" && node.lastSpeedMbps > 0) {
                const fixed = node.lastSpeedMbps >= 10 ? node.lastSpeedMbps.toFixed(1) : node.lastSpeedMbps.toFixed(2);
                speedValue = `${fixed} MB/s`;
              } else {
                speedValue = "测速";
              }
              return `
                <div class="node-card ${isActive ? "active-node" : ""}" data-id="${rowId}">
                  <div class="node-card-header">
                    <div>
                      <div class="node-card-title">${escapeHtml(node.name)}</div>
                      <div class="node-card-address">${escapeHtml(node.address)}:${escapeHtml(node.port)}</div>
                      <div class="node-card-badges">${protocolBadges}</div>
                    </div>
                    <div class="node-card-controls"></div>
                  </div>
                  <div class="node-metrics">
                    <span data-action="ping-node">${escapeHtml(latencyValue)}</span>
                    <span data-action="speed-node">${escapeHtml(speedValue)}</span>
                  </div>
                  <div class="node-actions">
                    <button class="danger" data-action="delete-node">删除</button>
                  </div>
                </div>
              `;
            })
            .join("");
        }

        async function loadConfigs({ notify = false } = {}) {
          try {
            const configs = await api.get("/configs");
            renderConfigs(configs);
            if (notify) {
              showStatus("配置列表已刷新", "success");
            }
          } catch (err) {
            showStatus(`加载配置失败：${err.message}`, "error", 6000);
          }
        }

        function renderConfigs(configs) {
          const tbody = document.querySelector("#config-table tbody");
          if (!Array.isArray(configs) || configs.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty">暂无配置</td></tr>';
            return;
          }
          tbody.innerHTML = configs
            .map((cfg) => {
              const syncState = cfg.lastSyncError
                ? `<span class="badge error">失败：${escapeHtml(cfg.lastSyncError)}</span>`
                : '<span class="badge">正常</span>';
              const source = cfg.sourceUrl ? `<br /><span class="muted text-break">${escapeHtml(cfg.sourceUrl)}</span>` : "";
              return `
                <tr data-id="${escapeHtml(cfg.id)}">
                  <td>${escapeHtml(cfg.name)}${source}</td>
                  <td><span class="badge">${escapeHtml(cfg.format)}</span></td>
                  <td>${formatInterval(cfg.autoUpdateInterval)}</td>
                  <td>${formatTime(cfg.lastSyncedAt)}</td>
                  <td>${syncState}</td>
                  <td>
                    <button class="ghost" data-action="pull-nodes">拉取节点</button>
                    <button class="ghost" data-action="refresh-config">刷新</button>
                    <button class="danger" data-action="delete-config">删除</button>
                  </td>
                </tr>
              `;
            })
            .join("");
        }

        function renderSystemProxy(settings) {
          if (!systemProxyIgnoreInput) return;
          const hosts = Array.isArray(settings.ignoreHosts) ? settings.ignoreHosts : [];
          systemProxyIgnoreInput.value = hosts.join("\n");
        }

        async function loadSystemProxySettings({ notify = false } = {}) {
          if (!systemProxyIgnoreInput) return;
          try {
            const payload = await api.get("/settings/system-proxy");
            const data = payload && payload.settings ? payload.settings : payload;
            systemProxySettings = {
              enabled: Boolean(data.enabled),
              ignoreHosts: Array.isArray(data.ignoreHosts) ? data.ignoreHosts : [...SYSTEM_PROXY_DEFAULTS],
            };
            renderSystemProxy(systemProxySettings);
            updateXrayUI(xrayStatus);
            if (notify) {
              const msg = payload && payload.message ? payload.message : "系统代理设置已刷新";
              showStatus(msg, payload && payload.message ? "info" : "success");
            }
          } catch (err) {
            showStatus(`加载系统代理失败：${err.message}`, "error", 6000);
          }
        }

        function collectIgnoreHosts() {
          if (!systemProxyIgnoreInput) {
            return Array.isArray(systemProxySettings.ignoreHosts)
              ? [...systemProxySettings.ignoreHosts]
              : [...SYSTEM_PROXY_DEFAULTS];
          }
          return systemProxyIgnoreInput
            .value.split(/\r?\n/)
            .map((item) => item.trim())
            .filter(Boolean);
        }

        function updateHomeNodeStatus() {
          if (!homeNodeName || !homeNodeAddress || !homeNodeLatency || !homeNodeSpeed || !homeNodeUpdated) return;
          let node = null;
          if (Array.isArray(nodesCache) && nodesCache.length > 0) {
            if (xrayStatus.activeNodeId) {
              node = nodesCache.find((item) => item.id === xrayStatus.activeNodeId) || null;
            }
            if (!node) {
              node = nodesCache[0];
            }
          }
          if (!node) {
            homeNodeName.textContent = "-";
            homeNodeAddress.textContent = "-";
            homeNodeLatency.textContent = "~";
            homeNodeSpeed.textContent = "~";
            homeNodeUpdated.textContent = "-";
            return;
          }

          homeNodeName.textContent = escapeHtml(node.name || "-");
          homeNodeAddress.textContent = node.address ? `${escapeHtml(node.address)}:${escapeHtml(String(node.port || ""))}` : "-";

          const latency = typeof node.lastLatencyMs === "number" && node.lastLatencyMs > 0 ? `${node.lastLatencyMs} ms` : "~";
          let speed;
          if (node.lastSpeedError) {
            speed = `失败 ${escapeHtml(node.lastSpeedError)}`;
          } else if (typeof node.lastSpeedMbps === "number" && node.lastSpeedMbps > 0) {
            speed = `${node.lastSpeedMbps >= 10 ? node.lastSpeedMbps.toFixed(1) : node.lastSpeedMbps.toFixed(2)} MB/s`;
          } else {
            speed = "~";
          }
          homeNodeLatency.textContent = latency;
          homeNodeSpeed.textContent = speed;

        const timestamps = [node.lastLatencyAt, node.lastSpeedAt].filter(Boolean);
        const updated = timestamps.length > 0 ? timestamps.sort().slice(-1)[0] : null;
        homeNodeUpdated.textContent = updated ? formatTime(updated) : "-";
      }

      function resolveHomeNodeId() {
        if (!Array.isArray(nodesCache) || nodesCache.length === 0) {
          return "";
        }
        if (xrayStatus && xrayStatus.activeNodeId) {
          const active = nodesCache.find((item) => item.id === xrayStatus.activeNodeId);
          if (active && active.id) {
            return active.id;
          }
        }
        return nodesCache[0].id || "";
      }

      async function autoPingCurrentNode(targetId, { force = false } = {}) {
        const nodeId = targetId || resolveHomeNodeId();
        if (!nodeId) {
          return false;
        }
        const now = Date.now();
        if (!force) {
          if (homePingState.running && now - homePingState.lastTriggeredAt < HOME_PING_COOLDOWN) {
            return false;
          }
          if (homePingState.lastNodeId === nodeId && now - homePingState.lastTriggeredAt < HOME_PING_COOLDOWN) {
            return false;
          }
          const node = Array.isArray(nodesCache) ? nodesCache.find((item) => item.id === nodeId) : null;
          if (node) {
            const lastLatencyAt = node.lastLatencyAt ? Date.parse(node.lastLatencyAt) : NaN;
            if (!Number.isNaN(lastLatencyAt) && now - lastLatencyAt < HOME_PING_COOLDOWN) {
              return false;
            }
          }
        }
        homePingState.running = true;
        homePingState.lastNodeId = nodeId;
        homePingState.lastTriggeredAt = now;
        try {
          await api.post(`/nodes/${nodeId}/ping`);
          return true;
        } catch (err) {
          showStatus(`延迟任务失败：${err.message}`, "error", 6000);
          return false;
        } finally {
          homePingState.running = false;
        }
      }

      async function autoSpeedtestCurrentNode(targetId, { force = false } = {}) {
        const nodeId = targetId || resolveHomeNodeId();
        if (!nodeId) {
          return false;
        }
        const now = Date.now();
        if (!force) {
          if (homeSpeedtestState.running && now - homeSpeedtestState.lastTriggeredAt < HOME_SPEEDTEST_COOLDOWN) {
            return false;
          }
          if (homeSpeedtestState.lastNodeId === nodeId && now - homeSpeedtestState.lastTriggeredAt < HOME_SPEEDTEST_COOLDOWN) {
            return false;
          }
          const node = Array.isArray(nodesCache) ? nodesCache.find((item) => item.id === nodeId) : null;
          if (node && (!node.lastSpeedError || node.lastSpeedError.length === 0)) {
            const lastSpeedAt = node.lastSpeedAt ? Date.parse(node.lastSpeedAt) : NaN;
            if (!Number.isNaN(lastSpeedAt) && now - lastSpeedAt < HOME_SPEEDTEST_COOLDOWN) {
              return false;
            }
          }
        }
        homeSpeedtestState.running = true;
        homeSpeedtestState.lastNodeId = nodeId;
        homeSpeedtestState.lastTriggeredAt = now;
        try {
          await api.post(`/nodes/${nodeId}/speedtest`);
          return true;
        } catch (err) {
          showStatus(`测速任务失败：${err.message}`, "error", 6000);
          return false;
        } finally {
          homeSpeedtestState.running = false;
        }
      }

      async function autoMeasureCurrentNode() {
        const targetId = resolveHomeNodeId();
        if (!targetId) {
          return;
        }
        const pingTriggered = await autoPingCurrentNode(targetId);
        if (pingTriggered) {
          await sleep(200);
        }
        await autoSpeedtestCurrentNode(targetId);
      }

       async function loadHomePanel({ notify = false } = {}) {
          await Promise.all([loadComponents(), refreshXrayStatus({ notify }), loadSystemProxySettings({ notify })]);
          updateHomeNodeStatus();
          await autoMeasureCurrentNode();
        }

        async function handleProxyToggle() {
          if (!proxyToggleButton || proxyToggleButton.disabled) return;
          const mode = proxyToggleButton.dataset.mode || "start";
          proxyToggleButton.disabled = true;
          try {
            if (mode === "stop") {
              await api.put("/settings/system-proxy", {
                enabled: false,
                ignoreHosts: collectIgnoreHosts(),
              });
              await api.post("/xray/stop");
              showStatus("代理已停止", "info");
            } else {
              const payload = {};
              if (activeNodeId) {
                payload.activeNodeId = activeNodeId;
              }
              if (Object.keys(payload).length > 0) {
                await api.post("/xray/start", payload);
              } else {
                await api.post("/xray/start");
              }
              const response = await api.put("/settings/system-proxy", {
                enabled: true,
                ignoreHosts: collectIgnoreHosts(),
              });
              const msg = response && response.message ? response.message : "代理已启动";
              showStatus(msg, response && response.message ? "info" : "success");
            }
          } catch (err) {
            showStatus(`代理操作失败：${err.message}`, "error", 6000);
          } finally {
            proxyToggleButton.disabled = false;
            await refreshXrayStatus();
            await loadSystemProxySettings();
          }
        }

        function renderComponents(components) {
          const tbody = document.querySelector("#component-table tbody");
          if (!tbody) return;
          if (!Array.isArray(components) || components.length === 0) {
            tbody.innerHTML = '<tr><td colspan="7" class="empty">暂无组件</td></tr>';
            return;
          }
          tbody.innerHTML = components
            .map((component) => {
              const id = escapeHtml(component.id || "");
              const name = escapeHtml(component.name || "-");
              const kind = escapeHtml(componentDisplayName(component.kind));
              const version = escapeHtml(component.lastVersion || "-");
              const installDir = escapeHtml(component.installDir || "-");
              const installedAt = formatTime(component.lastInstalledAt);
              let statusText;
              if (component.lastSyncError) {
                statusText = `<span class="badge error">失败：${escapeHtml(component.lastSyncError)}</span>`;
              } else if (component.installDir) {
                statusText = '<span class="badge">已安装</span>';
              } else {
                statusText = '<span class="badge warn">未安装</span>';
              }
              const interval = formatInterval(component.autoUpdateInterval);
              return `
                <tr data-id="${id}">
                  <td>${name}</td>
                  <td><span class="badge">${kind}</span></td>
                  <td>${version}</td>
                  <td><span class="muted">${installDir}</span></td>
                  <td>${installedAt}</td>
                  <td>${statusText}<br /><span class="muted">自动更新：${interval}</span></td>
                  <td>
                    <button class="primary" data-action="install-component">安装 / 更新</button>
                    <button class="danger" data-action="delete-component">删除</button>
                  </td>
                </tr>
              `;
            })
            .join("");
        }

        async function loadComponents({ notify = false } = {}) {
          try {
            const components = await api.get("/components");
            componentsCache = Array.isArray(components) ? components : [];
            renderComponents(components);
            await refreshXrayStatus();
            if (notify) {
              showStatus("组件列表已刷新", "success");
            }
          } catch (err) {
            showStatus(`加载组件失败：${err.message}`, "error", 6000);
            componentsCache = [];
            await refreshXrayStatus();
          }
        }

        function componentDisplayName(kind) {
          switch (kind) {
            case "xray":
              return "Xray";
            case "singbox":
              return "sing-box";
            default:
              return kind || "组件";
          }
        }

        async function ensureComponent(kind) {
          const pretty = componentDisplayName(kind);
          try {
            let components = [];
            try {
              components = await api.get("/components");
            } catch {
              components = [];
            }
            componentsCache = Array.isArray(components) ? components : [];
            let target = Array.isArray(components) ? components.find((item) => item.kind === kind) : null;
            if (!target) {
              target = await api.post("/components", { kind });
            }
            await api.post(`/components/${target.id}/install`);
            showStatus(`${pretty} 安装任务已触发`, "info", 2400);
            await loadComponents();
            await refreshXrayStatus();
          } catch (err) {
            showStatus(`${pretty} 安装失败：${err.message}`, "error", 6000);
          }
        }

        async function loadTraffic({ notify = false } = {}) {
          try {
            const [profile, rules] = await Promise.all([api.get("/traffic/profile"), api.get("/traffic/rules")]);
            renderTrafficProfile(profile);
            renderTrafficRules(rules);
            if (notify) {
              showStatus("流量策略已刷新", "success");
            }
          } catch (err) {
            showStatus(`加载流量策略失败：${err.message}`, "error", 6000);
          }
        }

        function renderTrafficProfile(profile) {
          const form = document.getElementById("profile-form");
          form.defaultNodeId.value = profile.defaultNodeId || "";
          form.dnsStrategy.value = (profile.dns && profile.dns.strategy) || "";
          form.dnsServers.value = (profile.dns && profile.dns.servers ? profile.dns.servers.join("\n") : "");
        }

        function renderTrafficRules(rules) {
          const tbody = document.querySelector("#rule-table tbody");
          if (!Array.isArray(rules) || rules.length === 0) {
            tbody.innerHTML = '<tr><td colspan="6" class="empty">暂无规则</td></tr>';
            return;
          }
          tbody.innerHTML = rules
            .map((rule) => {
              const targets =
                Array.isArray(rule.targets) && rule.targets.length
                  ? rule.targets.map((target) => `<span class="tag">${escapeHtml(target)}</span>`).join("")
                  : '<span class="muted">-</span>';
              return `
                <tr data-id="${escapeHtml(rule.id)}">
                  <td>${escapeHtml(rule.name)}</td>
                  <td>${escapeHtml(rule.nodeId)}</td>
                  <td><div class="tags">${targets}</div></td>
                  <td>${escapeHtml(rule.priority ?? "-")}</td>
                  <td>${formatTime(rule.updatedAt)}</td>
                  <td>
                    <button class="danger" data-action="delete-rule">删除</button>
                  </td>
                </tr>
              `;
            })
            .join("");
        }

        const loaders = {
          "panel-home": () => loadHomePanel(),
          panel1: loadNodes,
          panel2: loadConfigs,
          panel3: () => loadComponents(),
          panel4: loadTraffic,
          "panel-settings": () => loadSystemProxySettings(),
        };

        menu.addEventListener("click", (event) => {
          const button = event.target.closest("button[data-target]");
          if (!button) return;
          const target = button.dataset.target;
          if (target === currentPanel) return;
          currentPanel = target;
          menu.querySelectorAll("button").forEach((btn) => btn.classList.remove("active"));
          button.classList.add("active");
          panels.forEach((panel) => {
            panel.classList.toggle("active", panel.id === target);
          });
          loaders[target]?.();
        });

        const nodeGrid = document.getElementById("node-grid");
        const nodeTabs = document.getElementById("node-tabs");
        const nodeAddButton = document.getElementById("node-add-button");
        const nodeModal = document.getElementById("node-modal");
        const nodeModalClose = document.getElementById("node-modal-close");
        const nodeModalReset = document.getElementById("node-modal-reset");
        const nodeModalBackdrop = nodeModal ? nodeModal.querySelector(".modal-backdrop") : null;
        const nodeForm = document.getElementById("node-form");
        document.getElementById("node-refresh").addEventListener("click", () => loadNodes({ notify: true }));
        document.getElementById("config-refresh").addEventListener("click", () => loadConfigs({ notify: true }));
        document.getElementById("traffic-refresh").addEventListener("click", () => loadTraffic({ notify: true }));
        document.getElementById("component-refresh").addEventListener("click", () => loadComponents({ notify: true }));
        const systemProxyIgnoreInput = document.getElementById("system-proxy-ignore");
        const systemProxySaveButton = document.getElementById("system-proxy-save");
        const systemProxyResetButton = document.getElementById("system-proxy-reset");
        const proxyToggleButton = document.getElementById("proxy-toggle");
        const homeNodeName = document.getElementById("home-node-name");
        const homeNodeAddress = document.getElementById("home-node-address");
        const homeNodeLatency = document.getElementById("home-node-latency");
        const homeNodeSpeed = document.getElementById("home-node-speed");
        const homeNodeUpdated = document.getElementById("home-node-updated");
        if (proxyToggleButton) {
          proxyToggleButton.addEventListener("click", handleProxyToggle);
        }

        function openNodeModal() {
          if (!nodeModal) return;
          nodeModal.classList.add("open");
        }

        function closeNodeModal() {
          if (!nodeModal) return;
          nodeModal.classList.remove("open");
        }

        if (nodeAddButton) {
          nodeAddButton.addEventListener("click", openNodeModal);
        }
        if (nodeModalClose) {
          nodeModalClose.addEventListener("click", closeNodeModal);
        }
        if (nodeModalBackdrop) {
          nodeModalBackdrop.addEventListener("click", closeNodeModal);
        }
        document.addEventListener("keydown", (event) => {
          if (event.key === "Escape" && nodeModal?.classList.contains("open")) {
            closeNodeModal();
          }
        });
        if (nodeModalReset && nodeForm) {
          nodeModalReset.addEventListener("click", () => {
            nodeForm.reset();
          });
        }

        if (nodeForm) {
          nodeForm.addEventListener("submit", async (event) => {
            event.preventDefault();
            const form = event.target;
            const shareLink = form.shareLink.value.trim();
            if (shareLink) {
              try {
                await api.post("/nodes", { shareLink });
                form.reset();
                showStatus("节点添加成功", "success");
                await loadNodes();
                closeNodeModal();
              } catch (err) {
                showStatus(`添加节点失败：${err.message}`, "error", 6000);
              }
              return;
            }
            const payload = {
              name: form.name.value.trim(),
              address: form.address.value.trim(),
              port: parseNumber(form.port.value),
              protocol: form.protocol.value.trim(),
              tags: parseList(form.tags.value),
            };
            if (!payload.name || !payload.address || !payload.protocol || !payload.port) {
              showStatus("请完整填写节点信息", "error");
              return;
            }
            try {
              await api.post("/nodes", payload);
              form.reset();
              showStatus("节点添加成功", "success");
              await loadNodes();
              closeNodeModal();
            } catch (err) {
              showStatus(`添加节点失败：${err.message}`, "error", 6000);
            }
          });
        }

        if (nodeGrid) {
          nodeGrid.addEventListener("click", async (event) => {
            const card = event.target.closest(".node-card[data-id]");
            if (!card) return;
            const id = card.dataset.id;
            const actionTarget = event.target.closest("[data-action]");
            const action = actionTarget ? actionTarget.dataset.action : "select-node";
            try {
              if (action === "delete-node") {
                if (!confirm("确认删除该节点？")) return;
                await api.delete(`/nodes/${id}`);
                showStatus("节点已删除", "success");
                await loadNodes();
              } else if (action === "ping-node") {
                await api.post(`/nodes/${id}/ping`);
                showStatus("延迟任务已排队", "info");
                await loadNodes();
              } else if (action === "speed-node") {
                await api.post(`/nodes/${id}/speedtest`);
                showStatus("测速任务已排队", "info");
                await loadNodes();
              } else if (action === "select-node") {
                await api.post(`/nodes/${id}/select`);
                showStatus("已切换当前节点", "success");
                await loadNodes();
              }
            } catch (err) {
              showStatus(`操作失败：${err.message}`, "error", 6000);
            }
          });
        }

        if (nodeTabs) {
          nodeTabs.addEventListener("click", (event) => {
            const button = event.target.closest(".node-tab[data-tag]");
            if (!button) return;
            const tag = button.dataset.tag;
            if (tag === currentNodeTab) return;
            currentNodeTab = tag;
            nodeTabs.querySelectorAll(".node-tab").forEach((tab) => tab.classList.remove("active"));
            button.classList.add("active");
            renderNodes(nodesCache, activeNodeId);
          });
        }

        document.getElementById("config-form").addEventListener("submit", async (event) => {
          event.preventDefault();
          const form = event.target;
          const subscriptionUrl = form.subscriptionUrl.value.trim();
          let inferredFormat = "";
          const typedPayload = (form.payload.value || "").trim();
          const sourceUrl = form.sourceUrl.value.trim();
          const detectSample = typedPayload || sourceUrl || subscriptionUrl;
          if (detectSample) {
            const lower = detectSample.toLowerCase();
            if (lower.startsWith("http") && lower.includes("clash")) {
              inferredFormat = "clash";
            } else if (lower.includes("sing-box") || lower.includes("singbox")) {
              inferredFormat = "singbox-json";
            } else if (/vmess|trojan|vless|ss:/.test(lower)) {
              inferredFormat = "v2rayn";
            } else if (/\"outbounds\"/.test(detectSample) || /\"inbounds\"/.test(detectSample)) {
              inferredFormat = "xray-json";
            }
          }
          const payload = {
            name: form.name.value.trim(),
            format: inferredFormat || "xray-json",
            sourceUrl,
            payload: typedPayload,
            autoUpdateIntervalMinutes: parseNumber(form.autoUpdateInterval.value),
          };
          if (subscriptionUrl) {
            payload.sourceUrl = subscriptionUrl;
          }
          if (!payload.sourceUrl && !payload.payload.trim()) {
            showStatus("未提供 sourceUrl 时必须填写 payload", "error", 5000);
            return;
          }
          try {
            await api.post("/configs/import", payload);
            form.reset();
            showStatus("配置添加成功", "success");
            await Promise.all([loadConfigs(), loadNodes()]);
          } catch (err) {
            showStatus(`添加配置失败：${err.message}`, "error", 6000);
          }
        });

        function getSelectedNodeIds() {
          if (!nodeGrid) return [];
          return Array.from(nodeGrid.querySelectorAll(".node-card[data-id]"))
            .map((card) => card.dataset.id)
            .filter(Boolean);
        }

        document.getElementById("node-bulk-ping").addEventListener("click", async () => {
          const ids = getSelectedNodeIds();
          if (ids.length === 0) {
            showStatus("请先勾选节点", "error");
            return;
          }
          try {
            await api.post("/nodes/bulk/ping", { ids });
            showStatus("批量延迟任务已排队", "info");
            await loadNodes();
          } catch (err) {
            showStatus(`批量延迟失败：${err.message}`, "error", 6000);
          }
        });

        document.getElementById("node-bulk-speed").addEventListener("click", async () => {
          const ids = getSelectedNodeIds();
          if (ids.length === 0) {
            showStatus("请先勾选节点", "error");
            return;
          }
          try {
            await api.post("/nodes/reset-speed", { ids });
            await loadNodes();
            for (const id of ids) {
              await api.post(`/nodes/${id}/speedtest`);
            }
            showStatus("批量测速任务已排队", "info");
            await loadNodes();
          } catch (err) {
            showStatus(`批量测速失败：${err.message}`, "error", 6000);
          }
        });

        document.getElementById("config-table").addEventListener("click", async (event) => {
          const button = event.target.closest("button[data-action]");
          if (!button) return;
          const tr = button.closest("tr[data-id]");
          if (!tr) return;
          const id = tr.dataset.id;
          const action = button.dataset.action;
          try {
            if (action === "refresh-config") {
              await api.post(`/configs/${id}/refresh`);
              showStatus("配置刷新完成", "success");
              await Promise.all([loadConfigs(), loadNodes()]);
            } else if (action === "pull-nodes") {
              const nodes = await api.post(`/configs/${id}/pull-nodes`);
              renderNodes(nodes);
              showStatus(`订阅节点已同步（${nodes.length}）`, "success");
              await Promise.all([loadConfigs(), loadNodes()]);
            } else if (action === "delete-config") {
              if (!confirm("确认删除该配置？")) return;
              await api.delete(`/configs/${id}`);
              showStatus("配置已删除", "success");
              await Promise.all([loadConfigs(), loadNodes()]);
            }
          } catch (err) {
            showStatus(`操作失败：${err.message}`, "error", 6000);
          }
        });

        if (systemProxySaveButton) {
          systemProxySaveButton.addEventListener("click", async () => {
            try {
              systemProxySaveButton.disabled = true;
              const payload = {
                enabled: Boolean(systemProxySettings && systemProxySettings.enabled),
                ignoreHosts: collectIgnoreHosts(),
              };
              const response = await api.put("/settings/system-proxy", payload);
              const data = response && response.settings ? response.settings : response;
              systemProxySettings = {
                enabled: Boolean(data.enabled),
                ignoreHosts: Array.isArray(data.ignoreHosts) ? data.ignoreHosts : [...SYSTEM_PROXY_DEFAULTS],
              };
              renderSystemProxy(systemProxySettings);
              updateXrayUI(xrayStatus);
              const msg = response && response.message ? response.message : "系统代理设置已保存";
              showStatus(msg, response && response.message ? "info" : "success");
            } catch (err) {
              showStatus(`保存系统代理失败：${err.message}`, "error", 6000);
            } finally {
              systemProxySaveButton.disabled = false;
            }
          });
        }

        if (systemProxyResetButton) {
          systemProxyResetButton.addEventListener("click", () => {
            systemProxySettings = {
              ...systemProxySettings,
              ignoreHosts: [...SYSTEM_PROXY_DEFAULTS],
            };
            renderSystemProxy(systemProxySettings);
            updateXrayUI(xrayStatus);
          });
        }

        renderSystemProxy(systemProxySettings);

        const componentTable = document.getElementById("component-table");
        if (componentTable) {
          componentTable.addEventListener("click", async (event) => {
            const button = event.target.closest("button[data-action]");
            if (!button) return;
            const tr = button.closest("tr[data-id]");
            if (!tr) return;
            const id = tr.dataset.id;
            const action = button.dataset.action;
            try {
              if (action === "install-component") {
                await api.post(`/components/${id}/install`);
                showStatus("组件更新任务已触发", "info");
                await loadComponents();
                await refreshXrayStatus();
              } else if (action === "delete-component") {
                if (!confirm("确认删除该组件？")) return;
                await api.delete(`/components/${id}`);
                showStatus("组件已删除", "success");
                await loadComponents();
                await refreshXrayStatus();
              }
            } catch (err) {
              showStatus(`组件操作失败：${err.message}`, "error", 6000);
            }
          });
        }

        document.querySelectorAll(".ensure-component").forEach((button) => {
          button.addEventListener("click", async () => {
            const kind = button.dataset.kind;
            if (!kind) return;
            button.disabled = true;
            try {
              await ensureComponent(kind);
            } finally {
              button.disabled = false;
            }
          });
        });

        document.getElementById("profile-form").addEventListener("submit", async (event) => {
          event.preventDefault();
          const form = event.target;
          const payload = {
            defaultNodeId: form.defaultNodeId.value.trim(),
            dns: {
              strategy: form.dnsStrategy.value.trim(),
              servers: parseList(form.dnsServers.value),
            },
          };
          try {
            const updated = await api.put("/traffic/profile", payload);
            renderTrafficProfile(updated);
            showStatus("默认出口与 DNS 已更新", "success");
          } catch (err) {
            showStatus(`更新失败：${err.message}`, "error", 6000);
          }
        });

        document.getElementById("rule-form").addEventListener("submit", async (event) => {
          event.preventDefault();
          const form = event.target;
          const payload = {
            name: form.name.value.trim(),
            targets: parseList(form.targets.value),
            nodeId: form.nodeId.value.trim(),
            priority: parseNumber(form.priority.value),
          };
          if (!payload.name || payload.targets.length === 0 || !payload.nodeId) {
            showStatus("请完整填写规则信息", "error");
            return;
          }
          try {
            await api.post("/traffic/rules", payload);
            form.reset();
            showStatus("规则添加成功", "success");
            await loadTraffic();
          } catch (err) {
            showStatus(`添加规则失败：${err.message}`, "error", 6000);
          }
        });

        document.getElementById("rule-table").addEventListener("click", async (event) => {
          const button = event.target.closest("button[data-action]");
          if (!button) return;
          const tr = button.closest("tr[data-id]");
          if (!tr) return;
          const id = tr.dataset.id;
          const action = button.dataset.action;
          if (action !== "delete-rule") return;
          try {
            if (!confirm("确认删除该分流规则？")) return;
            await api.delete(`/traffic/rules/${id}`);
            showStatus("规则已删除", "success");
            await loadTraffic();
          } catch (err) {
            showStatus(`删除失败：${err.message}`, "error", 6000);
          }
        });

        // Initial load
        loadNodes();
        loaders[currentPanel]?.();
        ensureNodesPolling();
      })();
    </script>
  </body>
</html>
