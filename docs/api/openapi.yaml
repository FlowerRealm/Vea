openapi: 3.0.3
info:
  title: Vea Backend API
  version: 2.1.0
  description: |
    Vea 是一个代理管理服务的 HTTP API，提供 FRouter、配置、Geo 资源、核心组件与代理运行配置（ProxyConfig）的统一管理。

    ## 特性
    - FRouter 管理：导入、测速、延迟测试、链路封装
    - 配置管理：导入 Xray JSON 或订阅链接，自动刷新
    - Geo 资源：GeoIP/GeoSite 管理
    - 核心组件：Xray/sing-box/Geo 核心下载与安装
    - 代理运行配置：ProxyConfig（入站模式、引擎选择、绑定 FRouter）
    - 系统设置：系统代理、前端设置
    - TUN 能力检查与配置：/tun/check、/tun/setup

    ## 版本兼容性
    - 本仓库不承诺向后兼容；API/状态 schema 可能发生破坏性变更
    - 如需稳定集成，请固定到具体版本/提交
  contact:
    name: Vea Project
    url: https://github.com/FlowerRealm/Vea
  license:
    name: MIT
    url: https://github.com/FlowerRealm/Vea/blob/main/LICENSE

servers:
  - url: http://localhost:19080
    description: 本地开发服务器
  - url: http://127.0.0.1:19080
    description: 本地环回地址

tags:
  - name: health
    description: 健康检查
  - name: snapshot
    description: 全量状态快照
  - name: nodes
    description: 节点列表与测量
  - name: frouters
    description: FRouter 管理（封装节点链路）
  - name: configs
    description: 配置管理
  - name: geo
    description: Geo 资源管理
  - name: components
    description: 核心组件管理
  - name: xray
    description: Xray 控制
  - name: proxy
    description: 代理运行控制
  - name: tun
    description: TUN 能力检查与配置
  - name: engine
    description: 引擎推荐与状态
  - name: ip
    description: IP 地理信息查询
  - name: settings
    description: 系统设置

paths:
  /health:
    get:
      tags: [health]
      summary: 健康检查
      description: 检查服务运行状态
      operationId: getHealth
      responses:
        '200':
          description: 服务正常运行
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: ok
                  timestamp:
                    type: string
                    format: date-time

  /snapshot:
    get:
      tags: [snapshot]
      summary: 获取全量状态快照
      description: 返回所有 FRouter、配置、Geo 资源、组件和代理运行配置（ProxyConfig）的完整状态
      operationId: getSnapshot
      responses:
        '200':
          description: 成功返回快照
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ServiceState'

  /nodes:
    get:
      tags: [nodes]
      summary: 列出所有节点
      description: 获取全局节点列表（节点独立于 FRouter；通常由配置/订阅同步生成）
      operationId: listNodes
      responses:
        '200':
          description: 成功返回节点列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  nodes:
                    type: array
                    items:
                      $ref: '#/components/schemas/Node'
    post:
      tags: [nodes]
      summary: 创建节点
      description: 手动创建全局节点（不归属订阅）
      operationId: createNode
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NodeUpsertRequest'
      responses:
        '201':
          description: 节点创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Node'
        '400':
          $ref: '#/components/responses/BadRequest'

  /nodes/from-link:
    post:
      tags: [nodes]
      summary: 从分享链接导入节点
      description: 解析分享链接（支持单条链接/多条链接/base64 订阅内容），并创建为手动节点
      operationId: importNodesFromLink
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NodeFromLinkRequest'
      responses:
        '201':
          description: 导入成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  nodes:
                    type: array
                    items:
                      $ref: '#/components/schemas/Node'
        '400':
          $ref: '#/components/responses/BadRequest'

  /nodes/{id}:
    put:
      tags: [nodes]
      summary: 更新节点
      description: 更新节点配置（订阅节点核心字段不可编辑；名称/标签请使用 /nodes/{id}/meta）
      operationId: updateNode
      parameters:
        - $ref: '#/components/parameters/NodeId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NodeUpsertRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Node'
        '404':
          $ref: '#/components/responses/NotFound'
        '400':
          $ref: '#/components/responses/BadRequest'

  /nodes/{id}/meta:
    put:
      tags: [nodes]
      summary: 更新节点名称/标签
      description: 更新节点的 name/tags（订阅节点仅允许修改这些字段）
      operationId: updateNodeMeta
      parameters:
        - $ref: '#/components/parameters/NodeId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/NodeMetaRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Node'
        '404':
          $ref: '#/components/responses/NotFound'
        '400':
          $ref: '#/components/responses/BadRequest'

  /nodes/{id}/ping:
    post:
      tags: [nodes]
      summary: 测试节点延迟
      description: 异步执行延迟测试，结果更新到节点的 lastLatencyMs 字段
      operationId: pingNode
      parameters:
        - $ref: '#/components/parameters/NodeId'
      responses:
        '202':
          description: 延迟测试任务已提交
        '404':
          $ref: '#/components/responses/NotFound'

  /nodes/{id}/speedtest:
    post:
      tags: [nodes]
      summary: 测试节点速度
      description: 异步执行速度测试，结果更新到节点的 lastSpeedMbps 字段
      operationId: speedtestNode
      parameters:
        - $ref: '#/components/parameters/NodeId'
      responses:
        '202':
          description: 速度测试任务已提交
        '404':
          $ref: '#/components/responses/NotFound'

  /nodes/bulk/ping:
    post:
      tags: [nodes]
      summary: 批量测试节点延迟
      description: 批量执行延迟测试，如果 ids 为空则测试所有节点
      operationId: bulkPingNodes
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ids:
                  type: array
                  items:
                    type: string
                  description: Node ID 列表，为空则测试所有节点
      responses:
        '202':
          description: 批量测试任务已提交
        '400':
          $ref: '#/components/responses/BadRequest'

  /nodes/bulk/speedtest:
    post:
      tags: [nodes]
      summary: 批量测试节点速度
      description: 批量执行速度测试，如果 ids 为空则测试所有节点
      operationId: bulkSpeedtestNodes
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ids:
                  type: array
                  items:
                    type: string
                  description: Node ID 列表，为空则测试所有节点
      responses:
        '202':
          description: 批量测试任务已提交
        '400':
          $ref: '#/components/responses/BadRequest'

  /frouters:
    get:
      tags: [frouters]
      summary: 列出所有 FRouter
      description: 获取 FRouter 列表
      operationId: listFRouters
      responses:
        '200':
          description: 成功返回 FRouter 列表
          content:
            application/json:
              schema:
                type: object
                properties:
                  frouters:
                    type: array
                    items:
                      $ref: '#/components/schemas/FRouter'

    post:
      tags: [frouters]
      summary: 创建 FRouter
      description: 创建 FRouter
      operationId: createFRouter
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FRouterCreateRequest'
      responses:
        '201':
          description: FRouter 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FRouter'
        '400':
          $ref: '#/components/responses/BadRequest'

  /frouters/{id}:
    put:
      tags: [frouters]
      summary: 更新 FRouter
      description: 更新 FRouter 信息
      operationId: updateFRouter
      parameters:
        - $ref: '#/components/parameters/FRouterId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FRouterUpdateRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FRouter'
        '404':
          $ref: '#/components/responses/NotFound'
        '400':
          $ref: '#/components/responses/BadRequest'

    delete:
      tags: [frouters]
      summary: 删除 FRouter
      description: 删除指定 FRouter
      operationId: deleteFRouter
      parameters:
        - $ref: '#/components/parameters/FRouterId'
      responses:
        '204':
          description: 删除成功
        '404':
          $ref: '#/components/responses/NotFound'

  /frouters/{id}/ping:
    post:
      tags: [frouters]
      summary: 测试 FRouter 延迟
      description: 异步执行延迟测试，结果更新到 FRouter 的 lastLatencyMs 字段
      operationId: pingFRouter
      parameters:
        - $ref: '#/components/parameters/FRouterId'
      responses:
        '202':
          description: 延迟测试任务已提交
        '404':
          $ref: '#/components/responses/NotFound'

  /frouters/{id}/speedtest:
    post:
      tags: [frouters]
      summary: 测试 FRouter 速度
      description: 异步执行速度测试，结果更新到 FRouter 的 lastSpeedMbps 字段
      operationId: speedtestFRouter
      parameters:
        - $ref: '#/components/parameters/FRouterId'
      responses:
        '202':
          description: 速度测试任务已提交
        '404':
          $ref: '#/components/responses/NotFound'

  /frouters/bulk/ping:
    post:
      tags: [frouters]
      summary: 批量测试延迟
      description: 批量执行延迟测试，如果 ids 为空则测试所有 FRouter
      operationId: bulkPingFRouters
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                ids:
                  type: array
                  items:
                    type: string
                  description: FRouter ID 列表，为空则测试所有 FRouter
      responses:
        '202':
          description: 批量测试任务已提交
        '400':
          $ref: '#/components/responses/BadRequest'

  /frouters/reset-speed:
    post:
      tags: [frouters]
      summary: 重置 FRouter 速度
      description: 重置指定 FRouter 的速度测试结果
      operationId: resetFRouterSpeed
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                ids:
                  type: array
                  items:
                    type: string
                  description: FRouter ID 列表
      responses:
        '204':
          description: 重置成功
        '400':
          $ref: '#/components/responses/BadRequest'

  /configs:
    get:
      tags: [configs]
      summary: 列出所有配置
      description: 获取配置列表
      operationId: listConfigs
      responses:
        '200':
          description: 成功返回配置列表
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Config'

  /configs/import:
    post:
      tags: [configs]
      summary: 导入配置
      description: 导入新的 Xray 配置或订阅链接
      operationId: importConfig
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfigImportRequest'
      responses:
        '201':
          description: 配置导入成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Config'
        '400':
          $ref: '#/components/responses/BadRequest'

  /configs/{id}:
    put:
      tags: [configs]
      summary: 更新配置
      description: 更新配置信息
      operationId: updateConfig
      parameters:
        - $ref: '#/components/parameters/ConfigId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ConfigUpdateRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Config'
        '404':
          $ref: '#/components/responses/NotFound'
        '400':
          $ref: '#/components/responses/BadRequest'

    delete:
      tags: [configs]
      summary: 删除配置
      description: 删除指定配置
      operationId: deleteConfig
      parameters:
        - $ref: '#/components/parameters/ConfigId'
      responses:
        '204':
          description: 删除成功
        '404':
          $ref: '#/components/responses/NotFound'

  /configs/{id}/refresh:
    post:
      tags: [configs]
      summary: 刷新配置
      description: 从 sourceUrl 重新拉取配置内容
      operationId: refreshConfig
      parameters:
        - $ref: '#/components/parameters/ConfigId'
      responses:
        '200':
          description: 刷新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Config'
        '404':
          $ref: '#/components/responses/NotFound'

  /configs/{id}/pull-nodes:
    post:
      tags: [configs]
      summary: 同步配置节点
      description: 从配置/订阅中提取节点并写入全局节点集合（按 sourceConfigId 归属）
      operationId: pullConfigNodes
      parameters:
        - $ref: '#/components/parameters/ConfigId'
      responses:
        '200':
          description: 节点同步成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  nodes:
                    type: array
                    items:
                      $ref: '#/components/schemas/Node'
        '404':
          $ref: '#/components/responses/NotFound'

  /geo:
    get:
      tags: [geo]
      summary: 列出所有 Geo 资源
      description: 获取 GeoIP 和 GeoSite 资源列表
      operationId: listGeo
      responses:
        '200':
          description: 成功返回 Geo 资源列表
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/GeoResource'

    post:
      tags: [geo]
      summary: 创建 Geo 资源
      description: 创建新的 Geo 资源
      operationId: createGeo
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GeoResourceRequest'
      responses:
        '201':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeoResource'
        '400':
          $ref: '#/components/responses/BadRequest'

  /geo/{id}:
    put:
      tags: [geo]
      summary: 更新 Geo 资源
      description: 更新 Geo 资源信息（也可以作为 upsert）
      operationId: updateGeo
      parameters:
        - $ref: '#/components/parameters/GeoId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/GeoResourceRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeoResource'
        '400':
          $ref: '#/components/responses/BadRequest'

    delete:
      tags: [geo]
      summary: 删除 Geo 资源
      description: 删除指定 Geo 资源
      operationId: deleteGeo
      parameters:
        - $ref: '#/components/parameters/GeoId'
      responses:
        '204':
          description: 删除成功
        '404':
          $ref: '#/components/responses/NotFound'

  /geo/{id}/refresh:
    post:
      tags: [geo]
      summary: 刷新 Geo 资源
      description: 从 sourceUrl 重新下载 Geo 资源文件
      operationId: refreshGeo
      parameters:
        - $ref: '#/components/parameters/GeoId'
      responses:
        '200':
          description: 刷新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GeoResource'
        '404':
          $ref: '#/components/responses/NotFound'

  /components:
    get:
      tags: [components]
      summary: 列出所有核心组件
      description: 获取核心组件列表（如 Xray）
      operationId: listComponents
      responses:
        '200':
          description: 成功返回组件列表
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/CoreComponent'

    post:
      tags: [components]
      summary: 创建核心组件
      description: 创建新的核心组件记录
      operationId: createComponent
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ComponentRequest'
      responses:
        '201':
          description: 创建成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CoreComponent'
        '400':
          $ref: '#/components/responses/BadRequest'

  /components/{id}:
    put:
      tags: [components]
      summary: 更新核心组件
      description: 更新核心组件信息
      operationId: updateComponent
      parameters:
        - $ref: '#/components/parameters/ComponentId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ComponentRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CoreComponent'
        '404':
          $ref: '#/components/responses/NotFound'
        '400':
          $ref: '#/components/responses/BadRequest'

    delete:
      tags: [components]
      summary: 删除核心组件
      description: 删除指定核心组件
      operationId: deleteComponent
      parameters:
        - $ref: '#/components/parameters/ComponentId'
      responses:
        '204':
          description: 删除成功
        '404':
          $ref: '#/components/responses/NotFound'

  /components/{id}/install:
    post:
      tags: [components]
      summary: 安装核心组件
      description: 下载并安装指定核心组件
      operationId: installComponent
      parameters:
        - $ref: '#/components/parameters/ComponentId'
      responses:
        '200':
          description: 安装成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/CoreComponent'
        '404':
          $ref: '#/components/responses/NotFound'

  /proxy/config:
    get:
      tags: [proxy]
      summary: 获取代理运行配置
      description: 获取当前代理运行配置（单例）
      operationId: getProxyConfig
      responses:
        '200':
          description: 成功返回代理运行配置
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProxyConfig'

    put:
      tags: [proxy]
      summary: 更新代理运行配置
      description: 更新代理运行配置（单例）
      operationId: updateProxyConfig
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProxyConfig'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ProxyConfig'
        '400':
          $ref: '#/components/responses/BadRequest'

  /proxy/start:
    post:
      tags: [proxy]
      summary: 启动代理（以 FRouter 为中心）
      description: 使用当前配置启动代理；请求体可覆盖部分字段（常见只传 frouterId）
      operationId: startProxy
      requestBody:
        required: false
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ProxyConfig'
      responses:
        '200':
          description: 启动成功
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '400':
          $ref: '#/components/responses/BadRequest'

  /proxy/status:
    get:
      tags: [proxy]
      summary: 获取代理状态
      description: 获取当前代理运行状态（含 engine/inboundMode/frouterId 等）
      operationId: getProxyStatus
      responses:
        '200':
          description: 成功返回代理状态
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

  /proxy/kernel/logs:
    get:
      tags: [proxy]
      summary: 获取内核日志
      description: 按字节偏移读取内核日志片段
      operationId: getKernelLogs
      parameters:
        - name: since
          in: query
          description: 从该字节偏移开始读取（默认为 0）
          required: false
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: 成功返回日志片段
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/KernelLogSnapshot'

  /proxy/stop:
    post:
      tags: [proxy]
      summary: 停止代理
      description: 停止当前运行的代理
      operationId: stopProxy
      responses:
        '200':
          description: 已停止
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

  /tun/check:
    get:
      tags: [tun]
      summary: 检查 TUN 能力
      description: 检查当前系统是否具备 TUN 条件（需要权限、驱动、可用接口等）
      operationId: checkTUNCapabilities
      responses:
        '200':
          description: 成功返回检查结果
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

  /tun/setup:
    post:
      tags: [tun]
      summary: 配置 TUN
      description: 执行一次性 TUN 配置（不同平台实现不同）
      operationId: setupTUN
      requestBody:
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        '200':
          description: 配置成功
        '400':
          $ref: '#/components/responses/BadRequest'

  /engine/recommend:
    get:
      tags: [engine]
      summary: 推荐引擎
      description: 根据当前 ProxyConfig/FRouter 约束推荐 Xray 或 sing-box
      operationId: getEngineRecommendation
      responses:
        '200':
          description: 成功返回推荐结果
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

  /engine/status:
    get:
      tags: [engine]
      summary: 引擎状态
      description: 返回已安装引擎与能力信息
      operationId: getEngineStatus
      responses:
        '200':
          description: 成功返回引擎状态
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

  /ip/geo:
    get:
      tags: [ip]
      summary: IP Geo 查询
      description: 返回当前出口 IP 及地理信息
      operationId: getIPGeo
      responses:
        '200':
          description: 成功返回查询结果
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

  /settings/system-proxy:
    get:
      tags: [settings]
      summary: 获取系统代理设置
      description: 获取系统代理配置和忽略主机列表
      operationId: getSystemProxySettings
      responses:
        '200':
          description: 成功返回系统代理设置
          content:
            application/json:
              schema:
                type: object
                properties:
                  settings:
                    $ref: '#/components/schemas/SystemProxySettings'
                  message:
                    type: string
                    description: 附加消息（如不支持系统代理的警告）

    put:
      tags: [settings]
      summary: 更新系统代理设置
      description: 更新系统代理配置
      operationId: updateSystemProxySettings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SystemProxyRequest'
      responses:
        '200':
          description: 更新成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  settings:
                    $ref: '#/components/schemas/SystemProxySettings'
                  message:
                    type: string
        '400':
          $ref: '#/components/responses/BadRequest'

  /settings/frontend:
    get:
      tags: [settings]
      summary: 获取前端设置
      description: 获取前端存储的设置（主题等）
      operationId: getFrontendSettings
      responses:
        '200':
          description: 成功返回前端设置
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true

    put:
      tags: [settings]
      summary: 保存前端设置
      description: 保存前端设置（key-value）
      operationId: saveFrontendSettings
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              additionalProperties: true
      responses:
        '200':
          description: 保存成功
          content:
            application/json:
              schema:
                type: object
                additionalProperties: true
        '400':
          $ref: '#/components/responses/BadRequest'

  /frouters/{id}/graph:
    get:
      tags: [frouters]
      summary: 获取 FRouter 图
      description: 获取指定 FRouter 的链式代理图（边/位置/插槽）
      operationId: getFRouterGraph
      parameters:
        - $ref: '#/components/parameters/FRouterId'
      responses:
        '200':
          description: 成功返回图结构
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FRouterGraphResponse'
        '404':
          $ref: '#/components/responses/NotFound'

    put:
      tags: [frouters]
      summary: 保存 FRouter 图
      description: 保存链式代理图（保存前会进行 CompileFRouter 校验并归一化兜底 priority=0）；如果代理正在运行，会异步调度一次重启以应用新图配置
      operationId: saveFRouterGraph
      parameters:
        - $ref: '#/components/parameters/FRouterId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FRouterGraphRequest'
      responses:
        '200':
          description: 保存成功
          headers:
            X-Vea-Effects:
              description: 可选。存在时表示该请求触发了副作用（当前唯一值：proxy_restart_scheduled）
              schema:
                type: string
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/FRouter'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'

  /frouters/{id}/graph/validate:
    post:
      tags: [frouters]
      summary: 校验 FRouter 图
      description: 仅校验，不保存；返回 errors/warnings
      operationId: validateFRouterGraph
      parameters:
        - $ref: '#/components/parameters/FRouterId'
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/FRouterGraphRequest'
      responses:
        '200':
          description: 校验结果
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidateGraphResponse'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  parameters:
    FRouterId:
      name: id
      in: path
      required: true
      description: FRouter ID
      schema:
        type: string

    NodeId:
      name: id
      in: path
      required: true
      description: 节点 ID
      schema:
        type: string

    ConfigId:
      name: id
      in: path
      required: true
      description: 配置 ID
      schema:
        type: string

    GeoId:
      name: id
      in: path
      required: true
      description: Geo 资源 ID
      schema:
        type: string

    ComponentId:
      name: id
      in: path
      required: true
      description: 核心组件 ID
      schema:
        type: string

  schemas:
    Node:
      type: object
      description: 代理节点定义（独立于 FRouter；通常由配置/订阅同步生成）
      required: [id, name, address, port, protocol]
      properties:
        id:
          type: string
          description: 节点唯一标识
        name:
          type: string
          description: 节点名称
        address:
          type: string
          description: 服务器地址
        port:
          type: integer
          minimum: 1
          maximum: 65535
          description: 服务器端口
        protocol:
          type: string
          enum: [vless, trojan, shadowsocks, vmess, hysteria2, tuic]
          description: 协议类型
        tags:
          type: array
          items:
            type: string
          description: 节点标签
        security:
          $ref: '#/components/schemas/NodeSecurity'
        transport:
          $ref: '#/components/schemas/NodeTransport'
        tls:
          $ref: '#/components/schemas/NodeTLS'
        sourceConfigId:
          type: string
          description: 来源配置 ID
        lastLatencyMs:
          type: integer
          format: int64
          description: 最后一次延迟测试结果（毫秒）
        lastLatencyAt:
          type: string
          format: date-time
          description: 最后一次延迟测试时间
        lastLatencyError:
          type: string
          description: 延迟测试错误信息
        lastSpeedMbps:
          type: number
          format: double
          description: 最后一次速度测试结果（Mbps）
        lastSpeedAt:
          type: string
          format: date-time
          description: 最后一次速度测试时间
        lastSpeedError:
          type: string
          description: 速度测试错误信息
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    NodeUpsertRequest:
      type: object
      description: 手动创建/更新节点请求体
      required: [name, address, port, protocol]
      properties:
        name:
          type: string
          description: 节点名称
        address:
          type: string
          description: 服务器地址
        port:
          type: integer
          minimum: 1
          maximum: 65535
          description: 服务器端口
        protocol:
          type: string
          enum: [vless, trojan, shadowsocks, vmess, hysteria2, tuic]
          description: 协议类型
        tags:
          type: array
          items:
            type: string
          description: 节点标签
        security:
          $ref: '#/components/schemas/NodeSecurity'
        transport:
          $ref: '#/components/schemas/NodeTransport'
        tls:
          $ref: '#/components/schemas/NodeTLS'

    NodeFromLinkRequest:
      type: object
      description: 从分享链接导入节点请求体
      required: [shareLink]
      properties:
        shareLink:
          type: string
          description: 分享链接文本（可为单条链接、多行链接或 base64 订阅内容）
        tags:
          type: array
          items:
            type: string
          description: （可选）为导入的节点统一设置的标签

    NodeMetaRequest:
      type: object
      description: 更新节点名称/标签请求体（至少提供 name 或 tags 之一）
      properties:
        name:
          type: string
          description: 节点名称
        tags:
          type: array
          items:
            type: string
          description: 节点标签

    NodeSecurity:
      type: object
      properties:
        uuid:
          type: string
        password:
          type: string
        method:
          type: string
        flow:
          type: string
        encryption:
          type: string
        alterId:
          type: integer
        plugin:
          type: string
        pluginOpts:
          type: string
        alpn:
          type: array
          items:
            type: string

    NodeTransport:
      type: object
      properties:
        type:
          type: string
        host:
          type: string
        path:
          type: string
        serviceName:
          type: string
        headers:
          type: object
          additionalProperties:
            type: string

    NodeTLS:
      type: object
      properties:
        enabled:
          type: boolean
        type:
          type: string
        serverName:
          type: string
        insecure:
          type: boolean
        fingerprint:
          type: string
        realityPublicKey:
          type: string
        realityShortId:
          type: string
        alpn:
          type: array
          items:
            type: string

    FRouter:
      type: object
      description: FRouter 定义；对外一等操作单元（通过 ChainProxy 图引用 NodeID）
      required: [id, name, chainProxy]
      properties:
        id:
          type: string
        name:
          type: string
        chainProxy:
          $ref: '#/components/schemas/ChainProxySettings'
        tags:
          type: array
          items:
            type: string
        sourceConfigId:
          type: string
        lastLatencyMs:
          type: integer
          format: int64
        lastLatencyAt:
          type: string
          format: date-time
        lastLatencyError:
          type: string
        lastSpeedMbps:
          type: number
          format: double
        lastSpeedAt:
          type: string
          format: date-time
        lastSpeedError:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    FRouterCreateRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        chainProxy:
          $ref: '#/components/schemas/ChainProxySettings'
        tags:
          type: array
          items:
            type: string

    FRouterUpdateRequest:
      type: object
      required: [name]
      properties:
        name:
          type: string
        chainProxy:
          $ref: '#/components/schemas/ChainProxySettings'
        tags:
          type: array
          items:
            type: string

    ChainProxySettings:
      type: object
      properties:
        edges:
          type: array
          items:
            $ref: '#/components/schemas/ProxyEdge'
        positions:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/GraphPosition'
        slots:
          type: array
          items:
            $ref: '#/components/schemas/SlotNode'
        updatedAt:
          type: string
          format: date-time

    FRouterGraphRequest:
      type: object
      properties:
        edges:
          type: array
          items:
            $ref: '#/components/schemas/ProxyEdge'
        positions:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/GraphPosition'
        slots:
          type: array
          items:
            $ref: '#/components/schemas/SlotNode'

    FRouterGraphResponse:
      type: object
      properties:
        edges:
          type: array
          items:
            $ref: '#/components/schemas/ProxyEdge'
        positions:
          type: object
          additionalProperties:
            $ref: '#/components/schemas/GraphPosition'
        slots:
          type: array
          items:
            $ref: '#/components/schemas/SlotNode'
        updatedAt:
          type: string
          format: date-time

    ValidateGraphResponse:
      type: object
      required: [valid, errors, warnings]
      properties:
        valid:
          type: boolean
        errors:
          type: array
          items:
            type: string
        warnings:
          type: array
          items:
            type: string

    ProxyEdge:
      type: object
      properties:
        id:
          type: string
        from:
          type: string
        to:
          type: string
        via:
          type: array
          items:
            type: string
        tag:
          type: string
        priority:
          type: integer
        enabled:
          type: boolean
        ruleType:
          type: string
        routeRule:
          $ref: '#/components/schemas/RouteMatchRule'
        description:
          type: string

    RouteMatchRule:
      type: object
      properties:
        domains:
          type: array
          items:
            type: string
        ips:
          type: array
          items:
            type: string

    GraphPosition:
      type: object
      properties:
        x:
          type: number
        y:
          type: number

    SlotNode:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        boundNodeId:
          type: string

    Config:
      type: object
      required: [id, name, format]
      properties:
        id:
          type: string
        name:
          type: string
        format:
          type: string
          enum: [xray-json]
        payload:
          type: string
          description: 配置内容（JSON 字符串）
        sourceUrl:
          type: string
          description: 配置源地址或订阅链接
        checksum:
          type: string
        lastSyncError:
          type: string
        autoUpdateInterval:
          type: integer
          format: int64
          description: 自动更新间隔（纳秒）
        lastSyncedAt:
          type: string
          format: date-time
        expireAt:
          type: string
          format: date-time
          nullable: true
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ConfigImportRequest:
      type: object
      required: [name, format, sourceUrl]
      properties:
        name:
          type: string
        format:
          type: string
          enum: [xray-json]
        sourceUrl:
          type: string
          description: 配置源地址或订阅链接
        payload:
          type: string
          description: 可选，直接提供配置内容
        autoUpdateIntervalMinutes:
          type: integer
          format: int64
          description: 自动更新间隔（分钟）
        expireAt:
          type: string
          format: date-time
          nullable: true

    ConfigUpdateRequest:
      type: object
      required: [name, format, sourceUrl]
      properties:
        name:
          type: string
        format:
          type: string
          enum: [xray-json]
        sourceUrl:
          type: string
        payload:
          type: string
        autoUpdateIntervalMinutes:
          type: integer
          format: int64
        expireAt:
          type: string
          format: date-time
          nullable: true

    GeoResource:
      type: object
      required: [id, name, type, sourceUrl]
      properties:
        id:
          type: string
        name:
          type: string
        type:
          type: string
          enum: [geoip, geosite]
        sourceUrl:
          type: string
        checksum:
          type: string
        version:
          type: string
        artifactPath:
          type: string
          description: 本地文件路径
        fileSizeBytes:
          type: integer
          format: int64
        lastSyncError:
          type: string
        lastSynced:
          type: string
          format: date-time
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    GeoResourceRequest:
      type: object
      required: [name, type, sourceUrl]
      properties:
        name:
          type: string
        type:
          type: string
          enum: [geoip, geosite]
        sourceUrl:
          type: string
        checksum:
          type: string
        version:
          type: string

    CoreComponent:
      type: object
      required: [id, name, kind]
      properties:
        id:
          type: string
        name:
          type: string
        kind:
          type: string
          enum: [xray, singbox, geo, generic]
        sourceUrl:
          type: string
        archiveType:
          type: string
        lastInstalledAt:
          type: string
          format: date-time
        installDir:
          type: string
        lastVersion:
          type: string
        checksum:
          type: string
        lastSyncError:
          type: string
        meta:
          type: object
          additionalProperties:
            type: string
        accessories:
          type: array
          items:
            type: string
          description: 配套组件（如 sing-box 的 v2ray-plugin）
        installStatus:
          type: string
          description: 安装状态
        installProgress:
          type: integer
          description: 安装进度（0-100）
        installMessage:
          type: string
          description: 安装提示信息
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    ComponentRequest:
      type: object
      properties:
        name:
          type: string
        kind:
          type: string
          enum: [xray, singbox, geo, generic]
        sourceUrl:
          type: string
        archiveType:
          type: string

    CoreEngineInfo:
      type: object
      properties:
        kind:
          type: string
          enum: [xray, singbox, auto]
        binaryPath:
          type: string
        version:
          type: string
        capabilities:
          type: array
          items:
            type: string
        installed:
          type: boolean

    ProxyConfig:
      type: object
      description: 代理运行配置（单例）
      properties:
        inboundMode:
          type: string
          enum: [socks, http, mixed, tun]
        inboundPort:
          type: integer
        inboundConfig:
          type: object
          additionalProperties: true
        tunSettings:
          type: object
          additionalProperties: true
        resolvedService:
          type: object
          additionalProperties: true
        dnsConfig:
          type: object
          additionalProperties: true
        logConfig:
          type: object
          additionalProperties: true
        performanceConfig:
          type: object
          additionalProperties: true
        xrayConfig:
          type: object
          additionalProperties: true
        preferredEngine:
          type: string
          enum: [xray, singbox, auto]
        frouterId:
          type: string
        updatedAt:
          type: string
          format: date-time

    KernelLogSnapshot:
      type: object
      description: 内核日志片段
      properties:
        session:
          type: integer
          format: int64
        engine:
          type: string
        running:
          type: boolean
        pid:
          type: integer
        startedAt:
          type: string
          format: date-time
        path:
          type: string
        from:
          type: integer
          format: int64
        to:
          type: integer
          format: int64
        end:
          type: integer
          format: int64
        lost:
          type: boolean
        text:
          type: string
        error:
          type: string

    SystemProxySettings:
      type: object
      properties:
        enabled:
          type: boolean
          description: 系统代理是否启用
        ignoreHosts:
          type: array
          items:
            type: string
          description: 忽略代理的主机列表
        updatedAt:
          type: string
          format: date-time

    SystemProxyRequest:
      type: object
      properties:
        enabled:
          type: boolean
        ignoreHosts:
          type: array
          items:
            type: string

    ServiceState:
      type: object
      description: 服务的完整状态快照
      properties:
        schemaVersion:
          type: string
        nodes:
          type: array
          items:
            $ref: '#/components/schemas/Node'
        frouters:
          type: array
          items:
            $ref: '#/components/schemas/FRouter'
        configs:
          type: array
          items:
            $ref: '#/components/schemas/Config'
        geoResources:
          type: array
          items:
            $ref: '#/components/schemas/GeoResource'
        components:
          type: array
          items:
            $ref: '#/components/schemas/CoreComponent'
        systemProxy:
          $ref: '#/components/schemas/SystemProxySettings'
        proxyConfig:
          $ref: '#/components/schemas/ProxyConfig'
        frontendSettings:
          type: object
          additionalProperties: true
        generatedAt:
          type: string
          format: date-time

    Error:
      type: object
      properties:
        error:
          type: string
          description: 错误信息

  responses:
    BadRequest:
      description: 请求参数错误
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: 资源不存在
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
