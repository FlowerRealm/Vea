# 变更提案: FRouter 静态走向流程图

## 需求背景
当前 FRouter 的“路由规则/链路”主要以列表编辑为主：可编辑规则，但很难一眼看清“流量会走到哪里、会经过哪些 hop、默认出口是什么”。当规则较多或存在链式代理（via / detour / slot）时，理解成本明显上升，配置错误也更难排查。

本变更为 FRouter 增加“静态配置走向”的可视化视图：以流程图方式展示 `local → 规则 → 去向 → 链路`，帮助用户快速理解流量走向。

## 产品分析

### 目标用户与场景
- **用户群体:** 使用 Vea 管理多规则、多出口或链式代理的用户
- **使用场景:** 配置审计（看默认出口/兜底规则）、排障（确认规则去向）、学习与分享（向他人解释配置）
- **核心痛点:** 列表难以表达整体拓扑；规则与链路的关系不直观；slot 绑定后真实去向难以快速确认

### 价值主张与成功指标
- **价值主张:** 用可视化的“走向图”降低理解成本，让用户更快判断配置是否符合预期
- **成功指标:** 用户无需进入编辑弹窗即可看清默认路径与主要规则去向；缩放/拖拽浏览顺畅；hover 可查看规则摘要与关键匹配项

### 人文关怀
- 走向图默认仅展示节点 **名称/ID** 与规则匹配摘要，不主动展示节点地址等敏感信息，避免截图分享时泄露隐私。

## 变更内容
1. 在「FRouter 面板」中，将选中的 FRouter 展开为“详情卡片”，增加“走向图”区域（静态视图）。
2. 走向图展示规则与链路：
   - `local` 入口 → 各规则（含默认/路由规则/优先级）
   - 规则 → 去向（direct / block / 节点）
   - 链式代理：按 detour/via 计算后的 hop 链路
3. slot 展示规则：
   - slot 已绑定：走向图直接展示绑定后的节点
   - slot 未绑定：在图中标记为“未绑定/穿透（编译会跳过）”
4. 交互：支持拖拽平移 + 滚轮缩放浏览（只读）。

## 影响范围
- **模块:** `frontend/theme/_shared`、`frontend/theme/dark`、`frontend/theme/light`
- **文件:** `frontend/theme/_shared/js/app.js`、`frontend/theme/_shared/vendor/*`、`frontend/theme/*/index.html`、`frontend/theme/*/css/main.css`
- **API:** 无新增（复用 `GET /frouters/:id/graph` 与 `GET /nodes`）
- **数据:** 无新增

## 核心场景

### 需求: FRouter 静态走向可视化
**模块:** frontend/theme
在 FRouter 详情卡片中展示静态走向图，帮助用户理解流量从入口到去向、以及链路 hop 的关系。

#### 场景: 查看默认去向与 detour 链路
前置条件：选中某个 FRouter，存在默认规则（local → {node|direct|block} 的默认边）。
- 预期结果：走向图中能明确看到默认规则的去向，以及后续 detour/via 形成的 hop 链路。

#### 场景: 查看路由规则匹配条件
前置条件：存在 `ruleType=route` 的规则。
- 预期结果：走向图中规则节点能展示 priority/类型/摘要（domains/ips），hover 可查看完整匹配项（截断不丢信息）。

#### 场景: slot 绑定后真实去向清晰可见
前置条件：规则去向引用 slot，且 slot 已绑定到真实节点。
- 预期结果：走向图直接展示绑定节点（不单独暴露 slot），避免误解“实际走向”。

#### 场景: 交互浏览（缩放/拖拽）
前置条件：规则较多或图较大。
- 预期结果：用户可拖拽平移、滚轮缩放浏览，交互不卡顿；不影响选择/操作其他 UI。

## 风险评估
- **风险:** 规则很多时流程图会变密、影响性能/可读性  
  **缓解:** 默认展示摘要 + tooltip 展示全文；必要时引入渲染上限或折叠策略（可配置）。
- **风险:** 引入第三方图布局库（体积/许可证/维护）  
  **缓解:** 选择体积更小且许可证清晰的库（如 dagre），并在仓库内保留许可证文件；记录版本与来源。
- **风险:** 调整 FRouter 卡片 DOM 结构可能影响现有点击/双击/右键交互  
  **缓解:** 交互事件严格区分（stopPropagation/只读区域），并保持现有行为不变。

