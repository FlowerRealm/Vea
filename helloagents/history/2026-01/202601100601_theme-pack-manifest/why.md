# 变更提案: 主题包支持 manifest（单包多子主题、隔离无冲突）

## 需求背景
当前主题系统以“单主题目录”为基本单位（入口固定 `index.html`），支持 ZIP 导入/导出与主题切换。

但在实际分发中，经常存在“同一套设计语言的多套变体”（例如同一主题包内的深色/浅色/高对比度/紧凑布局等）。如果仍按“一个主题=一个目录”分发，会导致：
- 分发碎片化：一个主题需要拆成多个 zip，管理成本高
- 信息割裂：主题介绍、作者信息、版本信息等无法集中表达
- 命名冲突：多个变体在用户机器上容易与其他主题同名冲突（即使人为加前缀也不优雅）

本次变更目标：引入“**大主题包（Theme Pack）**”概念——一个包内包含多个**隔离的小主题**，并使用 `manifest.json` 统一描述主题包信息与子主题入口。

## 产品分析

### 目标用户与场景
- **主题作者/设计师**：希望一次发布一个主题包，包内包含多个变体，并提供完整介绍信息
- **高级用户**：希望安装后在应用内自由切换包内不同子主题
- **普通用户**：希望导入后“能用、可切换、不会冲突”，且导出/分享更简单

### 价值主张与成功指标
- **价值主张**：一个 ZIP 即可分发一组主题；子主题隔离不冲突；主题信息集中可读
- **成功指标**
  - 导入一个包含 `manifest.json` 的主题包后，设置页可看到并切换到包内子主题
  - 重启应用后仍能加载上次选择的子主题
  - 导出“当前主题”（若来自主题包）导出为整个主题包 zip

### 人文关怀
- 主题包包含可执行前端代码（HTML/JS），导入来源必须可信；UI 需提示“仅导入你信任的主题包”
- 在导入失败时提供明确错误信息（manifest 缺失/字段不合法/入口不存在），避免用户无从排查

## 变更内容
1. 主题目录新增“主题包”形态：`<themes>/<packId>/manifest.json` + 多个子主题目录（隔离）
2. `GET /themes` 支持从主题包 `manifest.json` 展开子主题列表，并返回子主题入口相对路径
3. `POST /themes/import` 支持导入主题包 ZIP（仍要求 zip 单顶层目录），校验 manifest 与子主题入口文件存在
4. 前端主题选择/切换逻辑改为基于后端返回的 `entry` 路径跳转，避免目录深度导致的相对路径错误
5. 导出当前主题：若当前主题来自主题包，则导出整个主题包（pack）

## 影响范围
- **模块:** `backend/service/theme`、`backend/api`、`frontend/main.js`、`frontend/theme/*`
- **文件:** 主题服务与测试、OpenAPI、Electron 启动入口解析、主题页设置中的主题管理
- **API:** `GET /themes` 响应字段扩展；`POST /themes/import` 兼容主题包校验；导出逻辑在前端侧变更（后端导出仍导出顶层目录）
- **数据:** `userData/themes` 下允许出现包含 `manifest.json` 的主题包目录

## 核心场景

### 需求: 导入主题包 ZIP
**模块:** backend/theme + 前端主题页
导入一个包含 `manifest.json` 的 zip，安装到 `<userData>/themes/<packId>/`。

#### 场景: 导入成功并可见
- 导入后 `GET /themes` 返回包内子主题列表（可切换）
- UI 显示导入成功，并能在下拉框中选中/切换到包内默认子主题

### 需求: 切换到包内子主题
**模块:** 前端主题页

#### 场景: 从设置页切换子主题
- 保存 `theme` 设置为“虚拟主题ID”（包含 packId + 子主题ID）
- 页面按后端返回的 `entry` 路径加载对应 `index.html`

### 需求: 启动时加载已保存子主题
**模块:** Electron 主进程

#### 场景: 重启后仍加载正确入口
- Electron 根据 `/settings/frontend` 中的 `theme` 值，从 `GET /themes` 找到对应 `entry`，加载正确的 `index.html`

## 风险评估
- **风险:** `manifest.json` 的相对路径字段被恶意构造用于路径穿越（`../`）或指向包外文件
- **缓解:** 严格校验 manifest 中的入口路径为“安全相对路径”；与 zip 解压的安全策略叠加；必要时要求入口文件名为 `index.html`

