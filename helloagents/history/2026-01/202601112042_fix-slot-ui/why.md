# 变更提案: 修复槽位功能不可用（Issue #40）

## 需求背景

Issue #40（Windows 10 x64，Vea v2.3.0，sing-box）反馈：FRouter 路由规则界面能够看到“槽位（slot-*）”相关展示/选项，但 UI 缺少槽位本身的管理入口，导致无法新增/重命名/绑定节点，使槽位功能实际不可用。

槽位语义应当类似 Clash 的 selector：作为占位符被规则引用，并可在多个节点间切换（通过绑定到具体节点实现）。

## 变更内容

1. 在主题页 `路由规则` 面板新增“槽位管理”入口与弹窗（最小新增 UI，不引入新依赖）。
2. 槽位管理支持：
   - 新增槽位（生成新的 `slot-*` id）
   - 重命名槽位（编辑 `name`）
   - 绑定/解绑节点（编辑 `boundNodeId`）
3. 规则编辑弹窗中槽位选项展示绑定状态；槽位变更后可即时刷新相关下拉选项与列表显示。
4. 保存图配置时确保提交 `slots` 字段，避免槽位配置无法持久化（或被意外清空）。

## 影响范围

- **模块:** `frontend/theme`（light/dark 两套主题）
- **文件（预估）:**
  - `frontend/theme/light/index.html`
  - `frontend/theme/light/js/main.js`
  - `frontend/theme/dark/index.html`
  - `frontend/theme/dark/js/main.js`
- **API:** 无新增/变更；复用既有 `/frouters/:id/graph` 与校验接口
- **数据:** 复用 `ChainProxySettings.slots`（`id`/`name`/`boundNodeId`）

## 核心场景

### 需求: 槽位可管理
**模块:** frontend/theme

#### 场景: 新增槽位
在“路由规则”面板点击“槽位管理”，新增一个槽位。
- 预期结果：新增的 `slot-*` 出现在槽位列表中，并可用于规则去向选择。

#### 场景: 重命名槽位
在“槽位管理”中修改槽位名称。
- 预期结果：规则列表与规则编辑弹窗中，槽位显示名称同步更新。

#### 场景: 绑定或解绑槽位
在“槽位管理”中将槽位绑定到一个具体节点，或设置为“未绑定”。
- 预期结果：槽位选项显示“已绑定/未绑定”状态；保存后后端校验通过并持久化。

### 需求: 规则可选择槽位
**模块:** frontend/theme

#### 场景: 编辑规则选择槽位并显示状态
在规则编辑弹窗中将“匹配后去向”选择为某个槽位。
- 预期结果：下拉选项中展示槽位名称与绑定状态；选择槽位后保存规则不报错。

### 需求: 保存后生效
**模块:** frontend/theme + backend

#### 场景: 保存图配置并应用到代理
新增/修改槽位与规则后点击“保存”。
- 预期结果：后端接受图更新；如变更影响代理运行态，按既有机制触发重启/重载（由后端决定）。

## 风险评估

- **风险:** UI 允许提交无效 `slots`（重复 id、id 非 `slot-` 前缀、绑定到不存在的节点）导致后端 400。
  - **缓解:** 前端提交前做基础校验；对“不存在的绑定节点”在 UI 中显式标注并允许一键解绑。
- **风险:** 用户误操作造成规则引用与槽位配置不一致。
  - **缓解:** 不开放编辑 slot id；仅允许新增、重命名、绑定/解绑。若未来支持删除，需要做“被引用保护/二次确认”。
