# 变更提案: 重构订阅节点 ID 体系并修复 open issues（#41/#55/#57）

## 需求背景

当前 GitHub open issues 反馈了三个直接影响可用性的问题：

1. **Issue #55（订阅拉取节点）**：用户点击“拉取节点”后，FRouter 中引用的节点可能变为“未知”，导致规则链路断裂（与历史 Issue #18/#51 同类问题）。
2. **Issue #41（TUN 不可用）**：Windows 下开启 TUN 时出现“启动失败/状态异常”，导致 TUN 模式不可用或体验不一致。
3. **Issue #57（走向图全屏）**：规则较复杂时，走向图在小窗口难以查看，希望支持更大尺寸/全屏查看。

其中 #55 属于“数据引用一致性”问题：**订阅同步会替换节点集合，节点 ID 变化会导致 FRouter 的图引用断裂**。仅靠“尽量复用 node.ID”的局部补丁很容易在边界条件（identity 冲突、订阅端参数小改动、Clash YAML 与分享链接混用等）下失效。

因此本次选择 **方案2：重构订阅节点 ID 体系**，目标是把“稳定标识、引用修复、同步语义”做成一套可解释、可测试、可回归的规则，而不是继续堆叠临时修补。

## 产品分析

### 目标用户与场景
- **用户群体:** 需要稳定管理多订阅、多节点、多规则链路的高级用户
- **使用场景:** 订阅频繁更新、规则复杂、需要快速定位链路走向与排障
- **核心痛点:** 订阅同步后出现“未知节点/链路断裂”，以及 TUN/走向图导致的可用性下降

### 价值主张与成功指标
- **价值主张:** 同步可预测、引用不破坏、错误可定位、复杂链路可视化更清晰
- **成功指标:**
  - 订阅同步后，FRouter 不再出现“未知: {id}”的断裂节点（#55）
  - Windows 下开启 TUN 的失败原因可明确提示，避免“看似失败但内核已运行/反之”的状态错觉（#41）
  - 走向图可在大视图下查看（#57）

### 人文关怀
订阅内容与网络环境常涉及隐私/敏感信息。本次不引入新的敏感数据展示；错误提示与日志需避免打印订阅 URL/token 等信息。

## 变更内容
1. **建立“订阅节点稳定标识（NodeKey）”规则**：以可解释的 canonical key 作为节点匹配依据，提升 ID 复用成功率并规避误匹配。
2. **订阅同步的“引用修复”**：当节点集合发生变更时，自动修复所有受影响的 FRouter 图引用（edges.to / edges.via / slots.boundNodeId）。
3. **TUN（Windows）可用性补强**：启动失败时给出可操作提示；就绪判定逻辑更稳健，避免误报“启动失败”。
4. **走向图全屏/大视图体验完善**：支持在编辑场景与查看场景中以更大画布查看走向图。

## 影响范围
- **模块:**
  - backend/service/config（订阅同步、节点更新、引用修复）
  - backend/repository/memory（节点替换语义与指标保留）
  - backend/service/proxy（TUN 启动与就绪判定/错误提示）
  - frontend/theme/_shared（走向图全屏/大视图）
- **文件:**
  - `backend/service/config/*`
  - `backend/service/proxy/service.go`
  - `frontend/theme/_shared/js/app.js`（以及主题相关 HTML/CSS 如需要）
- **API:**
  - 不新增对外 API；复用现有 `/configs/:id/pull-nodes`、`/proxy/start`、`/tun/check`、`/frouters/:id/graph`
- **数据:**
  - 节点集合的更新策略与 ID 复用/映射逻辑（涉及 state.json 中 Node/FRouter 的一致性）

## 核心场景

### 需求: 订阅拉取节点不应导致 FRouter 节点变为未知（Issue #55）
**模块:** backend/service/config

#### 场景: identity 冲突 + 订阅端参数变动后仍保持引用一致
订阅更新后节点参数可能发生小幅变化（例如传输/TLS 细节变动），但用户期望仍能识别“同一个节点”并保持 FRouter 引用稳定。
- 预期结果: 同步后 node.ID 尽量复用；若产生映射，则所有 FRouter 引用被自动修复

#### 场景: 自定义 FRouter 引用订阅节点，同步后仍可解析
用户可能创建自定义 FRouter（非订阅生成）并引用订阅节点。
- 预期结果: 同步后自定义 FRouter 的 edges/slots 引用不被破坏

### 需求: Windows 下 TUN 可正常使用（Issue #41）
**模块:** backend/service/proxy

#### 场景: 未满足权限/驱动条件时给出明确提示
- 预期结果: 启动失败时返回可操作的错误提示（如管理员权限要求、查看内核日志路径等）

#### 场景: 满足条件时就绪判定不误报失败
- 预期结果: 不因网卡命名差异或地址延迟而误判 “TUN interface not ready”

### 需求: 走向图支持全屏/大画布查看（Issue #57）
**模块:** frontend/theme

#### 场景: 在 FRouter 列表详情卡片中全屏查看
- 预期结果: 点击“全屏”进入大画布窗口，可缩放/拖拽浏览

#### 场景: 在路由规则编辑场景中全屏查看
- 预期结果: 在编辑面板点击“走向图”打开大画布窗口，便于复杂规则排障

## 风险评估
- **风险:** 节点匹配策略错误会导致“错绑/错路由”
  - **缓解:** 坚持“唯一才复用/唯一才重写”的原则；对歧义场景宁可不复用并保留旧引用（或仅修复可确定部分），同时记录告警日志供排查
- **风险:** 同步过程中对节点集合的删除可能造成不可逆数据丢失
  - **缓解:** 对订阅同步增加防护：在无法可靠映射时不做破坏性替换；并以单测覆盖关键边界
- **风险:** Windows TUN 失败原因复杂且难复现
  - **缓解:** 强化错误信息与诊断输出；增加纯函数测试覆盖关键判定逻辑
