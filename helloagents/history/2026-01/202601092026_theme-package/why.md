# 变更提案: 主题包（目录化 + ZIP 导入/导出）

## 需求背景

当前主题以单个 HTML 文件维护（`frontend/theme/dark.html`、`frontend/theme/light.html`），样式与逻辑混在一个大文件里：
- 只改样式必须改大 HTML，误改逻辑风险高
- 文件难以组织与复用，不利于维护与版本管理
- 缺少“主题包”的导入/导出能力，无法分享与复用

本次变更目标是将主题从“单文件”升级为“目录主题包”，并提供 `.zip` 导入/导出，形成可安装、可分享的主题资产。

## 产品分析

### 目标用户与场景
- 用户群体:
  - 只想换皮/改配色的普通用户（只改 CSS）
  - 想改布局/扩展面板的高级用户（改 HTML/JS）
  - 主题作者（需要可分发的主题包）
- 使用场景:
  - 修改 `css/` 快速调整配色、圆角、间距等
  - 修改 `index.html` 调整布局结构
  - 通过 `.zip` 导入安装主题；通过导出分享主题
- 核心痛点: “主题=单文件”不可维护，难扩展，难分发

### 价值主张与成功指标
- 价值主张:
  - 主题以目录为单位组织（`css/`、`js/`、assets），降低修改门槛
  - `.zip` 导入/导出让主题具备“安装/分享/备份”的基本能力
  - 主题切换不再绑定固定文件名，可扩展到更多主题
- 成功指标（可验证）:
  - 用户可只修改 `css/` 而不触及逻辑文件
  - 可导入一个主题 zip 并在主题列表中出现，切换后立即生效
  - 可导出已安装主题为 zip 并能再次导入恢复
  - 默认主题迁移后功能一致，`go test ./...` 通过

### 人文关怀
- 主题包包含可执行的前端代码（HTML/JS），导入来源必须可信；UI 需要提示“仅导入你信任的主题包”
- 导入需做路径穿越防护与大小限制，避免破坏用户数据目录

## 变更内容
1. 主题从单 HTML 升级为目录主题包
   - 入口文件固定为 `index.html`
   - 样式目录为 `css/`（至少一个主 CSS 文件）
2. 新增主题管理能力（安装/分享）
   - 列出已安装主题
   - 导入主题 ZIP（安装到 userData 的 `themes/` 下）
   - 导出主题 ZIP（分享/备份）
3. Electron 启动与主题切换适配目录化主题
   - 启动时从后端读取当前主题 id，并从 userData 的 `themes/<id>/index.html` 加载
   - 主题不可用时回退到内置默认主题
4. 修正并拆分现有主题实现
   - 将 `dark.html` / `light.html` 拆分为目录结构（HTML + CSS + JS）

## 影响范围
- **模块:** `frontend/`、`backend/`、`docs/`、`helloagents/wiki/`
- **文件（预估）:**
  - `frontend/main.js`（启动加载与主题目录）
  - `frontend/electron-builder.yml`（打包包含主题目录）
  - `frontend/theme/**`（主题拆分为目录+css）
  - `backend/api/router.go`（新增主题 API）
  - `backend/service/**`（新增主题服务/工具）
- **API:** 新增 `/themes` 系列接口（见 how.md）
- **数据:** 复用前端设置 `theme` 作为“当前主题 id”

## 核心场景

### 需求: 主题以目录形式加载
**模块:** frontend/backend

#### 场景: 启动后加载用户选择的主题
条件: userData 的 `themes/<themeId>/index.html` 存在
- 预期结果: Electron 主窗口加载该主题入口
- 异常结果: 入口缺失/主题不存在时回退默认主题

### 需求: 主题 ZIP 导入/导出
**模块:** backend/frontend

#### 场景: 导入 ZIP 安装主题
条件: 用户选择 `.zip` 文件
- 预期结果: 后端安全解压到 `themes/<themeId>/`，主题列表出现该主题

#### 场景: 导出 ZIP 分享主题
条件: 已安装主题 `<themeId>`
- 预期结果: 下载一个 zip，解压后目录结构完整，可再次导入恢复

### 需求: 主题拆分便于修改
**模块:** frontend/theme

#### 场景: 只修改 CSS
条件: 用户只改 `css/*.css`
- 预期结果: 样式变化，不影响功能逻辑

## 风险评估
- **风险:** 导入主题包等同于运行第三方前端代码
  - **缓解:** UI 明示“仅导入可信来源”；默认只从本地文件导入；不启用 NodeIntegration
- **风险:** ZIP 路径穿越/覆盖用户数据文件
  - **缓解:** 解压使用安全路径拼接（拒绝 `..`、绝对路径）；限制 zip 大小；解压到临时目录后原子替换
- **风险:** 主题结构不完整导致白屏
  - **缓解:** 导入后校验 `index.html` 存在；加载失败时回退默认主题并提示
