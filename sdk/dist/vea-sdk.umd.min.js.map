{"version":3,"file":"vea-sdk.umd.min.js","sources":["../src/client.js","../src/utils.js","../src/index.js"],"sourcesContent":["/**\n * Vea SDK - HTTP Client\n *\n * 核心 HTTP 客户端，处理所有 API 请求和响应\n * 支持浏览器和 Node.js 环境\n */\n\nclass VeaError extends Error {\n  constructor(message, statusCode, response) {\n    super(message)\n    this.name = 'VeaError'\n    this.statusCode = statusCode\n    this.response = response\n  }\n}\n\nclass VeaClient {\n  /**\n   * 创建 Vea 客户端实例\n   * @param {Object} options - 配置选项\n   * @param {string} options.baseURL - API 基础 URL（默认：http://localhost:8080）\n   * @param {number} options.timeout - 请求超时时间（毫秒，默认：300000 = 5分钟）\n   * @param {Object} options.headers - 自定义 HTTP 头\n   */\n  constructor(options = {}) {\n    this.baseURL = (options.baseURL || 'http://localhost:8080').replace(/\\/$/, '')\n    this.timeout = options.timeout || 300000 // 5 分钟，适合大文件下载（如 Xray）\n    this.headers = options.headers || {}\n\n    // 检测环境\n    this.isBrowser = typeof window !== 'undefined' && typeof window.document !== 'undefined'\n    this.isNode = typeof process !== 'undefined' && process.versions && process.versions.node\n\n    // 初始化资源 API\n    this.nodes = new NodesAPI(this)\n    this.configs = new ConfigsAPI(this)\n    this.geo = new GeoAPI(this)\n    this.components = new ComponentsAPI(this)\n    this.xray = new XrayAPI(this)\n    this.traffic = new TrafficAPI(this)\n    this.settings = new SettingsAPI(this)\n  }\n\n  /**\n   * 执行 HTTP 请求\n   * @param {Object} options - 请求选项\n   * @param {string} options.method - HTTP 方法\n   * @param {string} options.path - 请求路径\n   * @param {Object} options.body - 请求体\n   * @param {Object} options.headers - 自定义请求头\n   * @param {number} options.timeout - 超时时间（覆盖默认值）\n   * @returns {Promise<any>} 响应数据\n   */\n  async request(options) {\n    const {\n      method = 'GET',\n      path,\n      body,\n      headers = {},\n      timeout = this.timeout\n    } = options\n\n    const url = `${this.baseURL}${path}`\n    const requestHeaders = {\n      ...this.headers,\n      ...headers\n    }\n\n    // 如果有 body，自动设置 Content-Type\n    if (body && !(body instanceof FormData)) {\n      requestHeaders['Content-Type'] = 'application/json'\n    }\n\n    const requestOptions = {\n      method,\n      headers: requestHeaders\n    }\n\n    if (body) {\n      requestOptions.body = body instanceof FormData ? body : JSON.stringify(body)\n    }\n\n    // 创建 AbortController 实现超时\n    const controller = new AbortController()\n    const timeoutId = setTimeout(() => controller.abort(), timeout)\n    requestOptions.signal = controller.signal\n\n    try {\n      const response = await fetch(url, requestOptions)\n      clearTimeout(timeoutId)\n\n      // 处理响应\n      return await this._handleResponse(response)\n    } catch (error) {\n      clearTimeout(timeoutId)\n\n      if (error.name === 'AbortError') {\n        throw new VeaError(`Request timeout after ${timeout}ms`, 0, null)\n      }\n\n      if (error instanceof VeaError) {\n        throw error\n      }\n\n      throw new VeaError(`Network error: ${error.message}`, 0, null)\n    }\n  }\n\n  /**\n   * 处理 HTTP 响应\n   * @private\n   * @param {Response} response - Fetch API Response 对象\n   * @returns {Promise<any>} 解析后的响应数据\n   */\n  async _handleResponse(response) {\n    // 204 No Content\n    if (response.status === 204) {\n      return null\n    }\n\n    const contentType = response.headers.get('content-type') || ''\n    let data\n\n    // 解析响应体\n    if (contentType.includes('application/json')) {\n      data = await response.json()\n    } else {\n      data = await response.text()\n    }\n\n    // 检查错误\n    if (!response.ok) {\n      let message = response.statusText\n\n      if (typeof data === 'object' && data.error) {\n        message = data.error\n      } else if (typeof data === 'string' && data) {\n        message = data\n      }\n\n      throw new VeaError(message, response.status, data)\n    }\n\n    return data\n  }\n\n  /**\n   * GET 请求快捷方法\n   * @param {string} path - 请求路径\n   * @param {Object} options - 额外选项\n   * @returns {Promise<any>}\n   */\n  async get(path, options = {}) {\n    return this.request({ method: 'GET', path, ...options })\n  }\n\n  /**\n   * POST 请求快捷方法\n   * @param {string} path - 请求路径\n   * @param {Object} body - 请求体\n   * @param {Object} options - 额外选项\n   * @returns {Promise<any>}\n   */\n  async post(path, body, options = {}) {\n    return this.request({ method: 'POST', path, body, ...options })\n  }\n\n  /**\n   * PUT 请求快捷方法\n   * @param {string} path - 请求路径\n   * @param {Object} body - 请求体\n   * @param {Object} options - 额外选项\n   * @returns {Promise<any>}\n   */\n  async put(path, body, options = {}) {\n    return this.request({ method: 'PUT', path, body, ...options })\n  }\n\n  /**\n   * DELETE 请求快捷方法\n   * @param {string} path - 请求路径\n   * @param {Object} options - 额外选项\n   * @returns {Promise<any>}\n   */\n  async delete(path, options = {}) {\n    return this.request({ method: 'DELETE', path, ...options })\n  }\n\n  /**\n   * 健康检查\n   * @returns {Promise<{status: string, timestamp: string}>}\n   */\n  async health() {\n    return this.get('/health')\n  }\n\n  /**\n   * 获取完整状态快照\n   * @returns {Promise<Object>} 包含所有节点、配置、组件等的快照\n   */\n  async snapshot() {\n    return this.get('/snapshot')\n  }\n}\n\n/**\n * 节点管理 API\n */\nclass NodesAPI {\n  constructor(client) {\n    this.client = client\n  }\n\n  /**\n   * 列出所有节点\n   * @returns {Promise<{nodes: Array, activeNodeId: string, lastSelectedNodeId: string}>}\n   */\n  async list() {\n    return this.client.get('/nodes')\n  }\n\n  /**\n   * 创建节点\n   * @param {Object} data - 节点数据\n   * @param {string} data.shareLink - 分享链接（vmess/vless/trojan/ss）\n   * @param {string} data.name - 节点名称（手动创建时必需）\n   * @param {string} data.address - 服务器地址（手动创建时必需）\n   * @param {number} data.port - 端口（手动创建时必需）\n   * @param {string} data.protocol - 协议类型（手动创建时必需）\n   * @param {Array<string>} data.tags - 标签列表\n   * @returns {Promise<Object>} 创建的节点\n   */\n  async create(data) {\n    return this.client.post('/nodes', data)\n  }\n\n  /**\n   * 更新节点\n   * @param {string} id - 节点 ID\n   * @param {Object} data - 更新数据\n   * @returns {Promise<Object>} 更新后的节点\n   */\n  async update(id, data) {\n    return this.client.put(`/nodes/${id}`, data)\n  }\n\n  /**\n   * 删除节点\n   * @param {string} id - 节点 ID\n   * @returns {Promise<null>}\n   */\n  async delete(id) {\n    return this.client.delete(`/nodes/${id}`)\n  }\n\n  /**\n   * 重置节点流量\n   * @param {string} id - 节点 ID\n   * @returns {Promise<Object>} 更新后的节点\n   */\n  async resetTraffic(id) {\n    return this.client.post(`/nodes/${id}/reset-traffic`)\n  }\n\n  /**\n   * 增加节点流量\n   * @param {string} id - 节点 ID\n   * @param {Object} traffic - 流量数据\n   * @param {number} traffic.uploadBytes - 上传字节数\n   * @param {number} traffic.downloadBytes - 下载字节数\n   * @returns {Promise<Object>} 更新后的节点\n   */\n  async incrementTraffic(id, traffic) {\n    return this.client.post(`/nodes/${id}/traffic`, traffic)\n  }\n\n  /**\n   * 测试节点延迟（异步）\n   * @param {string} id - 节点 ID\n   * @returns {Promise<null>}\n   */\n  async ping(id) {\n    return this.client.post(`/nodes/${id}/ping`)\n  }\n\n  /**\n   * 测试节点速度（异步）\n   * @param {string} id - 节点 ID\n   * @returns {Promise<null>}\n   */\n  async speedtest(id) {\n    return this.client.post(`/nodes/${id}/speedtest`)\n  }\n\n  /**\n   * 选择节点（切换 Xray 使用的节点）\n   * @param {string} id - 节点 ID\n   * @returns {Promise<null>}\n   */\n  async select(id) {\n    return this.client.post(`/nodes/${id}/select`)\n  }\n\n  /**\n   * 批量测试节点延迟\n   * @param {Array<string>} ids - 节点 ID 列表（为空则测试所有节点）\n   * @returns {Promise<null>}\n   */\n  async bulkPing(ids = []) {\n    return this.client.post('/nodes/bulk/ping', { ids })\n  }\n\n  /**\n   * 重置节点速度测试结果\n   * @param {Array<string>} ids - 节点 ID 列表\n   * @returns {Promise<null>}\n   */\n  async resetSpeed(ids = []) {\n    return this.client.post('/nodes/reset-speed', { ids })\n  }\n}\n\n/**\n * 配置管理 API\n */\nclass ConfigsAPI {\n  constructor(client) {\n    this.client = client\n  }\n\n  /**\n   * 列出所有配置\n   * @returns {Promise<Array>}\n   */\n  async list() {\n    return this.client.get('/configs')\n  }\n\n  /**\n   * 导入配置\n   * @param {Object} data - 配置数据\n   * @param {string} data.name - 配置名称\n   * @param {string} data.format - 配置格式（默认 xray-json）\n   * @param {string} data.sourceUrl - 配置源地址或订阅链接\n   * @param {string} data.payload - 配置内容（可选）\n   * @param {number} data.autoUpdateIntervalMinutes - 自动更新间隔（分钟）\n   * @param {string} data.expireAt - 过期时间（ISO 8601 格式）\n   * @returns {Promise<Object>} 创建的配置\n   */\n  async import(data) {\n    return this.client.post('/configs/import', data)\n  }\n\n  /**\n   * 更新配置\n   * @param {string} id - 配置 ID\n   * @param {Object} data - 更新数据\n   * @returns {Promise<Object>} 更新后的配置\n   */\n  async update(id, data) {\n    return this.client.put(`/configs/${id}`, data)\n  }\n\n  /**\n   * 删除配置\n   * @param {string} id - 配置 ID\n   * @returns {Promise<null>}\n   */\n  async delete(id) {\n    return this.client.delete(`/configs/${id}`)\n  }\n\n  /**\n   * 刷新配置（从 sourceUrl 重新拉取）\n   * @param {string} id - 配置 ID\n   * @returns {Promise<Object>} 刷新后的配置\n   */\n  async refresh(id) {\n    return this.client.post(`/configs/${id}/refresh`)\n  }\n\n  /**\n   * 同步配置节点（从配置中提取节点）\n   * @param {string} id - 配置 ID\n   * @returns {Promise<Array>} 提取的节点列表\n   */\n  async pullNodes(id) {\n    return this.client.post(`/configs/${id}/pull-nodes`)\n  }\n\n  /**\n   * 增加配置流量\n   * @param {string} id - 配置 ID\n   * @param {Object} traffic - 流量数据\n   * @returns {Promise<Object>} 更新后的配置\n   */\n  async incrementTraffic(id, traffic) {\n    return this.client.post(`/configs/${id}/traffic`, traffic)\n  }\n}\n\n/**\n * Geo 资源管理 API\n */\nclass GeoAPI {\n  constructor(client) {\n    this.client = client\n  }\n\n  /**\n   * 列出所有 Geo 资源\n   * @returns {Promise<Array>}\n   */\n  async list() {\n    return this.client.get('/geo')\n  }\n\n  /**\n   * 创建 Geo 资源\n   * @param {Object} data - Geo 资源数据\n   * @returns {Promise<Object>}\n   */\n  async create(data) {\n    return this.client.post('/geo', data)\n  }\n\n  /**\n   * 更新 Geo 资源（upsert）\n   * @param {string} id - Geo 资源 ID\n   * @param {Object} data - 更新数据\n   * @returns {Promise<Object>}\n   */\n  async update(id, data) {\n    return this.client.put(`/geo/${id}`, data)\n  }\n\n  /**\n   * 删除 Geo 资源\n   * @param {string} id - Geo 资源 ID\n   * @returns {Promise<null>}\n   */\n  async delete(id) {\n    return this.client.delete(`/geo/${id}`)\n  }\n\n  /**\n   * 刷新 Geo 资源（从 sourceUrl 重新下载）\n   * @param {string} id - Geo 资源 ID\n   * @returns {Promise<Object>}\n   */\n  async refresh(id) {\n    return this.client.post(`/geo/${id}/refresh`)\n  }\n}\n\n/**\n * 核心组件管理 API\n */\nclass ComponentsAPI {\n  constructor(client) {\n    this.client = client\n  }\n\n  /**\n   * 列出所有核心组件\n   * @returns {Promise<Array>}\n   */\n  async list() {\n    return this.client.get('/components')\n  }\n\n  /**\n   * 创建核心组件记录\n   * @param {Object} data - 组件数据\n   * @param {string} data.kind - 组件类型（xray/geo/generic）\n   * @returns {Promise<Object>}\n   */\n  async create(data) {\n    return this.client.post('/components', data)\n  }\n\n  /**\n   * 更新核心组件\n   * @param {string} id - 组件 ID\n   * @param {Object} data - 更新数据\n   * @returns {Promise<Object>}\n   */\n  async update(id, data) {\n    return this.client.put(`/components/${id}`, data)\n  }\n\n  /**\n   * 删除核心组件\n   * @param {string} id - 组件 ID\n   * @returns {Promise<null>}\n   */\n  async delete(id) {\n    return this.client.delete(`/components/${id}`)\n  }\n\n  /**\n   * 安装核心组件\n   * @param {string} id - 组件 ID\n   * @returns {Promise<Object>}\n   */\n  async install(id) {\n    return this.client.post(`/components/${id}/install`)\n  }\n}\n\n/**\n * Xray 控制 API\n */\nclass XrayAPI {\n  constructor(client) {\n    this.client = client\n  }\n\n  /**\n   * 获取 Xray 状态\n   * @returns {Promise<Object>}\n   */\n  async status() {\n    return this.client.get('/xray/status')\n  }\n\n  /**\n   * 启动 Xray\n   * @param {Object} options - 启动选项\n   * @param {string} options.activeNodeId - 使用的节点 ID\n   * @returns {Promise<null>}\n   */\n  async start(options = {}) {\n    return this.client.post('/xray/start', options)\n  }\n\n  /**\n   * 停止 Xray\n   * @returns {Promise<null>}\n   */\n  async stop() {\n    return this.client.post('/xray/stop')\n  }\n}\n\n/**\n * 流量策略 API\n */\nclass TrafficAPI {\n  constructor(client) {\n    this.client = client\n    this.rules = new TrafficRulesAPI(client)\n  }\n\n  /**\n   * 获取流量策略\n   * @returns {Promise<Object>}\n   */\n  async getProfile() {\n    return this.client.get('/traffic/profile')\n  }\n\n  /**\n   * 更新流量策略\n   * @param {Object} data - 策略数据\n   * @param {string} data.defaultNodeId - 默认出口节点 ID\n   * @param {Object} data.dns - DNS 设置\n   * @returns {Promise<Object>}\n   */\n  async updateProfile(data) {\n    return this.client.put('/traffic/profile', data)\n  }\n}\n\n/**\n * 分流规则 API\n */\nclass TrafficRulesAPI {\n  constructor(client) {\n    this.client = client\n  }\n\n  /**\n   * 列出所有分流规则\n   * @returns {Promise<Array>}\n   */\n  async list() {\n    return this.client.get('/traffic/rules')\n  }\n\n  /**\n   * 创建分流规则\n   * @param {Object} data - 规则数据\n   * @returns {Promise<Object>}\n   */\n  async create(data) {\n    return this.client.post('/traffic/rules', data)\n  }\n\n  /**\n   * 更新分流规则\n   * @param {string} id - 规则 ID\n   * @param {Object} data - 更新数据\n   * @returns {Promise<Object>}\n   */\n  async update(id, data) {\n    return this.client.put(`/traffic/rules/${id}`, data)\n  }\n\n  /**\n   * 删除分流规则\n   * @param {string} id - 规则 ID\n   * @returns {Promise<null>}\n   */\n  async delete(id) {\n    return this.client.delete(`/traffic/rules/${id}`)\n  }\n}\n\n/**\n * 系统设置 API\n */\nclass SettingsAPI {\n  constructor(client) {\n    this.client = client\n  }\n\n  /**\n   * 获取系统代理设置\n   * @returns {Promise<{settings: Object, message: string}>}\n   */\n  async getSystemProxy() {\n    return this.client.get('/settings/system-proxy')\n  }\n\n  /**\n   * 更新系统代理设置\n   * @param {Object} data - 代理设置\n   * @param {boolean} data.enabled - 是否启用系统代理\n   * @param {Array<string>} data.ignoreHosts - 忽略代理的主机列表\n   * @returns {Promise<{settings: Object, message: string}>}\n   */\n  async updateSystemProxy(data) {\n    return this.client.put('/settings/system-proxy', data)\n  }\n}\n\n/**\n * 简化版 API 对象（兼容现有前端代码）\n *\n * 使用方式:\n * const api = createAPI('http://localhost:8080')\n * await api.get('/nodes')\n * await api.post('/nodes', { name: 'test' })\n */\nfunction createAPI(baseURL = '') {\n  const client = new VeaClient({ baseURL })\n\n  return {\n    async request(path, options = {}) {\n      return client.request({ path, ...options })\n    },\n\n    async get(path, options = {}) {\n      return client.get(path, options)\n    },\n\n    async post(path, body, options = {}) {\n      return client.post(path, body, options)\n    },\n\n    async put(path, body, options = {}) {\n      return client.put(path, body, options)\n    },\n\n    async delete(path, options = {}) {\n      return client.delete(path, options)\n    },\n\n    // 暴露底层客户端\n    client\n  }\n}\n\n/**\n * 创建带轮询的节点管理器\n * @param {VeaClient} client - Vea 客户端实例\n * @param {number} interval - 轮询间隔（毫秒，默认 1000）\n * @returns {Object} 节点管理器\n */\nfunction createNodeManager(client, interval = 1000) {\n  let nodesCache = []\n  let activeNodeId = ''\n  let lastSelectedNodeId = ''\n  let pollingTimer = null\n  let listeners = []\n\n  async function fetchNodes() {\n    try {\n      const result = await client.nodes.list()\n      nodesCache = result.nodes || []\n      activeNodeId = result.activeNodeId || ''\n      lastSelectedNodeId = result.lastSelectedNodeId || ''\n\n      // 触发监听器\n      listeners.forEach(fn => {\n        try {\n          fn({ nodes: nodesCache, activeNodeId, lastSelectedNodeId })\n        } catch (err) {\n          console.error('Node listener error:', err)\n        }\n      })\n\n      return result\n    } catch (error) {\n      console.error('Failed to fetch nodes:', error)\n      throw error\n    }\n  }\n\n  return {\n    // 获取当前缓存的节点\n    getNodes() {\n      return nodesCache\n    },\n\n    getActiveNodeId() {\n      return activeNodeId\n    },\n\n    getLastSelectedNodeId() {\n      return lastSelectedNodeId\n    },\n\n    // 刷新节点（手动）\n    async refresh() {\n      return fetchNodes()\n    },\n\n    // 启动轮询\n    startPolling() {\n      if (pollingTimer) return\n      fetchNodes()  // 立即执行一次\n      pollingTimer = setInterval(fetchNodes, interval)\n    },\n\n    // 停止轮询\n    stopPolling() {\n      if (pollingTimer) {\n        clearInterval(pollingTimer)\n        pollingTimer = null\n      }\n    },\n\n    // 监听节点变化\n    onUpdate(callback) {\n      listeners.push(callback)\n      return () => {\n        listeners = listeners.filter(fn => fn !== callback)\n      }\n    }\n  }\n}\n\n// ES Module 导出（rollup 打包时使用）\nexport {\n  VeaClient,\n  VeaError,\n  createAPI,\n  createNodeManager\n}\n\n// 默认导出\nexport default VeaClient\n","/**\n * Vea SDK - 工具函数\n *\n * 从现有前端提取的实用工具函数\n */\n\n/**\n * 格式化时间\n * @param {string|Date} value - ISO 8601 时间字符串或 Date 对象\n * @returns {string} 本地化时间字符串\n */\nexport function formatTime(value) {\n  if (!value) return '-'\n  const date = new Date(value)\n  if (Number.isNaN(date.getTime())) return String(value)\n  return date.toLocaleString()\n}\n\n/**\n * 格式化字节数为可读格式\n * @param {number} bytes - 字节数\n * @returns {string} 格式化后的字符串（如 \"1.5 MB\"）\n */\nexport function formatBytes(bytes) {\n  const size = Number(bytes)\n  if (!size || size <= 0) return '0 B'\n  const units = ['B', 'KB', 'MB', 'GB', 'TB']\n  const index = Math.min(Math.floor(Math.log(size) / Math.log(1024)), units.length - 1)\n  const value = size / Math.pow(1024, index)\n  return `${value.toFixed(index === 0 ? 0 : 1)} ${units[index]}`\n}\n\n/**\n * 格式化时间间隔（Go duration）\n * @param {number|string} duration - 纳秒（数字）或 Go duration 字符串\n * @returns {string} 格式化后的字符串\n */\nexport function formatInterval(duration) {\n  if (!duration) return '未设置'\n\n  if (typeof duration === 'number') {\n    if (duration === 0) return '未设置'\n    const minutes = Math.round(duration / 60000000000)\n    return `${minutes} 分钟`\n  }\n\n  if (typeof duration === 'string') {\n    if (duration === '0s' || duration === '0') return '未设置'\n    return duration.replace('m0s', 'm').replace('h0m0s', 'h')\n  }\n\n  return String(duration)\n}\n\n/**\n * HTML 转义\n * @param {any} value - 需要转义的值\n * @returns {string} 转义后的字符串\n */\nexport function escapeHtml(value) {\n  return String(value ?? '')\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;')\n    .replace(/\"/g, '&quot;')\n    .replace(/'/g, '&#39;')\n}\n\n/**\n * 格式化延迟（毫秒）\n * @param {number} ms - 毫秒数\n * @returns {string} 格式化后的字符串\n */\nexport function formatLatency(ms) {\n  if (!ms || ms <= 0) return '-'\n  if (ms < 1000) return `${Math.round(ms)} ms`\n  return `${(ms / 1000).toFixed(2)} s`\n}\n\n/**\n * 格式化速度（MB/s）\n * @param {number} mbps - MB/s\n * @returns {string} 格式化后的字符串\n */\nexport function formatSpeed(mbps) {\n  if (!mbps || mbps <= 0) return '-'\n  if (mbps >= 10) return `${mbps.toFixed(1)} MB/s`\n  return `${mbps.toFixed(2)} MB/s`\n}\n\n/**\n * 休眠指定时间\n * @param {number} ms - 毫秒数\n * @returns {Promise<void>}\n */\nexport function sleep(ms) {\n  return new Promise(resolve => setTimeout(resolve, ms))\n}\n\n/**\n * 解析列表字符串（逗号、分号、换行分隔）\n * @param {string} input - 输入字符串\n * @returns {string[]} 解析后的数组\n */\nexport function parseList(input) {\n  if (!input) return []\n  return input\n    .split(/[\\s,;\\n]+/)\n    .map(item => item.trim())\n    .filter(Boolean)\n}\n\n/**\n * 解析数字\n * @param {any} value - 需要解析的值\n * @returns {number} 数字（失败返回 0）\n */\nexport function parseNumber(value) {\n  const num = Number(value)\n  return Number.isFinite(num) ? num : 0\n}\n\n/**\n * 防抖函数\n * @param {Function} fn - 需要防抖的函数\n * @param {number} delay - 延迟时间（毫秒）\n * @returns {Function} 防抖后的函数\n */\nexport function debounce(fn, delay) {\n  let timer = null\n  return function(...args) {\n    if (timer) clearTimeout(timer)\n    timer = setTimeout(() => fn.apply(this, args), delay)\n  }\n}\n\n/**\n * 节流函数\n * @param {Function} fn - 需要节流的函数\n * @param {number} delay - 延迟时间（毫秒）\n * @returns {Function} 节流后的函数\n */\nexport function throttle(fn, delay) {\n  let last = 0\n  return function(...args) {\n    const now = Date.now()\n    if (now - last >= delay) {\n      last = now\n      fn.apply(this, args)\n    }\n  }\n}\n\n/**\n * 创建轮询器\n * @param {Function} fn - 轮询执行的函数\n * @param {number} interval - 轮询间隔（毫秒）\n * @returns {Object} 包含 start/stop 方法的控制器\n */\nexport function createPoller(fn, interval) {\n  let timer = null\n  let running = false\n\n  return {\n    start() {\n      if (running) return\n      running = true\n\n      // 立即执行一次\n      Promise.resolve(fn()).catch(console.error)\n\n      // 启动定时器\n      timer = setInterval(() => {\n        Promise.resolve(fn()).catch(console.error)\n      }, interval)\n    },\n\n    stop() {\n      if (!running) return\n      running = false\n      if (timer) {\n        clearInterval(timer)\n        timer = null\n      }\n    },\n\n    isRunning() {\n      return running\n    }\n  }\n}\n\n/**\n * 重试函数\n * @param {Function} fn - 需要重试的函数\n * @param {Object} options - 重试选项\n * @param {number} options.maxRetries - 最大重试次数\n * @param {number} options.delay - 重试延迟（毫秒）\n * @param {Function} options.shouldRetry - 判断是否应该重试的函数\n * @returns {Promise<any>}\n */\nexport async function retry(fn, options = {}) {\n  const {\n    maxRetries = 3,\n    delay = 1000,\n    shouldRetry = () => true\n  } = options\n\n  let lastError\n\n  for (let i = 0; i <= maxRetries; i++) {\n    try {\n      return await fn()\n    } catch (error) {\n      lastError = error\n\n      if (i < maxRetries && shouldRetry(error)) {\n        await sleep(delay * Math.pow(2, i))  // 指数退避\n      } else {\n        break\n      }\n    }\n  }\n\n  throw lastError\n}\n\n// 导出所有工具函数\nexport default {\n  formatTime,\n  formatBytes,\n  formatInterval,\n  formatLatency,\n  formatSpeed,\n  escapeHtml,\n  sleep,\n  parseList,\n  parseNumber,\n  debounce,\n  throttle,\n  createPoller,\n  retry\n}\n","/**\n * Vea SDK - 统一入口文件\n */\n\n// 导入核心模块\nimport { VeaClient, VeaError, createAPI, createNodeManager } from './client.js'\n\n// 导入工具函数\nimport {\n  formatTime,\n  formatBytes,\n  formatInterval,\n  formatLatency,\n  formatSpeed,\n  escapeHtml,\n  sleep,\n  parseList,\n  parseNumber,\n  debounce,\n  throttle,\n  createPoller,\n  retry\n} from './utils.js'\n\n// 统一导出\nconst utils = {\n  formatTime,\n  formatBytes,\n  formatInterval,\n  formatLatency,\n  formatSpeed,\n  escapeHtml,\n  sleep,\n  parseList,\n  parseNumber,\n  debounce,\n  throttle,\n  createPoller,\n  retry\n}\n\n// ES Module 导出\nexport {\n  VeaClient,\n  VeaError,\n  createAPI,\n  createNodeManager,\n  utils,\n  // 工具函数直接导出\n  formatTime,\n  formatBytes,\n  formatInterval,\n  formatLatency,\n  formatSpeed,\n  escapeHtml,\n  sleep,\n  parseList,\n  parseNumber,\n  debounce,\n  throttle,\n  createPoller,\n  retry\n}\n\nexport default VeaClient\n"],"names":["VeaError","Error","constructor","message","statusCode","response","super","this","name","VeaClient","options","baseURL","replace","timeout","headers","isBrowser","window","document","isNode","process","versions","node","nodes","NodesAPI","configs","ConfigsAPI","geo","GeoAPI","components","ComponentsAPI","xray","XrayAPI","traffic","TrafficAPI","settings","SettingsAPI","request","method","path","body","url","requestHeaders","FormData","requestOptions","JSON","stringify","controller","AbortController","timeoutId","setTimeout","abort","signal","fetch","clearTimeout","_handleResponse","error","status","data","get","includes","json","text","ok","statusText","post","put","health","snapshot","client","list","create","update","id","delete","resetTraffic","incrementTraffic","ping","speedtest","select","bulkPing","ids","resetSpeed","import","refresh","pullNodes","install","start","stop","rules","TrafficRulesAPI","getProfile","updateProfile","getSystemProxy","updateSystemProxy","formatTime","value","date","Date","Number","isNaN","getTime","String","toLocaleString","formatBytes","bytes","size","units","index","Math","min","floor","log","length","pow","toFixed","formatInterval","duration","round","escapeHtml","formatLatency","ms","formatSpeed","mbps","sleep","Promise","resolve","parseList","input","split","map","item","trim","filter","Boolean","parseNumber","num","isFinite","debounce","fn","delay","timer","args","apply","throttle","last","now","createPoller","interval","running","catch","console","setInterval","clearInterval","isRunning","async","retry","maxRetries","shouldRetry","lastError","i","utils","nodesCache","activeNodeId","lastSelectedNodeId","pollingTimer","listeners","fetchNodes","result","forEach","err","getNodes","getActiveNodeId","getLastSelectedNodeId","startPolling","stopPolling","onUpdate","callback","push"],"mappings":"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"}