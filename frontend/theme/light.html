<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Vea Console</title>
  <style>
    :root {
      /* Premium Light (Linear-esque) */
      --bg-root: #ffffff;
      --bg-sidebar: #f7f7f8;
      --bg-card: #ffffff;
      --bg-card-hover: #fcfcfc;

      --border-subtle: #e5e5e5;
      --border-highlight: #d4d4d4;

      --text-primary: #171717;
      --text-secondary: #737373;
      --text-tertiary: #a3a3a3;

      --accent: #000000;
      --accent-glow: 0 0 20px rgba(0, 0, 0, 0.1);

      --success: #16a34a;
      --warning: #d97706;
      --error: #dc2626;

      --radius-sm: 6px;
      --radius-md: 12px;
      --radius-lg: 16px;

      --font-sans: "SF Pro Text", -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      --font-mono: "SF Mono", "JetBrains Mono", Consolas, monospace;

      --ease: cubic-bezier(0.23, 1, 0.32, 1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      background-color: var(--bg-root);
      color: var(--text-primary);
      font-family: var(--font-sans);
      height: 100vh;
      display: grid;
      grid-template-columns: 240px 1fr;
      grid-template-rows: 44px 1fr;
      overflow: hidden;
      font-size: 14px;
      letter-spacing: -0.01em;
      -webkit-font-smoothing: antialiased;
    }

    /* === Titlebar === */
    .titlebar {
      grid-column: 1 / -1;
      grid-row: 1;
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      background: var(--bg-root);
      border-bottom: 1px solid var(--border-subtle);
      -webkit-app-region: drag;
      user-select: none;
      z-index: 50;
    }

    .titlebar-title {
      font-size: 13px;
      font-weight: 600;
      color: var(--text-secondary);
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .logo-dot {
      width: 8px;
      height: 8px;
      background: var(--text-primary);
      border-radius: 50%;
      box-shadow: var(--accent-glow);
    }

    .titlebar-controls {
      display: flex;
      gap: 8px;
      -webkit-app-region: no-drag;
    }

    .window-ctrl {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: var(--border-subtle);
      cursor: pointer;
      transition: 0.2s;
    }

    .window-ctrl:hover {
      background: var(--text-secondary);
    }

    .window-ctrl.close:hover {
      background: var(--error);
    }

    /* === Sidebar === */
    .sidebar {
      grid-column: 1;
      grid-row: 2;
      background: var(--bg-sidebar);
      border-right: 1px solid var(--border-subtle);
      display: flex;
      flex-direction: column;
      padding: 24px 16px;
    }

    .sidebar-section-title {
      font-size: 11px;
      text-transform: uppercase;
      color: var(--text-tertiary);
      margin-bottom: 12px;
      padding-left: 12px;
      font-weight: 600;
      letter-spacing: 0.05em;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: var(--radius-sm);
      color: var(--text-secondary);
      background: transparent;
      border: none;
      cursor: pointer;
      transition: all 0.3s var(--ease);
      font-size: 14px;
      font-weight: 500;
      text-align: left;
      margin-bottom: 4px;
    }

    .nav-item svg {
      width: 18px;
      height: 18px;
      opacity: 0.7;
      transition: 0.3s;
    }

    .nav-item:hover {
      background: rgba(0, 0, 0, 0.03);
      color: var(--text-primary);
    }

    .nav-item:hover svg {
      opacity: 1;
    }

    .nav-item.active {
      background: #fff;
      color: var(--text-primary);
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
      border: 1px solid var(--border-subtle);
    }

    .nav-item.active svg {
      opacity: 1;
      color: var(--accent);
    }

    /* === Main Content === */
    main {
      grid-column: 2;
      grid-row: 2;
      position: relative;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      background: var(--bg-root);
    }

    /* === Status Toast === */
    .status-bar {
      position: absolute;
      bottom: 32px;
      right: 32px;
      padding: 12px 20px;
      background: #fff;
      border: 1px solid var(--border-subtle);
      border-radius: 99px;
      font-size: 13px;
      font-weight: 500;
      color: var(--text-primary);
      transform: translateY(100px);
      transition: transform 0.4s var(--ease);
      z-index: 900;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
      display: flex;
      align-items: center;
      gap: 10px;
      opacity: 0;
    }

    .status-bar::before {
      content: '';
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .status-bar.visible {
      transform: translateY(0);
      opacity: 1;
    }

    .status-bar.success::before {
      background: var(--success);
      box-shadow: 0 0 10px rgba(22, 163, 74, 0.3);
    }

    .status-bar.error::before {
      background: var(--error);
      box-shadow: 0 0 10px rgba(220, 38, 38, 0.3);
    }

    .status-bar.info::before {
      background: var(--accent);
    }

    /* === Panels === */
    .panel {
      display: none;
      height: 100%;
      padding: 48px 64px;
      overflow-y: auto;
      max-width: 1400px;
      margin: 0 auto;
      width: 100%;
      animation: fadeUp 0.5s var(--ease);
    }

    .panel.active {
      display: flex;
      flex-direction: column;
    }

    @keyframes fadeUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .panel-header {
      margin-bottom: 48px;
      display: flex;
      justify-content: space-between;
      align-items: flex-end;
    }

    .panel-title h2 {
      font-size: 32px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      letter-spacing: -0.02em;
    }

    .panel-title p {
      color: var(--text-secondary);
      font-size: 15px;
      max-width: 500px;
      line-height: 1.5;
    }

    /* === Cards === */
    .card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 24px;
      transition: all 0.3s var(--ease);
      position: relative;
      overflow: hidden;
    }

    .text-truncate {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 200px;
      display: inline-block;
      vertical-align: bottom;
    }

    .card:hover {
      border-color: var(--border-highlight);
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0, 0, 0, 0.06);
    }

    /* === Dashboard Hero === */
    .dashboard-hero {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 60px 0 80px;
      position: relative;
    }

    .status-ring-container {
      position: relative;
      width: 140px;
      height: 140px;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-bottom: 32px;
    }

    .status-ring-bg {
      position: absolute;
      inset: 0;
      border-radius: 50%;
      border: 1px solid var(--border-subtle);
    }

    #proxy-toggle {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      background: #fff;
      color: var(--text-primary);
      border: 1px solid var(--border-subtle);
      font-size: 32px;
      cursor: pointer;
      transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    #proxy-toggle:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
      border-color: var(--text-secondary);
    }

    #proxy-toggle:active {
      transform: scale(0.95);
    }

    #proxy-toggle.active {
      background: var(--success);
      color: #fff;
      border-color: var(--success);
      box-shadow: 0 10px 30px rgba(22, 163, 74, 0.3);
    }

    .hero-status-text {
      text-align: center;
    }

    #proxy-status {
      font-size: 28px;
      font-weight: 600;
      color: var(--text-primary);
      margin-bottom: 8px;
      letter-spacing: -0.03em;
    }

    #proxy-status-desc {
      font-size: 15px;
      color: var(--text-tertiary);
    }

    /* === Current Node Pill === */
    .current-node-pill {
      margin-top: 32px;
      background: #fff;
      border: 1px solid var(--border-subtle);
      padding: 10px 20px 10px 14px;
      border-radius: 99px;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 14px;
      color: var(--text-secondary);
      transition: 0.2s;
      cursor: default;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.02);
    }

    .current-node-pill:hover {
      border-color: var(--text-tertiary);
      color: var(--text-primary);
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }

    .node-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border-highlight);
    }

    .node-dot.active {
      background: var(--success);
      box-shadow: 0 0 0 3px rgba(22, 163, 74, 0.1);
    }

    /* === Metrics Grid === */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }

    .metric-card {
      background: #fff;
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      transition: 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.02);
    }

    .metric-card:hover {
      border-color: var(--border-highlight);
      transform: translateY(-2px);
      box-shadow: 0 12px 24px rgba(0, 0, 0, 0.06);
    }

    .metric-label {
      font-size: 12px;
      color: var(--text-tertiary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .metric-value {
      font-size: 20px;
      font-weight: 500;
      color: var(--text-primary);
      font-family: var(--font-mono);
    }

    /* === Node Info === */
    .info-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0;
      border-bottom: 1px solid var(--border-subtle);
    }

    .info-row:last-child {
      border-bottom: none;
    }

    .info-label {
      color: var(--text-secondary);
      font-size: 13px;
    }

    .info-value {
      color: var(--text-primary);
      font-family: var(--font-mono);
      font-size: 13px;
    }

    /* === Node Grid ===* Node Grid & Cards */
    .node-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      padding-bottom: 24px;
    }

    .node-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 16px;
      padding: 20px;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      position: relative;
      overflow: hidden;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      gap: 16px;
      will-change: transform;
    }

    .node-card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-lg);
      border-color: var(--primary-color);
    }

    .node-card.active-node {
      border-width: 2px;
      border-color: var(--primary-color);
      background: linear-gradient(145deg, var(--card-bg) 0%, rgba(0, 0, 0, 0.02) 100%);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.08), 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .node-card-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .node-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .node-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.4;
    }

    .node-meta {
      font-size: 12px;
      color: var(--text-tertiary);
      font-family: 'SF Mono', 'JetBrains Mono', monospace;
    }

    .node-protocol-badge {
      font-size: 10px;
      padding: 2px 8px;
      border-radius: 12px;
      background: var(--bg-secondary);
      color: var(--text-secondary);
      text-transform: uppercase;
      font-weight: 600;
      letter-spacing: 0.5px;
      border: 1px solid var(--border-color);
    }

    .node-metrics-row {
      display: flex;
      gap: 16px;
      padding-top: 12px;
      border-top: 1px solid var(--border-color);
    }

    .node-metric {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 12px;
      color: var(--text-secondary);
      cursor: pointer;
      transition: color 0.2s;
    }

    .node-metric:hover {
      color: var(--primary-color);
    }

    .node-metric svg {
      opacity: 0.6;
    }

    .node-metric-value {
      font-family: 'SF Mono', 'JetBrains Mono', monospace;
      font-weight: 500;
    }

    .node-metric-value.good {
      color: #10b981;
    }

    .node-metric-value.fair {
      color: #f59e0b;
    }

    .node-metric-value.poor {
      color: #ef4444;
    }

    .node-actions-overlay {
      position: absolute;
      top: 16px;
      right: 16px;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s;
    }

    .node-card:hover .node-actions-overlay {
      opacity: 1;
      pointer-events: auto;
    }

    .node-delete-btn {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.2s;
      padding: 0;
    }

    .node-delete-btn svg {
      width: 18px;
      height: 18px;
      stroke: currentColor;
    }

    .node-delete-btn:hover {
      background: #ef4444;
      color: white;
      transform: scale(1.05);
    }

    /* === Buttons & Inputs === */
    button {
      font-size: 13px;
      font-weight: 500;
      padding: 8px 16px;
      background: transparent;
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: var(--ease);
    }

    button:hover {
      background: var(--bg-card-hover);
      border-color: var(--text-secondary);
    }

    button.primary {
      background: var(--text-primary);
      color: #fff;
      border-color: var(--text-primary);
      font-weight: 600;
    }

    button.primary:hover {
      opacity: 0.9;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
      transform: translateY(-1px);
    }

    input,
    select,
    textarea {
      background: #fff;
      border: 1px solid var(--border-subtle);
      color: var(--text-primary);
      padding: 12px 16px;
      font-size: 14px;
      width: 100%;
      border-radius: var(--radius-sm);
      outline: none;
      transition: var(--ease);
      font-family: var(--font-mono);
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--text-secondary);
      box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05);
    }

    /* === Tables === */
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
    }

    th {
      text-align: left;
      color: var(--text-tertiary);
      font-weight: 500;
      padding: 16px;
      border-bottom: 1px solid var(--border-subtle);
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.05em;
    }

    td {
      padding: 16px;
      border-bottom: 1px solid var(--border-subtle);
      color: var(--text-secondary);
    }

    tr:hover td {
      background: var(--bg-card-hover);
      color: var(--text-primary);
    }

    /* === Modal === */
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(8px);
      z-index: 200;
      align-items: center;
      justify-content: center;
    }

    .modal.open {
      display: flex;
    }

    .modal-content {
      background: #fff;
      border: 1px solid var(--border-subtle);
      padding: 40px;
      width: 520px;
      border-radius: var(--radius-lg);
      box-shadow: 0 40px 80px rgba(0, 0, 0, 0.1);
      position: relative;
    }

    .modal-backdrop {
      position: absolute;
      inset: 0;
      z-index: -1;
    }

    /* === Toggle Switch === */
    .toggle-switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 22px;
      cursor: pointer;
    }

    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .toggle-slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      transition: var(--ease);
      border-radius: 22px;
    }

    .toggle-slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: var(--text-tertiary);
      transition: var(--ease);
      border-radius: 50%;
    }

    .toggle-switch input:checked+.toggle-slider {
      background-color: var(--success);
      border-color: var(--success);
    }

    .toggle-switch input:checked+.toggle-slider:before {
      background-color: white;
      transform: translateX(18px);
    }

    .toggle-switch input:disabled+.toggle-slider {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* === Switch (Alias for toggle-switch) === */
    .switch {
      position: relative;
      display: inline-block;
      width: 40px;
      height: 22px;
      cursor: pointer;
    }

    .switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }

    .slider {
      position: absolute;
      cursor: pointer;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background-color: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      transition: var(--ease);
      border-radius: 22px;
    }

    .slider:before {
      position: absolute;
      content: "";
      height: 16px;
      width: 16px;
      left: 2px;
      bottom: 2px;
      background-color: var(--text-tertiary);
      transition: var(--ease);
      border-radius: 50%;
    }

    .switch input:checked+.slider {
      background-color: var(--success);
      border-color: var(--success);
    }

    .switch input:checked+.slider:before {
      background-color: white;
      transform: translateX(18px);
    }

    .switch input:disabled+.slider {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* === Progress Bar === */
    .install-progress {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: var(--bg-secondary);
      border-radius: 3px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--success), #4ade80);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 11px;
      color: var(--text-secondary);
    }

    /* === Icons === */
    .icon {
      display: inline-block;
      width: 1em;
      height: 1em;
      stroke-width: 2;
      stroke: currentColor;
      fill: none;
    }

    /* === Toolbar === */
    .node-toolbar {
      display: flex;
      gap: 12px;
      margin-bottom: 32px;
      align-items: center;
    }

    .node-tabs {
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding-bottom: 4px;
      flex: 1;
    }

    .node-tab {
      padding: 6px 16px;
      border-radius: 99px;
      font-size: 12px;
      white-space: nowrap;
      cursor: pointer;
      color: var(--text-secondary);
      background: #f5f5f5;
      border: 1px solid transparent;
      transition: 0.2s;
    }

    .node-tab:hover {
      background: #e5e5e5;
      color: var(--text-primary);
    }

    .node-tab.active {
      background: var(--text-primary);
      color: #fff;
      font-weight: 600;
    }

    .add-node-button {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: var(--text-primary);
      color: #fff;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      transition: 0.2s;
    }

    .add-node-button:hover {
      transform: scale(1.1);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    /* Form Grid */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
    }

    .form-grid label {
      display: flex;
      flex-direction: column;
      gap: 8px;
      font-size: 13px;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .form-actions {
      grid-column: 1 / -1;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 16px;
    }

    /* Settings Navigation */
    .settings-nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      background: transparent;
      border: none;
      border-radius: var(--radius-md);
      color: var(--text-secondary);
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: left;
    }

    .settings-nav-item:hover {
      background: var(--bg-secondary);
      color: var(--text-primary);
    }

    .settings-nav-item.active {
      background: var(--accent);
      color: var(--bg-root);
    }

    .settings-nav-item svg {
      flex-shrink: 0;
    }

    .settings-content {
      display: none;
    }

    .settings-content.active {
      display: block;
    }

    /* Core tab styles */
    .core-tab.active {
      border-bottom-color: var(--primary) !important;
      color: var(--text-primary) !important;
    }

    .core-content {
      display: none;
    }

    .core-content.active {
      display: block;
    }

    /* Custom Scrollbar */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(0, 0, 0, 0.15);
      border-radius: 4px;
      transition: background 0.2s ease;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(0, 0, 0, 0.25);
    }

    ::-webkit-scrollbar-thumb:active {
      background: rgba(0, 0, 0, 0.35);
    }

    /* Firefox */
    * {
      scrollbar-width: thin;
      scrollbar-color: rgba(0, 0, 0, 0.15) transparent;
    }
  </style>
</head>

<body>
  <!-- Titlebar -->
  <div class="titlebar">
    <div class="titlebar-title">
      <div class="logo-dot"></div>
      Vea
    </div>
    <div class="titlebar-controls">
      <div class="window-ctrl" id="minimize-btn"></div>
      <div class="window-ctrl" id="maximize-btn"></div>
      <div class="window-ctrl close" id="close-btn"></div>
    </div>
  </div>

  <!-- Sidebar -->
  <aside class="sidebar" id="menu">
    <div class="sidebar-section-title">主要</div>
    <button class="nav-item active" data-target="panel-home">
      <svg viewBox="0 0 24 24">
        <rect x="3" y="3" width="7" height="7"></rect>
        <rect x="14" y="3" width="7" height="7"></rect>
        <rect x="14" y="14" width="7" height="7"></rect>
        <rect x="3" y="14" width="7" height="7"></rect>
      </svg>
      控制台
    </button>
    <button class="nav-item" data-target="panel1">
      <svg viewBox="0 0 24 24">
        <path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"></path>
      </svg>
      节点
    </button>
    <button class="nav-item" data-target="panel2">
      <svg viewBox="0 0 24 24">
        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
        <polyline points="14 2 14 8 20 8"></polyline>
        <line x1="16" y1="13" x2="8" y2="13"></line>
        <line x1="16" y1="17" x2="8" y2="17"></line>
        <polyline points="10 9 9 9 8 9"></polyline>
      </svg>
      订阅
    </button>

    <div class="sidebar-section-title" style="margin-top: 24px;">系统</div>
    <button class="nav-item" data-target="panel4">
      <svg viewBox="0 0 24 24">
        <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
      </svg>
      流量规则
    </button>
    <button class="nav-item" data-target="panel3">
      <svg viewBox="0 0 24 24">
        <path
          d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
        </path>
        <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
        <line x1="12" y1="22.08" x2="12" y2="12"></line>
      </svg>
      组件
    </button>
    <div style="flex:1"></div>
    <button class="nav-item" data-target="panel-settings">
      <svg viewBox="0 0 24 24">
        <circle cx="12" cy="12" r="3"></circle>
        <path
          d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
        </path>
      </svg>
      设置
    </button>
  </aside>

  <!-- Main Content -->
  <main>
    <div id="status" class="status-bar"></div>

    <!-- Dashboard -->
    <section id="panel-home" class="panel active">
      <div class="dashboard-hero">
        <div class="status-ring-container">
          <div class="status-ring-bg"></div>
          <button id="proxy-toggle" data-mode="">
            <svg viewBox="0 0 24 24" width="32" height="32" stroke="currentColor" stroke-width="2.5" fill="none"
              stroke-linecap="round" stroke-linejoin="round">
              <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
              <line x1="12" y1="2" x2="12" y2="12"></line>
            </svg>
          </button>
        </div>
        <div class="hero-status-text">
          <div id="proxy-status">已停止</div>
          <div id="proxy-status-desc">点击启动代理即可启动核心并切换系统代理</div>
        </div>
        <div class="current-node-pill">
          <div class="node-dot"></div>
          <span id="home-node-name">选择节点</span>
          <span id="home-node-address" style="display:none; opacity:0.5; font-size:12px;"></span>
        </div>
      </div>

      <div class="metrics-grid">
        <div class="metric-card">
          <div class="metric-label">
            <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none">
              <path d="M22 12h-4l-3 9L9 3l-3 9H2"></path>
            </svg>
            延迟
          </div>
          <div class="metric-value" id="home-node-latency">--</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">
            <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none">
              <polyline points="17 1 21 5 17 9"></polyline>
              <path d="M3 11V9a4 4 0 0 1 4-4h14"></path>
              <polyline points="7 23 3 19 7 15"></polyline>
              <path d="M21 13v2a4 4 0 0 1-4 4H3"></path>
            </svg>
            带宽
          </div>
          <div class="metric-value" id="home-node-speed">--</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">
            <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="2" y1="12" x2="22" y2="12"></line>
              <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z">
              </path>
            </svg>
            协议
          </div>
          <div class="metric-value" id="home-node-protocol">--</div>
        </div>
        <div class="metric-card" id="tun-status-card">
          <div class="metric-label">
            <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none">
              <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
              <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
            </svg>
            TUN 模式
          </div>
          <div style="display:flex; align-items:center; gap:12px;">
            <div class="metric-value" id="tun-status-value" style="cursor:pointer;" title="点击查看详情">--</div>
            <label class="toggle-switch" title="启用/禁用 TUN 模式">
              <input type="checkbox" id="tun-toggle">
              <span class="toggle-slider"></span>
            </label>
          </div>
        </div>
        <div class="metric-card" id="ip-geo-card" style="grid-column: span 2;">
          <div class="metric-label">
            <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="2" y1="12" x2="22" y2="12"></line>
              <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z">
              </path>
            </svg>
            当前 IP
          </div>
          <div style="display:flex; align-items:center; gap:16px; flex-wrap:wrap;">
            <div class="metric-value" id="ip-geo-ip" style="font-family:var(--font-mono); font-size:15px;">--</div>
            <div id="ip-geo-location" style="font-size:12px; color:var(--text-secondary);">--</div>
            <button id="ip-geo-refresh"
              style="padding:4px 8px; font-size:11px; background:var(--bg-secondary); border:1px solid var(--border-subtle); border-radius:4px; color:var(--text-secondary); cursor:pointer;">
              <svg viewBox="0 0 24 24" width="12" height="12" stroke="currentColor" stroke-width="2" fill="none"
                style="vertical-align:middle;">
                <polyline points="23 4 23 10 17 10"></polyline>
                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </section>
    <!-- Nodes -->
    <section id="panel1" class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <h2>节点</h2>
          <p>管理和监控你的网络端点。</p>
        </div>
        <div class="panel-actions">
          <span id="xray-state" style="font-size:12px; color:var(--text-secondary); margin-right:16px;">核心：
            未知</span>
          <button id="node-refresh">刷新</button>
        </div>
      </div>

      <div class="node-toolbar">
        <div id="node-tabs" class="node-tabs"></div>
        <button id="node-bulk-ping">全部测延迟</button>
        <button id="node-bulk-speed">全部测速</button>
        <button class="add-node-button" id="node-add-button">+</button>
      </div>
      <div id="node-grid" class="node-grid">
        <div class="card" style="text-align:center; color:var(--text-secondary);">暂无节点</div>
      </div>
    </section>

    <!-- Configs -->
    <section id="panel2" class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <h2>订阅</h2>
          <p>管理订阅源和更新间隔。</p>
        </div>
        <div class="panel-actions">
          <button id="config-add-button" class="primary">添加订阅源</button>
          <button id="config-refresh">同步</button>
        </div>
      </div>
      <div class="card" style="padding:0;">
        <table id="config-table">
          <thead>
            <tr>
              <th>名称</th>
              <th>格式</th>
              <th>更新间隔</th>
              <th>最后同步</th>
              <th>状态</th>
              <th style="text-align:right">操作</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Components -->
    <section id="panel3" class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <h2>组件</h2>
          <p>核心系统依赖和版本。</p>
        </div>
        <div class="panel-actions">
          <button id="component-refresh">检查更新</button>
        </div>
      </div>
      <div class="card" style="padding:0;">
        <table id="component-table">
          <thead>
            <tr>
              <th>名称</th>
              <th>类型</th>
              <th>版本</th>
              <th>路径</th>
              <th>日期</th>
              <th>状态</th>
              <th style="text-align:right">操作</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </section>

    <!-- Traffic -->
    <section id="panel4" class="panel">
      <div class="panel-header" style="margin-bottom: 24px;">
        <div class="panel-title">
          <h2>流量规则</h2>
          <p>配置路由 policies and DNS settings.</p>
        </div>
        <div class="panel-actions">
          <button id="traffic-refresh">重新加载</button>
        </div>
      </div>

      <div class="node-toolbar" style="margin-bottom: 24px;">
        <div class="node-tabs" id="traffic-tabs">
          <div class="node-tab active" data-tab="global">全局设置</div>
          <div class="node-tab" data-tab="rules">路由规则</div>
        </div>
      </div>

      <div id="traffic-content-global">
        <form id="profile-form" class="card form-grid">
          <h3 style="grid-column:1/-1; font-size:14px; color:var(--text-primary);">Global Policy</h3>
          <label><span>Default Exit Node</span><input name="defaultNodeId" type="text" placeholder="UUID"></label>
          <label><span>DNS Strategy</span>
            <select name="dnsStrategy">
              <option value="">Auto</option>
              <option value="ipv4_only">IPv4 Only</option>
              <option value="ipv6_only">IPv6 Only</option>
            </select>
          </label>
          <label style="grid-column:1/-1"><span>DNS Servers</span><textarea name="dnsServers"
              placeholder="8.8.8.8"></textarea></label>
          <div class="form-actions"><button type="submit" class="primary">Apply Policy</button></div>
        </form>
      </div>

      <div id="traffic-content-rules" style="display: none;">
        <div style="margin-bottom: 16px; display: flex; justify-content: flex-end;">
          <button id="rule-add-button" class="primary">添加规则</button>
        </div>

        <div class="card" style="padding:0;">
          <table id="rule-table">
            <thead>
              <tr>
                <th>Name</th>
                <th>Exit</th>
                <th>Match</th>
                <th>Priority</th>
                <th>Updated</th>
                <th style="text-align:right">Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- Settings -->
    <section id="panel-settings" class="panel">
      <div class="panel-header">
        <div class="panel-title">
          <h2>设置</h2>
          <p>Application preferences and configurations.</p>
        </div>
        <div class="panel-actions">
          <button id="settings-import-btn">导入设置</button>
          <button id="settings-export-btn">导出设置</button>
          <button id="settings-reset-btn">恢复默认</button>
        </div>
      </div>

      <div style="display:flex; gap:24px;">
        <!-- 左侧导航 -->
        <div class="settings-nav" style="flex:0 0 200px; display:flex; flex-direction:column; gap:4px;">
          <button class="settings-nav-item active" data-settings-tab="general">
            <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M12 1v6m0 6v6m9-9h-6m-6 0H3m15.4 6.4l-4.2-4.2m-6 0L3.6 7.6m12.8 12.8l-4.2-4.2m-6 0l-4.6 4.6">
              </path>
            </svg>
            外观
          </button>
          <button class="settings-nav-item" data-settings-tab="proxy">
            <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none">
              <circle cx="12" cy="12" r="10"></circle>
              <line x1="2" y1="12" x2="22" y2="12"></line>
              <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z">
              </path>
            </svg>
            系统代理
          </button>
          <button class="settings-nav-item" data-settings-tab="network">
            <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none">
              <rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect>
              <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path>
            </svg>
            TUN
          </button>
          <button class="settings-nav-item" data-settings-tab="singbox">
            <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none">
              <path
                d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z">
              </path>
            </svg>
            sing-box
          </button>
          <button class="settings-nav-item" data-settings-tab="xray">
            <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none">
              <polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"></polygon>
            </svg>
            Xray
          </button>
          <button class="settings-nav-item" data-settings-tab="advanced">
            <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none">
              <circle cx="12" cy="12" r="3"></circle>
              <path
                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z">
              </path>
            </svg>
            高级
          </button>
        </div>

        <!-- 右侧内容区 -->
        <div style="flex:1; min-width:0;">
          <!-- 外观设置 -->
          <div class="settings-content active" id="settings-general"></div>

          <!-- 系统代理设置 -->
          <div class="settings-content" id="settings-proxy" style="display:none;"></div>

          <!-- TUN 设置 -->
          <div class="settings-content" id="settings-network" style="display:none;"></div>

          <!-- sing-box 设置 -->
          <div class="settings-content" id="settings-singbox" style="display:none;"></div>

          <!-- Xray 设置 -->
          <div class="settings-content" id="settings-xray" style="display:none;"></div>

          <!-- 高级设置 -->
          <div class="settings-content" id="settings-advanced" style="display:none;"></div>
        </div>
      </div>
    </section>
  </main>

  <!-- Modals -->
  <div id="node-modal" class="modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content"
      style="max-width: 900px; max-height: 90vh; overflow-y: auto; transform: scale(0.95); transform-origin: center;">
      <button id="node-modal-close" class="modal-close"
        style="position:absolute; top:24px; right:24px; background:none; border:none; color:var(--text-secondary); font-size:20px; cursor:pointer;">×</button>
      <form id="node-form" class="form-grid">
        <h3 style="grid-column:1/-1; margin-bottom:16px; font-size:18px; font-weight:600; color:var(--text-primary);">
          添加节点</h3>

        <!-- Import Link Section -->
        <label style="grid-column:1/-1"><span>导入链接</span><input name="shareLink" type="text"
            placeholder="vmess://... 或 ss://... 等分享链接"></label>
        <div style="grid-column:1/-1; text-align:center; font-size:12px; color:var(--text-tertiary); margin: 8px 0;">
          — 或手动配置 —</div>

        <!-- Basic Settings -->
        <div
          style="grid-column:1/-1; font-weight:600; font-size:14px; color:var(--text-primary); margin-top:12px; padding-bottom:8px; border-bottom:1px solid var(--border-color);">
          基本设置</div>
        <label><span>节点名称 *</span><input name="name" type="text" placeholder="例如: 香港节点01"></label>
        <label><span>服务器地址 *</span><input name="address" type="text" placeholder="example.com 或 IP"></label>
        <label><span>端口 *</span><input name="port" type="number" placeholder="443"></label>
        <label>
          <span>协议 *</span>
          <select name="protocol" id="protocol-select">
            <option value="">选择协议</option>
            <option value="shadowsocks">Shadowsocks</option>
            <option value="vmess">VMess</option>
            <option value="vless">VLESS</option>
            <option value="trojan">Trojan</option>
            <option value="http">HTTP</option>
            <option value="socks5">SOCKS5</option>
          </select>
        </label>

        <!-- Shadowsocks Specific -->
        <div id="ss-fields"
          style="display:none; grid-column:1/-1; display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <label>
            <span>加密方式</span>
            <select name="ss_method">
              <option value="aes-256-gcm">aes-256-gcm</option>
              <option value="aes-128-gcm">aes-128-gcm</option>
              <option value="chacha20-ietf-poly1305">chacha20-ietf-poly1305</option>
              <option value="2022-blake3-aes-256-gcm">2022-blake3-aes-256-gcm</option>
              <option value="2022-blake3-aes-128-gcm">2022-blake3-aes-128-gcm</option>
            </select>
          </label>
          <label><span>密码</span><input name="ss_password" type="text" placeholder="密码"></label>
        </div>

        <!-- VMess/VLESS Specific -->
        <div id="vmess-fields"
          style="display:none; grid-column:1/-1; display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <label><span>UUID</span><input name="vmess_uuid" type="text"
              placeholder="xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"></label>
          <label>
            <span>AlterID (VMess)</span>
            <input name="vmess_alterid" type="number" value="0" placeholder="0">
          </label>
          <label>
            <span>加密方式</span>
            <select name="vmess_security">
              <option value="auto">auto</option>
              <option value="aes-128-gcm">aes-128-gcm</option>
              <option value="chacha20-poly1305">chacha20-poly1305</option>
              <option value="none">none</option>
            </select>
          </label>
          <label>
            <span>流控 (VLESS)</span>
            <select name="vless_flow">
              <option value="">无</option>
              <option value="xtls-rprx-vision">xtls-rprx-vision</option>
              <option value="xtls-rprx-vision-udp443">xtls-rprx-vision-udp443</option>
            </select>
          </label>
        </div>

        <!-- Trojan Specific -->
        <div id="trojan-fields" style="display:none; grid-column:1/-1;">
          <label><span>密码</span><input name="trojan_password" type="text" placeholder="密码"></label>
        </div>

        <!-- HTTP/SOCKS5 Specific -->
        <div id="proxy-fields"
          style="display:none; grid-column:1/-1; display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <label><span>用户名</span><input name="proxy_username" type="text" placeholder="可选"></label>
          <label><span>密码</span><input name="proxy_password" type="text" placeholder="可选"></label>
        </div>

        <!-- Network Settings -->
        <div
          style="grid-column:1/-1; font-weight:600; font-size:14px; color:var(--text-primary); margin-top:16px; padding-bottom:8px; border-bottom:1px solid var(--border-color);">
          传输设置</div>
        <label>
          <span>传输协议</span>
          <select name="network" id="network-select">
            <option value="tcp">TCP</option>
            <option value="ws">WebSocket</option>
            <option value="h2">HTTP/2</option>
            <option value="grpc">gRPC</option>
            <option value="quic">QUIC</option>
          </select>
        </label>
        <label>
          <span>TLS</span>
          <select name="tls">
            <option value="">不启用</option>
            <option value="tls">TLS</option>
            <option value="xtls">XTLS</option>
          </select>
        </label>

        <!-- WebSocket Settings -->
        <div id="ws-fields"
          style="display:none; grid-column:1/-1; display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <label style="grid-column:1/-1"><span>WebSocket 路径</span><input name="ws_path" type="text"
              placeholder="/path"></label>
          <label style="grid-column:1/-1"><span>Host</span><input name="ws_host" type="text"
              placeholder="example.com"></label>
        </div>

        <!-- HTTP/2 Settings -->
        <div id="h2-fields"
          style="display:none; grid-column:1/-1; display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <label style="grid-column:1/-1"><span>HTTP/2 路径</span><input name="h2_path" type="text"
              placeholder="/path"></label>
          <label style="grid-column:1/-1"><span>Host</span><input name="h2_host" type="text"
              placeholder="example.com"></label>
        </div>

        <!-- gRPC Settings -->
        <div id="grpc-fields" style="display:none; grid-column:1/-1;">
          <label><span>gRPC ServiceName</span><input name="grpc_service" type="text" placeholder="ServiceName"></label>
        </div>

        <!-- TLS Settings -->
        <div id="tls-fields"
          style="display:none; grid-column:1/-1; display:grid; grid-template-columns:1fr 1fr; gap:16px;">
          <label style="grid-column:1/-1"><span>SNI</span><input name="tls_sni" type="text"
              placeholder="留空使用服务器地址"></label>
          <label style="grid-column:1/-1"><span>指纹 (Fingerprint)</span>
            <select name="tls_fingerprint">
              <option value="">不设置</option>
              <option value="chrome">Chrome</option>
              <option value="firefox">Firefox</option>
              <option value="safari">Safari</option>
              <option value="edge">Edge</option>
              <option value="random">随机</option>
            </select>
          </label>
        </div>

        <!-- Other Settings -->
        <div
          style="grid-column:1/-1; font-weight:600; font-size:14px; color:var(--text-primary); margin-top:16px; padding-bottom:8px; border-bottom:1px solid var(--border-color);">
          其他设置</div>
        <label style="grid-column:1/-1"><span>标签</span><input name="tags" type="text"
            placeholder="多个标签用逗号分隔, 例如: 香港,IPLC,游戏"></label>
        <label style="grid-column:1/-1"><span>备注</span><textarea name="remarks" rows="2"
            placeholder="可选备注信息"></textarea></label>

        <div class="form-actions">
          <button type="button" id="node-modal-reset">重置</button>
          <button type="submit" class="primary">保存节点</button>
        </div>
      </form>
    </div>
  </div>

  <div id="config-modal" class="modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <button id="config-modal-close" class="modal-close"
        style="position:absolute; top:24px; right:24px; background:none; border:none; color:var(--text-secondary); font-size:20px; cursor:pointer;">×</button>
      <form id="config-form" class="form-grid">
        <h3 style="grid-column:1/-1; margin-bottom:16px; font-size:18px; font-weight:600; color:var(--text-primary);">
          Add Subscription</h3>
        <label><span>Name</span><input name="name" type="text" required placeholder="e.g. My Server"></label>
        <label style="grid-column:1/-1"><span>Source URL</span><input name="sourceUrl" type="url" required
            placeholder="https://..."></label>
        <label><span>Update Interval (min)</span><input name="autoUpdateInterval" type="number" value="60"></label>
        <label style="grid-column:1/-1"><span>JSON Configuration (Optional)</span><textarea name="payload"
            style="height:80px;"></textarea></label>
        <div class="form-actions">
          <button type="button" id="config-modal-reset">重置</button>
          <button type="submit" class="primary">Save Source</button>
        </div>
      </form>
    </div>
  </div>

  <div id="rule-modal" class="modal">
    <div class="modal-backdrop"></div>
    <div class="modal-content">
      <button id="rule-modal-close" class="modal-close"
        style="position:absolute; top:24px; right:24px; background:none; border:none; color:var(--text-secondary); font-size:20px; cursor:pointer;">×</button>
      <form id="rule-form" class="form-grid">
        <h3 style="grid-column:1/-1; margin-bottom:16px; font-size:18px; font-weight:600; color:var(--text-primary);">
          Add Routing Rule</h3>
        <label><span>Rule Name</span><input name="name" type="text" required></label>
        <label><span>Priority</span><input name="priority" type="number" value="10"></label>
        <label style="grid-column:1/-1"><span>Targets (Domain/IP)</span><textarea name="targets" required
            placeholder="domain.com"></textarea></label>
        <label style="grid-column:1/-1"><span>Exit Node ID</span><input name="nodeId" type="text" required></label>
        <div class="form-actions">
          <button type="button" id="rule-modal-reset">重置</button>
          <button type="submit" class="primary">添加规则</button>
        </div>
      </form>
    </div>
  </div>

  <script src="../settings-schema.js"></script>
  <script type="module">
    import { createAPI, utils } from '../sdk/dist/vea-sdk.esm.js';
    const { formatTime, formatBytes, formatInterval, escapeHtml, parseNumber, parseList, sleep } = utils;

    (function () {
      const menu = document.getElementById("menu");
      const panels = document.querySelectorAll(".panel");
      const statusBar = document.getElementById("status");
      let currentPanel = "panel-home";
      let statusTimer = null;

      const api = createAPI('');

      function showStatus(message, type = "info", delay = 3200) {
        if (!message) {
          statusBar.classList.remove("visible", "success", "error", "info");
          statusBar.textContent = "";
          return;
        }
        statusBar.textContent = message;
        statusBar.classList.remove("success", "error", "info");
        statusBar.classList.add("visible", type);
        if (statusTimer) {
          clearTimeout(statusTimer);
        }
        if (delay > 0) {
          statusTimer = setTimeout(() => {
            statusBar.classList.remove("visible");
          }, delay);
        }
      }

      const SYSTEM_PROXY_DEFAULTS = ["localhost", "127.0.0.0/8", "::1"];
      let systemProxySettings = {
        enabled: false,
        ignoreHosts: [...SYSTEM_PROXY_DEFAULTS],
      };
      const HOME_PING_COOLDOWN = 60000;
      const HOME_SPEEDTEST_COOLDOWN = 60000;
      const homePingState = {
        running: false,
        lastNodeId: "",
        lastTriggeredAt: 0,
      };
      const homeSpeedtestState = {
        running: false,
        lastNodeId: "",
        lastTriggeredAt: 0,
      };
      let nodeTags = [];
      let currentNodeTab = "全部";

      let xrayStatus = {
        enabled: false,
        running: false,
        activeNodeId: "",
        binary: "",
      };
      let nodesCache = [];
      let componentsCache = [];
      let lastSelectedNodeId = "";
      let preferredNodeId = "";
      let nodesPollHandle = null;
      const NODES_POLL_INTERVAL = 1000;

      function ensureNodesPolling() {
        if (nodesPollHandle) {
          return;
        }
        nodesPollHandle = setInterval(() => {
          loadNodes();
        }, NODES_POLL_INTERVAL);
      }

      async function refreshXrayStatus({ notify = false } = {}) {
        try {
          const status = await api.proxy.status();
          updateXrayUI(status);
          if (typeof updateHomeNodeStatus === 'function') {
            updateHomeNodeStatus();
          }

          if (notify && status.running) {
            showStatus("代理已启动", "success");
          }
        } catch (err) {
          console.error("Failed to refresh status:", err);
          if (notify) {
            showStatus(`加载状态失败：${err.message}`, "error");
          }
        }
      }

      function updateXrayUI(status = {}) {
        if (!status || typeof status !== "object") {
          status = {};
        }
        const indicator = document.getElementById("xray-state");
        const proxyStatus = document.getElementById("proxy-status");
        const proxyDesc = document.getElementById("proxy-status-desc");
        const proxyToggle = document.getElementById("proxy-toggle");

        const isRunning = Boolean(status.running);

        // Update core status indicator
        if (indicator) {
          indicator.className = isRunning ? "badge active" : "badge";
          indicator.textContent = isRunning ? "运行中" : "已停止";
        }

        // Update proxy toggle button (只更新类和模式，不修改图标)
        if (proxyToggle) {
          if (isRunning) {
            proxyToggle.dataset.mode = "stop";
            proxyToggle.classList.add("active");
          } else {
            proxyToggle.dataset.mode = "start";
            proxyToggle.classList.remove("active");
          }
        }

        // Update status text
        if (proxyStatus) {
          proxyStatus.textContent = isRunning ? "运行中" : "已停止";
        }
        if (proxyDesc) {
          proxyDesc.textContent = isRunning ? "代理服务正在运行" : "点击启动代理即可开始使用";
        }
      }

      // TUN status management
      let tunStatusCache = null;

      async function checkTUNStatus({ notify = false } = {}) {
        try {
          const status = await api.get("/tun/check");
          tunStatusCache = status || {};
          updateTUNUI(tunStatusCache);
          if (notify) {
            const text = status.configured
              ? `TUN 模式已配置 (${status.platform})`
              : `TUN 模式未配置 (${status.platform})`;
            showStatus(text, status.configured ? "success" : "info");
          }
        } catch (err) {
          tunStatusCache = { configured: false, error: err.message };
          updateTUNUI(tunStatusCache);
          if (notify) {
            showStatus(`检查 TUN 状态失败：${err.message}`, "error", 6000);
          }
        }
      }

      // TUN Settings state
      let tunSettingsCache = null;

      async function loadTUNSettings() {
        try {
          const settings = await api.get("/settings/tun");
          tunSettingsCache = settings || { enabled: false };
          updateTUNToggle(tunSettingsCache);
        } catch (err) {
          console.error("Failed to load TUN settings:", err);
          tunSettingsCache = { enabled: false };
          updateTUNToggle(tunSettingsCache);
        }
      }

      // IP Geo info
      async function loadIPGeo() {
        const ipEl = document.getElementById("ip-geo-ip");
        const locEl = document.getElementById("ip-geo-location");
        if (!ipEl || !locEl) return;

        ipEl.textContent = "...";
        locEl.textContent = "正在获取";

        try {
          const data = await api.get("/ip/geo");
          if (data.error) {
            ipEl.textContent = "--";
            locEl.textContent = data.error;
            return;
          }
          ipEl.textContent = data.ip || "--";
          const loc = [data.location, data.isp].filter(Boolean).join(" | ");
          locEl.textContent = loc || "--";
        } catch (err) {
          ipEl.textContent = "--";
          locEl.textContent = "获取失败";
        }
      }

      // IP Geo refresh button
      const ipGeoRefreshBtn = document.getElementById("ip-geo-refresh");
      if (ipGeoRefreshBtn) {
        ipGeoRefreshBtn.addEventListener("click", () => {
          loadIPGeo();
        });
      }

      async function updateTUNSetting(enabled) {
        // 如果要启用 TUN，先检查是否已配置，未配置则自动配置
        if (enabled) {
          const configured = tunStatusCache && tunStatusCache.configured;
          if (!configured) {
            try {
              showStatus("正在配置 TUN 模式...", "info", 2000);
              await api.post("/tun/setup", {});
              showStatus("TUN 配置成功", "success", 2000);
              await checkTUNStatus(); // 刷新配置状态
            } catch (err) {
              updateTUNToggle(tunSettingsCache || { enabled: false });
              showStatus(`TUN 配置失败：${err.message}`, "error", 5000);
              return;
            }
          }
        }

        try {
          const updated = await api.put("/settings/tun", { enabled });
          tunSettingsCache = updated;
          updateTUNToggle(updated);
          showStatus(`TUN 模式已${enabled ? '启用' : '禁用'}`, "success", 2000);
        } catch (err) {
          showStatus(`更新 TUN 设置失败：${err.message}`, "error", 4000);
          // 恢复开关状态
          updateTUNToggle(tunSettingsCache || { enabled: false });
        }
      }

      function updateTUNToggle(settings) {
        const tunToggle = document.getElementById("tun-toggle");
        if (tunToggle) {
          tunToggle.checked = Boolean(settings.enabled);
          // 不再禁用开关，让用户点击时自动检测
        }
      }

      function updateTUNUI(status = {}) {
        const tunCard = document.getElementById("tun-status-card");
        const tunValue = document.getElementById("tun-status-value");

        if (!tunCard || !tunValue) return;

        const configured = Boolean(status.configured);
        const platform = status.platform || "unknown";

        if (status.error) {
          tunValue.textContent = "检查失败";
          tunValue.style.color = "var(--error)";
          tunCard.title = `错误：${status.error}`;
        } else if (configured) {
          tunValue.textContent = "已配置";
          tunValue.style.color = "var(--success)";
          tunCard.title = `TUN 模式已在 ${platform} 上配置`;
        } else {
          tunValue.textContent = "未配置";
          tunValue.style.color = "var(--warning)";
          const setupCmd = status.setupCommand || "查看文档";
          tunCard.title = `点击查看配置方法：${setupCmd}`;
        }

        // 更新设置面板中的 TUN 状态
        const tunConfigStatus = document.getElementById("tun-config-status");
        const tunSetupBtn = document.getElementById("tun-setup-btn");

        if (tunConfigStatus) {
          if (status.error) {
            tunConfigStatus.textContent = `检查失败: ${status.error}`;
            tunConfigStatus.style.color = "var(--error)";
          } else if (configured) {
            tunConfigStatus.textContent = `已配置 (${platform})`;
            tunConfigStatus.style.color = "var(--success)";
          } else {
            tunConfigStatus.textContent = `未配置 (${platform})`;
            tunConfigStatus.style.color = "var(--warning)";
          }
        }

        if (tunSetupBtn) {
          tunSetupBtn.style.display = (!configured && platform === "linux") ? "block" : "none";
        }
      }

      async function showTUNStatusDialog() {
        if (!tunStatusCache) {
          showStatus("正在检查 TUN 状态...", "info");
          checkTUNStatus({ notify: true });
          return;
        }

        const { configured, platform } = tunStatusCache;

        if (configured) {
          showStatus(`TUN 模式已在 ${platform} 上配置`, "success", 3000);
          return;
        }

        showStatus(`TUN 模式未配置，请以管理员权限运行 Vea`, "info", 5000);
      }

      // 配置 TUN - 直接调用 API
      async function setupTUN() {
        try {
          showStatus("正在配置 TUN 模式...", "info");
          await api.post("/tun/setup", {});
          showStatus("TUN 配置成功！", "success", 2000);
          await checkTUNStatus();
          // 配置成功后自动启用 TUN
          await updateTUNSetting(true);
        } catch (err) {
          showStatus(`TUN 配置失败：${err.message}`, "error", 5000);
        }
      }

      // Panel loaders
      let activeNodeId = "";

      async function loadNodes({ notify = false } = {}) {
        try {
          const payload = await api.get("/nodes");
          const nodes = Array.isArray(payload.nodes) ? payload.nodes : [];
          const serverActiveNodeId = typeof payload.activeNodeId === "string" ? payload.activeNodeId : "";
          const recentSelectedId = typeof payload.lastSelectedNodeId === "string" ? payload.lastSelectedNodeId : "";
          nodesCache = nodes;
          lastSelectedNodeId = recentSelectedId;

          // Try to restore from localStorage first
          const savedNodeId = localStorage.getItem("vea_selected_node_id");

          const hasNode = (id) => !!id && nodes.some((node) => node && node.id === id);

          // Priority: localStorage > recentSelectedId > serverActiveNodeId > first node
          if (savedNodeId && hasNode(savedNodeId)) {
            preferredNodeId = savedNodeId;
          } else if (hasNode(recentSelectedId)) {
            preferredNodeId = recentSelectedId;
          } else if (hasNode(serverActiveNodeId)) {
            preferredNodeId = serverActiveNodeId;
          } else if (nodes.length > 0 && nodes[0] && nodes[0].id) {
            preferredNodeId = nodes[0].id;
          } else {
            preferredNodeId = "";
          }

          activeNodeId = serverActiveNodeId || preferredNodeId;

          // Save to localStorage
          if (activeNodeId) {
            localStorage.setItem("vea_selected_node_id", activeNodeId);
          }

          updateNodeTabs(nodes);
          renderNodes(nodes, activeNodeId);
          updateHomeNodeStatus();
          refreshXrayStatus();
          if (notify) {
            showStatus("节点列表已刷新", "success");
          }
          if (currentPanel === "panel-home") {
            autoMeasureCurrentNode();
          }
        } catch (err) {
          showStatus(`加载节点失败：${err.message}`, "error", 6000);
          nodesCache = [];
          updateHomeNodeStatus();
        }
      }

      function updateNodeTabs(nodes) {
        if (!nodeTabs) return;
        const tags = new Set();
        nodes.forEach((node) => {
          if (Array.isArray(node.tags)) {
            node.tags.forEach((tag) => {
              const trimmed = String(tag || "").trim();
              if (trimmed) {
                tags.add(trimmed);
              }
            });
          }
        });
        const sorted = ["全部", ...Array.from(tags).sort((a, b) => a.localeCompare(b, "zh-Hans-CN"))];
        nodeTags = sorted;
        if (!nodeTags.includes(currentNodeTab)) {
          currentNodeTab = "全部";
        }
        nodeTabs.innerHTML = nodeTags
          .map((tag) => {
            const active = tag === currentNodeTab ? "active" : "";
          })
          .join("");
      }

      let lastRenderedNodesHash = "";

      function renderNodes(nodes, currentId = "") {
        if (!nodeGrid) return;
        let filtered = nodes;
        if (currentNodeTab !== "全部") {
          filtered = nodes.filter((node) => Array.isArray(node.tags) && node.tags.includes(currentNodeTab));
        }
        if (!Array.isArray(nodes) || nodes.length === 0) {
          nodeGrid.innerHTML = '<div class="empty-card">暂无节点</div>';
          lastRenderedNodesHash = "empty";
          return;
        }

        if (!Array.isArray(filtered) || filtered.length === 0) {
          nodeGrid.innerHTML = '<div class="empty-card">当前标签下暂无节点</div>';
          lastRenderedNodesHash = "empty-filtered";
          return;
        }

        // Create a hash of the current state to detect changes
        const stateHash = JSON.stringify(filtered.map(n => ({
          id: n.id,
          name: n.name,
          address: n.address,
          port: n.port,
          protocol: n.protocol,
          lastLatencyMs: n.lastLatencyMs,
          lastSpeedMbps: n.lastSpeedMbps,
          lastSpeedError: n.lastSpeedError
        }))) + currentId + currentNodeTab;

        // Only re-render if data has changed
        if (stateHash === lastRenderedNodesHash) {
          return;
        }
        lastRenderedNodesHash = stateHash;

        nodeGrid.innerHTML = filtered
          .map((node) => {
            const rowId = escapeHtml(node.id);
            const isActive = currentId && node.id === currentId;
            const protocol = escapeHtml(node.protocol || "unknown");

            // Latency formatting
            let latencyValue = "Ping";
            let latencyClass = "";
            if (typeof node.lastLatencyMs === "number" && node.lastLatencyMs > 0) {
              latencyValue = `${node.lastLatencyMs}ms`;
              if (node.lastLatencyMs < 100) latencyClass = "good";
              else if (node.lastLatencyMs < 300) latencyClass = "fair";
              else latencyClass = "poor";
            }

            // Speed formatting
            let speedValue = "Speed";
            let speedClass = "";
            if (node.lastSpeedError) {
              speedValue = "Error";
              speedClass = "poor";
            } else if (typeof node.lastSpeedMbps === "number" && node.lastSpeedMbps > 0) {
              const fixed = node.lastSpeedMbps >= 10 ? node.lastSpeedMbps.toFixed(1) : node.lastSpeedMbps.toFixed(2);
              speedValue = `${fixed} MB/s`;
              if (node.lastSpeedMbps > 5) speedClass = "good";
              else if (node.lastSpeedMbps > 1) speedClass = "fair";
              else speedClass = "poor";
            }

            return `
          <div class="node-card ${isActive ? "active-node" : ""}" data-id="${rowId}">
            <div class="node-card-header">
              <div class="node-info">
                <div class="node-name">${escapeHtml(node.name)}</div>
                <div class="node-meta">${escapeHtml(node.address)}:${escapeHtml(node.port)}</div>
              </div>
              <div class="node-protocol-badge">${protocol}</div>
            </div>

            <div class="node-metrics-row">
              <div class="node-metric" data-action="ping-node" title="Test Latency">
                <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><path d="M22 12h-4l-3 9L9 3l-3 9H2"></path></svg>
                <span class="node-metric-value ${latencyClass}">${latencyValue}</span>
              </div>
              <div class="node-metric" data-action="speed-node" title="Test Speed">
                <svg viewBox="0 0 24 24" width="14" height="14" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
                <span class="node-metric-value ${speedClass}">${speedValue}</span>
              </div>
            </div>

            <div class="node-actions-overlay">
              <button class="node-delete-btn" data-action="delete-node" title="Delete Node">
                <svg viewBox="0 0 24 24" width="16" height="16" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
              </button>
            </div>
          </div>
        `;
          })
          .join("");
      }

      async function loadConfigs({ notify = false } = {}) {
        try {
          const configs = await api.get("/configs");
          renderConfigs(configs);
          if (notify) {
            showStatus("配置列表已刷新", "success");
          }
        } catch (err) {
          showStatus(`加载配置失败：${err.message}`, "error", 6000);
        }
      }

      function renderConfigs(configs) {
        const tbody = document.querySelector("#config-table tbody");
        if (!Array.isArray(configs) || configs.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty">暂无配置</td></tr>';
          return;
        }
        tbody.innerHTML = configs
          .map((cfg) => {
            const syncState = cfg.lastSyncError
              ? `<span class="badge error">失败：${escapeHtml(cfg.lastSyncError)}</span>`
              : '<span class="badge">正常</span>';
            const source = cfg.sourceUrl ? `<br /><div class="muted text-truncate" title="${escapeHtml(cfg.sourceUrl)}">${escapeHtml(cfg.sourceUrl)}</div>` : "";
            return `
          <tr data-id="${escapeHtml(cfg.id)}">
            <td>${escapeHtml(cfg.name)}${source}</td>
            <td><span class="badge">${escapeHtml(cfg.format)}</span></td>
            <td>${formatInterval(cfg.autoUpdateInterval)}</td>
            <td>${formatTime(cfg.lastSyncedAt)}</td>
            <td>${syncState}</td>
            <td>
              <button class="ghost" data-action="pull-nodes">拉取节点</button>
              <button class="ghost" data-action="refresh-config">刷新</button>
              <button class="danger" data-action="delete-config">删除</button>
            </td>
          </tr>
        `;
          })
          .join("");
      }

      function renderSystemProxy(settings) {
        if (!systemProxyIgnoreInput) return;
        const hosts = Array.isArray(settings.ignoreHosts) ? settings.ignoreHosts : [];
        systemProxyIgnoreInput.value = hosts.join("\n");
      }

      async function loadSystemProxySettings({ notify = false } = {}) {
        if (!systemProxyIgnoreInput) return;
        try {
          const payload = await api.get("/settings/system-proxy");
          const data = payload && payload.settings ? payload.settings : payload;
          systemProxySettings = {
            enabled: Boolean(data.enabled),
            ignoreHosts: Array.isArray(data.ignoreHosts) ? data.ignoreHosts : [...SYSTEM_PROXY_DEFAULTS],
          };
          renderSystemProxy(systemProxySettings);
          updateXrayUI(xrayStatus);
          if (notify) {
            const msg = payload && payload.message ? payload.message : "系统代理设置已刷新";
            showStatus(msg, payload && payload.message ? "info" : "success");
          }
        } catch (err) {
          showStatus(`加载系统代理失败：${err.message}`, "error", 6000);
        }
      }

      function collectIgnoreHosts() {
        if (!systemProxyIgnoreInput) {
          return Array.isArray(systemProxySettings.ignoreHosts)
            ? [...systemProxySettings.ignoreHosts]
            : [...SYSTEM_PROXY_DEFAULTS];
        }
        return systemProxyIgnoreInput
          .value.split(/\r?\n/)
          .map((item) => item.trim())
          .filter(Boolean);
      }

      function updateHomeNodeStatus() {
        if (!homeNodeName || !homeNodeLatency || !homeNodeSpeed) return;

        let node = null;
        if (Array.isArray(nodesCache) && nodesCache.length > 0) {
          const targetId = resolveHomeNodeId();
          if (targetId) {
            node = nodesCache.find((item) => item.id === targetId) || null;
          }
          if (!node) {
            node = nodesCache[0];
          }
        }

        if (!node) {
          homeNodeName.textContent = "Select a Node";
          if (homeNodeAddress) homeNodeAddress.textContent = "-";
          homeNodeLatency.textContent = "--";
          homeNodeSpeed.textContent = "--";
          if (homeNodeUpdated) homeNodeUpdated.textContent = "-";
          return;
        }

        homeNodeName.textContent = escapeHtml(node.name || "-");
        if (homeNodeAddress) {
          homeNodeAddress.textContent = node.address ? `${escapeHtml(node.address)}:${escapeHtml(String(node.port || ""))}` : "-";
        }

        const latency = typeof node.lastLatencyMs === "number" && node.lastLatencyMs > 0 ? `${node.lastLatencyMs} ms` : "--";
        let speed;
        if (node.lastSpeedError) {
          speed = `Error`;
        } else if (typeof node.lastSpeedMbps === "number" && node.lastSpeedMbps > 0) {
          speed = `${node.lastSpeedMbps >= 10 ? node.lastSpeedMbps.toFixed(1) : node.lastSpeedMbps.toFixed(2)} MB/s`;
        } else {
          speed = "--";
        }
        homeNodeLatency.textContent = latency;
        homeNodeSpeed.textContent = speed;

        if (homeNodeUpdated) {
          const timestamps = [node.lastLatencyAt, node.lastSpeedAt].filter(Boolean);
          const updated = timestamps.length > 0 ? timestamps.sort().slice(-1)[0] : null;
          homeNodeUpdated.textContent = updated ? formatTime(updated) : "-";
        }
      }

      function resolveHomeNodeId() {
        if (!Array.isArray(nodesCache) || nodesCache.length === 0) {
          return "";
        }
        if (xrayStatus && xrayStatus.activeNodeId) {
          const active = nodesCache.find((item) => item.id === xrayStatus.activeNodeId);
          if (active && active.id) {
            return active.id;
          }
        }
        if (preferredNodeId) {
          const preferred = nodesCache.find((item) => item.id === preferredNodeId);
          if (preferred && preferred.id) {
            return preferred.id;
          }
        }
        const first = nodesCache[0];
        return (first && first.id) || "";
      }

      async function autoPingCurrentNode(targetId, { force = false } = {}) {
        const nodeId = targetId || resolveHomeNodeId();
        if (!nodeId) {
          return false;
        }
        const now = Date.now();
        if (!force) {
          if (homePingState.running && now - homePingState.lastTriggeredAt < HOME_PING_COOLDOWN) {
            return false;
          }
          if (homePingState.lastNodeId === nodeId && now - homePingState.lastTriggeredAt < HOME_PING_COOLDOWN) {
            return false;
          }
          const node = Array.isArray(nodesCache) ? nodesCache.find((item) => item.id === nodeId) : null;
          if (node) {
            const lastLatencyAt = node.lastLatencyAt ? Date.parse(node.lastLatencyAt) : NaN;
            if (!Number.isNaN(lastLatencyAt) && now - lastLatencyAt < HOME_PING_COOLDOWN) {
              return false;
            }
          }
        }
        homePingState.running = true;
        homePingState.lastNodeId = nodeId;
        homePingState.lastTriggeredAt = now;
        try {
          await api.post(`/nodes/${nodeId}/ping`);
          return true;
        } catch (err) {
          showStatus(`延迟任务失败：${err.message}`, "error", 6000);
          return false;
        } finally {
          homePingState.running = false;
        }
      }

      async function autoSpeedtestCurrentNode(targetId, { force = false } = {}) {
        const nodeId = targetId || resolveHomeNodeId();
        if (!nodeId) {
          return false;
        }
        const now = Date.now();
        if (!force) {
          if (homeSpeedtestState.running && now - homeSpeedtestState.lastTriggeredAt < HOME_SPEEDTEST_COOLDOWN) {
            return false;
          }
          if (homeSpeedtestState.lastNodeId === nodeId && now - homeSpeedtestState.lastTriggeredAt < HOME_SPEEDTEST_COOLDOWN) {
            return false;
          }
          const node = Array.isArray(nodesCache) ? nodesCache.find((item) => item.id === nodeId) : null;
          if (node && (!node.lastSpeedError || node.lastSpeedError.length === 0)) {
            const lastSpeedAt = node.lastSpeedAt ? Date.parse(node.lastSpeedAt) : NaN;
            if (!Number.isNaN(lastSpeedAt) && now - lastSpeedAt < HOME_SPEEDTEST_COOLDOWN) {
              return false;
            }
          }
        }
        homeSpeedtestState.running = true;
        homeSpeedtestState.lastNodeId = nodeId;
        homeSpeedtestState.lastTriggeredAt = now;
        try {
          await api.post(`/nodes/${nodeId}/speedtest`);
          return true;
        } catch (err) {
          showStatus(`测速任务失败：${err.message}`, "error", 6000);
          return false;
        } finally {
          homeSpeedtestState.running = false;
        }
      }

      async function autoMeasureCurrentNode({ force = false } = {}) {
        const targetId = resolveHomeNodeId();
        if (!targetId) {
          return;
        }
        const pingTriggered = await autoPingCurrentNode(targetId, { force });
        if (pingTriggered) {
          await sleep(200);
        }
        await autoSpeedtestCurrentNode(targetId, { force });
      }

      async function loadHomePanel({ notify = false } = {}) {
        await Promise.all([
          loadNodes(),
          loadComponents(),
          refreshXrayStatus({ notify }),
          loadSystemProxySettings({ notify }),
          checkTUNStatus({ notify }),
          loadTUNSettings()
        ]);
        updateHomeNodeStatus();
        await autoMeasureCurrentNode({ force: true });
      }

      async function handleProxyToggle() {
        const button = document.getElementById("proxy-toggle");
        if (!button || button.disabled) return;
        const mode = button.dataset.mode || "start";
        button.disabled = true;
        try {
          if (mode === "stop") {
            const response = await api.put("/settings/system-proxy", {
              enabled: false,
              ignoreHosts: collectIgnoreHosts(),
            });
            await api.xray.stop();
            if (response && response.message) {
              showStatus(`代理已停止，但系统代理清除失败: ${response.message}`, "warn", 4000);
            } else {
              showStatus("代理已停止", "info");
            }
          } else {
            const payload = {};
            if (activeNodeId) {
              payload.activeNodeId = activeNodeId;
            }
            await api.xray.start(payload);
            // 等待核心完全启动后再启用系统代理
            await new Promise(r => setTimeout(r, 500));
            await api.put("/settings/system-proxy", {
              enabled: true,
              ignoreHosts: collectIgnoreHosts(),
            });
            showStatus("代理已启动", "success");
          }
          // Immediately refresh status after toggle
          await refreshXrayStatus();
        } catch (err) {
          showStatus(`操作失败: ${err.message}`, "error");
        } finally {
          button.disabled = false;
        }
      }

      // 组件安装轮询定时器
      let componentPollTimer = null;

      function renderComponents(components) {
        const tbody = document.querySelector("#component-table tbody");
        if (!tbody) return;
        if (!Array.isArray(components) || components.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" class="empty">暂无组件</td></tr>';
          return;
        }

        // 检查是否有组件正在安装
        const installing = components.some(c => c.installStatus === 'downloading' || c.installStatus === 'extracting');
        if (installing && !componentPollTimer) {
          componentPollTimer = setInterval(() => loadComponents(), 1000);
        } else if (!installing && componentPollTimer) {
          clearInterval(componentPollTimer);
          componentPollTimer = null;
        }

        tbody.innerHTML = components
          .map((component) => {
            const id = escapeHtml(component.id || "");
            const name = escapeHtml(component.name || "-");
            const kind = escapeHtml(componentDisplayName(component.kind));
            const version = escapeHtml(component.lastVersion || "-");
            const installDir = escapeHtml(component.installDir || "-");
            const installedAt = formatTime(component.lastInstalledAt);
            let statusText;
            let actionBtn = '';

            // 检查安装状态
            const installStatus = component.installStatus || '';
            const installProgress = component.installProgress || 0;
            const installMessage = component.installMessage || '';

            if (installStatus === 'downloading' || installStatus === 'extracting') {
              // 正在安装中，显示进度条
              statusText = `
            <div class="install-progress">
              <div class="progress-bar">
                <div class="progress-fill" style="width: ${installProgress}%"></div>
              </div>
              <span class="progress-text">${escapeHtml(installMessage)} (${installProgress}%)</span>
            </div>
          `;
              actionBtn = `<button class="ghost" disabled>安装中...</button>`;
            } else if (installStatus === 'error' || component.lastSyncError) {
              const errMsg = installMessage || component.lastSyncError || '未知错误';
              statusText = `<span class="badge error">失败：${escapeHtml(errMsg)}</span>`;
              actionBtn = `<button class="primary" data-action="update-component">重试</button>`;
            } else if (component.installDir) {
              statusText = '<span class="badge">已安装</span>';
              actionBtn = `<button class="ghost" data-action="update-component">更新</button>`;
            } else {
              statusText = '<span class="badge warn">未安装</span>';
              actionBtn = `<button class="primary" data-action="update-component">安装</button>`;
            }

            const interval = formatInterval(component.autoUpdateInterval);
            const isCoreComponent = component.kind === "xray" || component.kind === "singbox";
            const deleteBtn = isCoreComponent ? '' : '<button class="danger" data-action="delete-component">删除</button>';

            return `
          <tr data-id="${id}" data-kind="${escapeHtml(component.kind)}">
            <td>${name}</td>
            <td><span class="badge">${kind}</span></td>
            <td>${version}</td>
            <td><span class="muted">${installDir}</span></td>
            <td>${installedAt}</td>
            <td>${statusText}<br /><span class="muted">自动更新：${interval}</span></td>
            <td>
              ${actionBtn}
              ${deleteBtn}
            </td>
          </tr>
        `;
          })
          .join("");
      }

      async function loadComponents({ notify = false } = {}) {
        try {
          const components = await api.get("/components");
          componentsCache = Array.isArray(components) ? components : [];
          renderComponents(components);
          await refreshXrayStatus();
          if (notify) {
            showStatus("组件列表已刷新", "success");
          }
        } catch (err) {
          showStatus(`加载组件失败：${err.message}`, "error", 6000);
          componentsCache = [];
          await refreshXrayStatus();
        }
      }

      function componentDisplayName(kind) {
        switch (kind) {
          case "xray":
            return "Xray";
          case "singbox":
            return "sing-box";
          default:
            return kind || "组件";
        }
      }

      async function ensureComponent(kind) {
        const pretty = componentDisplayName(kind);
        try {
          let components = [];
          try {
            components = await api.get("/components");
          } catch {
            components = [];
          }
          componentsCache = Array.isArray(components) ? components : [];
          let target = Array.isArray(components) ? components.find((item) => item.kind === kind) : null;
          if (!target) {
            target = await api.post("/components", { kind });
          }
          await api.post(`/components/${target.id}/install`);
          showStatus(`${pretty} 安装任务已触发`, "info", 2400);
          await loadComponents();
          await refreshXrayStatus();
        } catch (err) {
          showStatus(`${pretty} 安装失败：${err.message}`, "error", 6000);
        }
      }

      async function loadTraffic({ notify = false } = {}) {
        try {
          const [profile, rules] = await Promise.all([api.get("/traffic/profile"), api.get("/traffic/rules")]);
          renderTrafficProfile(profile);
          renderTrafficRules(rules);
          if (notify) {
            showStatus("流量策略已刷新", "success");
          }
        } catch (err) {
          showStatus(`加载流量策略失败：${err.message}`, "error", 6000);
        }
      }

      function renderTrafficProfile(profile) {
        const form = document.getElementById("profile-form");
        form.defaultNodeId.value = profile.defaultNodeId || "";
        form.dnsStrategy.value = (profile.dns && profile.dns.strategy) || "";
        form.dnsServers.value = (profile.dns && profile.dns.servers ? profile.dns.servers.join("\n") : "");
      }

      function renderTrafficRules(rules) {
        const tbody = document.querySelector("#rule-table tbody");
        if (!Array.isArray(rules) || rules.length === 0) {
          tbody.innerHTML = '<tr><td colspan="6" class="empty">暂无规则</td></tr>';
          return;
        }
        tbody.innerHTML = rules
          .map((rule) => {
            const targets =
              Array.isArray(rule.targets) && rule.targets.length
                ? rule.targets.map((target) => `<span class="tag">${escapeHtml(target)}</span>`).join("")
                : '<span class="muted">-</span>';
            return `
          <tr data-id="${escapeHtml(rule.id)}">
            <td>${escapeHtml(rule.name)}</td>
            <td>${escapeHtml(rule.nodeId)}</td>
            <td><div class="tags">${targets}</div></td>
            <td>${escapeHtml(rule.priority ?? "-")}</td>
            <td>${formatTime(rule.updatedAt)}</td>
            <td>
              <button class="danger" data-action="delete-rule">删除</button>
            </td>
          </tr>
        `;
          })
          .join("");
      }

      const loaders = {
        "panel-home": () => loadHomePanel(),
        panel1: loadNodes,
        panel2: loadConfigs,
        panel3: () => loadComponents(),
        panel4: loadTraffic,
        "panel-settings": () => loadSystemProxySettings(),
      };

      menu.addEventListener("click", (event) => {
        const button = event.target.closest("button[data-target]");
        if (!button) return;
        const target = button.dataset.target;
        if (target === currentPanel) return;
        currentPanel = target;
        menu.querySelectorAll("button").forEach((btn) => btn.classList.remove("active"));
        button.classList.add("active");
        panels.forEach((panel) => {
          panel.classList.toggle("active", panel.id === target);
        });
        loaders[target]?.();
      });

      const nodeGrid = document.getElementById("node-grid");
      const nodeTabs = document.getElementById("node-tabs");
      const nodeAddButton = document.getElementById("node-add-button");
      const nodeModal = document.getElementById("node-modal");
      const nodeModalClose = document.getElementById("node-modal-close");
      const nodeModalReset = document.getElementById("node-modal-reset");
      const nodeModalBackdrop = nodeModal ? nodeModal.querySelector(".modal-backdrop") : null;
      const nodeForm = document.getElementById("node-form");
      document.getElementById("node-refresh").addEventListener("click", () => loadNodes({ notify: true }));
      document.getElementById("config-refresh").addEventListener("click", () => loadConfigs({ notify: true }));
      document.getElementById("traffic-refresh").addEventListener("click", () => loadTraffic({ notify: true }));
      document.getElementById("component-refresh").addEventListener("click", () => loadComponents({ notify: true }));

      // TUN status click handler
      const tunStatusValue = document.getElementById("tun-status-value");
      if (tunStatusValue) {
        tunStatusValue.addEventListener("click", showTUNStatusDialog);
      }

      // TUN toggle handler
      const tunToggle = document.getElementById("tun-toggle");
      if (tunToggle) {
        tunToggle.addEventListener("change", (event) => {
          updateTUNSetting(event.target.checked);
        });
      }

      const systemProxyIgnoreInput = document.getElementById("system-proxy-ignore");
      const systemProxySaveButton = document.getElementById("system-proxy-save");
      const systemProxyResetButton = document.getElementById("system-proxy-reset");
      const proxyToggleButton = document.getElementById("proxy-toggle");
      const homeNodeName = document.getElementById("home-node-name");
      const homeNodeAddress = document.getElementById("home-node-address");
      const homeNodeLatency = document.getElementById("home-node-latency");
      const homeNodeSpeed = document.getElementById("home-node-speed");
      const homeNodeProtocol = document.getElementById("home-node-protocol");
      const homeNodeUpdated = document.getElementById("home-node-updated");
      if (proxyToggleButton) {
        proxyToggleButton.addEventListener("click", handleProxyToggle);
      }

      function openNodeModal() {
        if (!nodeModal) return;
        nodeModal.classList.add("open");
      }

      function closeNodeModal() {
        if (!nodeModal) return;
        nodeModal.classList.remove("open");
      }

      if (nodeAddButton) {
        nodeAddButton.addEventListener("click", openNodeModal);
      }
      if (nodeModalClose) {
        nodeModalClose.addEventListener("click", closeNodeModal);
      }
      if (nodeModalBackdrop) {
        nodeModalBackdrop.addEventListener("click", closeNodeModal);
      }
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && nodeModal?.classList.contains("open")) {
          closeNodeModal();
        }
      });
      if (nodeModalReset && nodeForm) {
        nodeModalReset.addEventListener("click", () => {
          nodeForm.reset();
        });
      }

      // Handle protocol and network-specific field visibility
      const protocolSelect = document.getElementById("protocol-select");
      const networkSelect = document.getElementById("network-select");
      const tlsSelect = nodeForm?.querySelector('select[name="tls"]');

      function updateFieldVisibility() {
        if (!protocolSelect) return;

        const protocol = protocolSelect.value;
        const network = networkSelect?.value || "tcp";
        const tls = tlsSelect?.value || "";

        // Hide all protocol-specific fields first
        const ssFields = document.getElementById("ss-fields");
        const vmessFields = document.getElementById("vmess-fields");
        const trojanFields = document.getElementById("trojan-fields");
        const proxyFields = document.getElementById("proxy-fields");

        if (ssFields) ssFields.style.display = "none";
        if (vmessFields) vmessFields.style.display = "none";
        if (trojanFields) trojanFields.style.display = "none";
        if (proxyFields) proxyFields.style.display = "none";

        // Show relevant protocol fields
        if (protocol === "shadowsocks" && ssFields) {
          ssFields.style.display = "grid";
        } else if ((protocol === "vmess" || protocol === "vless") && vmessFields) {
          vmessFields.style.display = "grid";
        } else if (protocol === "trojan" && trojanFields) {
          trojanFields.style.display = "block";
        } else if ((protocol === "http" || protocol === "socks5") && proxyFields) {
          proxyFields.style.display = "grid";
        }

        // Hide all network-specific fields first
        const wsFields = document.getElementById("ws-fields");
        const h2Fields = document.getElementById("h2-fields");
        const grpcFields = document.getElementById("grpc-fields");

        if (wsFields) wsFields.style.display = "none";
        if (h2Fields) h2Fields.style.display = "none";
        if (grpcFields) grpcFields.style.display = "none";

        // Show relevant network fields
        if (network === "ws" && wsFields) {
          wsFields.style.display = "grid";
        } else if (network === "h2" && h2Fields) {
          h2Fields.style.display = "grid";
        } else if (network === "grpc" && grpcFields) {
          grpcFields.style.display = "block";
        }

        // Show/hide TLS fields
        const tlsFields = document.getElementById("tls-fields");
        if (tlsFields) {
          tlsFields.style.display = (tls && tls !== "") ? "grid" : "none";
        }
      }

      if (protocolSelect) {
        protocolSelect.addEventListener("change", updateFieldVisibility);
      }
      if (networkSelect) {
        networkSelect.addEventListener("change", updateFieldVisibility);
      }
      if (tlsSelect) {
        tlsSelect.addEventListener("change", updateFieldVisibility);
      }

      // Handle advanced settings toggles
      const enableNetworkCheckbox = document.getElementById("enable-network");
      const enableTlsCheckbox = document.getElementById("enable-tls");
      const networkSettings = document.getElementById("network-settings");
      const tlsSettings = document.getElementById("tls-settings");

      if (enableNetworkCheckbox && networkSettings) {
        enableNetworkCheckbox.addEventListener("change", (e) => {
          networkSettings.style.display = e.target.checked ? "grid" : "none";
          if (e.target.checked) {
            updateFieldVisibility();
          }
        });
      }

      if (enableTlsCheckbox && tlsSettings) {
        enableTlsCheckbox.addEventListener("change", (e) => {
          tlsSettings.style.display = e.target.checked ? "grid" : "none";
        });
      }

      if (nodeForm) {
        nodeForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          const form = event.target;

          // Check for share link first
          const shareLink = form.shareLink.value.trim();
          if (shareLink) {
            try {
              await api.post("/nodes", { shareLink });
              form.reset();
              showStatus("节点添加成功", "success");
              closeNodeModal();
              await loadNodes();
            } catch (err) {
              showStatus(`添加节点失败：${err.message}`, "error", 6000);
            }
            return;
          }

          // Build payload from form fields
          const protocol = form.protocol.value.trim();
          if (!protocol) {
            showStatus("请选择协议", "error");
            return;
          }

          const payload = {
            name: form.name.value.trim(),
            address: form.address.value.trim(),
            port: parseNumber(form.port.value),
            protocol: protocol,
            tags: parseList(form.tags.value),
            remarks: form.remarks.value.trim() || "",
          };

          if (!payload.name || !payload.address || !payload.port) {
            showStatus("请完整填写节点信息", "error");
            return;
          }

          // Protocol-specific settings
          if (protocol === "shadowsocks") {
            payload.password = form.ss_password.value.trim();
            payload.method = form.ss_method.value;
          } else if (protocol === "vmess" || protocol === "vless") {
            payload.uuid = form.vmess_uuid.value.trim();
            if (protocol === "vmess") {
              payload.alterId = parseNumber(form.vmess_alterid.value) || 0;
              payload.security = form.vmess_security.value;
            } else if (protocol === "vless") {
              payload.flow = form.vless_flow.value || "";
            }
          } else if (protocol === "trojan") {
            payload.password = form.trojan_password.value.trim();
          } else if (protocol === "http" || protocol === "socks5") {
            payload.username = form.proxy_username.value.trim() || "";
            payload.password = form.proxy_password.value.trim() || "";
          }

          // Network settings
          payload.network = form.network.value || "tcp";
          payload.tls = form.tls.value || "";

          // Network-specific settings
          if (payload.network === "ws") {
            payload.path = form.ws_path.value.trim() || "/";
            payload.host = form.ws_host.value.trim() || "";
          } else if (payload.network === "h2") {
            payload.path = form.h2_path.value.trim() || "/";
            payload.host = form.h2_host.value.trim() || "";
          } else if (payload.network === "grpc") {
            payload.serviceName = form.grpc_service.value.trim() || "";
          }

          // TLS settings
          if (payload.tls) {
            payload.sni = form.tls_sni.value.trim() || "";
            payload.fingerprint = form.tls_fingerprint.value || "";
          }

          try {
            await api.post("/nodes", payload);
            form.reset();
            updateFieldVisibility(); // Reset field visibility
            showStatus("节点添加成功", "success");
            closeNodeModal();
            await loadNodes();
          } catch (err) {
            showStatus(`添加节点失败：${err.message}`, "error", 6000);
          }
        });
      }

      function updateHomeNodeStatus() {
        if (!homeNodeName || !homeNodeLatency || !homeNodeSpeed) return;

        let node = null;
        if (Array.isArray(nodesCache) && nodesCache.length > 0) {
          const targetId = resolveHomeNodeId();
          if (targetId) {
            node = nodesCache.find((item) => item.id === targetId) || null;
          }
          if (!node) {
            node = nodesCache[0];
          }
        }

        if (!node) {
          homeNodeName.textContent = "选择节点";
          if (homeNodeAddress) homeNodeAddress.textContent = "-";
          homeNodeLatency.textContent = "--";
          homeNodeSpeed.textContent = "--";
          if (homeNodeProtocol) homeNodeProtocol.textContent = "--";
          if (homeNodeUpdated) homeNodeUpdated.textContent = "-";
          return;
        }

        homeNodeName.textContent = escapeHtml(node.name || "-");
        if (homeNodeAddress) {
          homeNodeAddress.textContent = node.address ? `${escapeHtml(node.address)}:${escapeHtml(String(node.port || ""))}` : "-";
        }

        const latency = typeof node.lastLatencyMs === "number" && node.lastLatencyMs > 0 ? `${node.lastLatencyMs} ms` : "--";
        let speed;
        if (node.lastSpeedError) {
          speed = `Error`;
        } else if (typeof node.lastSpeedMbps === "number" && node.lastSpeedMbps > 0) {
          speed = `${node.lastSpeedMbps >= 10 ? node.lastSpeedMbps.toFixed(1) : node.lastSpeedMbps.toFixed(2)} MB/s`;
        } else {
          speed = "--";
        }
        homeNodeLatency.textContent = latency;
        homeNodeSpeed.textContent = speed;

        // Display protocol
        if (homeNodeProtocol) {
          const protocol = node.protocol ? escapeHtml(node.protocol).toUpperCase() : "--";
          homeNodeProtocol.textContent = protocol;
        }

        if (homeNodeUpdated) {
          const timestamps = [node.lastLatencyAt, node.lastSpeedAt].filter(Boolean);
          const updated = timestamps.length > 0 ? timestamps.sort().slice(-1)[0] : null;
          homeNodeUpdated.textContent = updated ? formatTime(updated) : "-";
        }
      }

      if (nodeGrid) {
        nodeGrid.addEventListener("click", async (event) => {
          const card = event.target.closest(".node-card[data-id]");
          if (!card) return;
          const id = card.dataset.id;
          const actionTarget = event.target.closest("[data-action]");
          const action = actionTarget ? actionTarget.dataset.action : "select-node";
          try {
            if (action === "delete-node") {
              if (!confirm("确认删除该节点？")) return;
              await api.delete(`/nodes/${id}`);
              showStatus("节点已删除", "success");
              await loadNodes();
            } else if (action === "ping-node") {
              await api.post(`/nodes/${id}/ping`);
              showStatus("延迟任务已排队", "info");
              await loadNodes();
            } else if (action === "speed-node") {
              await api.post(`/nodes/${id}/speedtest`);
              showStatus("测速任务已排队", "info");
              await loadNodes();
            } else if (action === "select-node") {
              await api.post(`/nodes/${id}/select`);
              localStorage.setItem("vea_selected_node_id", id);
              showStatus("已切换当前节点", "success");
              await loadNodes();
            }
          } catch (err) {
            showStatus(`操作失败：${err.message}`, "error", 6000);
          }
        });
      }

      if (nodeTabs) {
        nodeTabs.addEventListener("click", (event) => {
          const button = event.target.closest(".node-tab[data-tag]");
          if (!button) return;
          const tag = button.dataset.tag;
          if (tag === currentNodeTab) return;
          currentNodeTab = tag;
          nodeTabs.querySelectorAll(".node-tab").forEach((tab) => tab.classList.remove("active"));
          button.classList.add("active");
          renderNodes(nodesCache, activeNodeId);
        });
      }

      // Traffic Tabs Logic
      const trafficTabs = document.getElementById("traffic-tabs");
      if (trafficTabs) {
        trafficTabs.addEventListener("click", (event) => {
          const button = event.target.closest(".node-tab[data-tab]");
          if (!button) return;
          const tabName = button.dataset.tab;

          // Update active tab state
          trafficTabs.querySelectorAll(".node-tab").forEach(t => t.classList.remove("active"));
          button.classList.add("active");

          // Show/Hide content
          const globalContent = document.getElementById("traffic-content-global");
          const rulesContent = document.getElementById("traffic-content-rules");

          if (tabName === "global") {
            if (globalContent) globalContent.style.display = "block";
            if (rulesContent) rulesContent.style.display = "none";
          } else {
            if (globalContent) globalContent.style.display = "none";
            if (rulesContent) rulesContent.style.display = "block";
          }
        });
      }

      const configModal = document.getElementById("config-modal");
      const configAddButton = document.getElementById("config-add-button");
      const configModalClose = document.getElementById("config-modal-close");
      const configModalBackdrop = configModal?.querySelector(".modal-backdrop");
      const configModalReset = document.getElementById("config-modal-reset");
      const configForm = document.getElementById("config-form");

      function openConfigModal() {
        if (!configModal) return;
        configModal.classList.add("open");
        if (configForm) configForm.reset();
      }

      function closeConfigModal() {
        if (!configModal) return;
        configModal.classList.remove("open");
      }

      if (configAddButton) {
        configAddButton.addEventListener("click", openConfigModal);
      }
      if (configModalClose) {
        configModalClose.addEventListener("click", closeConfigModal);
      }
      if (configModalBackdrop) {
        configModalBackdrop.addEventListener("click", closeConfigModal);
      }
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && configModal?.classList.contains("open")) {
          closeConfigModal();
        }
      });
      if (configModalReset && configForm) {
        configModalReset.addEventListener("click", () => {
          configForm.reset();
        });
      }

      if (configForm) {
        configForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          const form = event.target;
          let inferredFormat = "";
          const typedPayload = (form.payload.value || "").trim();
          const sourceUrl = form.sourceUrl.value.trim();
          const detectSample = typedPayload || sourceUrl;
          if (detectSample) {
            const lower = detectSample.toLowerCase();
            if (/\"outbounds\"/.test(detectSample) || /\"inbounds\"/.test(detectSample) || /vmess|trojan|vless|ss:/.test(lower)) {
              inferredFormat = "xray-json";
            }
          }
          const payload = {
            name: form.name.value.trim(),
            format: inferredFormat || "xray-json",
            sourceUrl,
            payload: typedPayload,
            autoUpdateIntervalMinutes: parseNumber(form.autoUpdateInterval.value),
          };
          if (!payload.sourceUrl) {
            showStatus("请填写源/订阅链接", "error", 5000);
            return;
          }
          try {
            await api.post("/configs/import", payload);
            form.reset();
            showStatus("配置添加成功", "success");
            closeConfigModal();
            await Promise.all([loadConfigs(), loadNodes()]);
          } catch (err) {
            showStatus(`添加配置失败：${err.message}`, "error", 6000);
          }
        });
      }

      function getSelectedNodeIds() {
        if (!nodeGrid) return [];
        return Array.from(nodeGrid.querySelectorAll(".node-card[data-id]"))
          .map((card) => card.dataset.id)
          .filter(Boolean);
      }

      document.getElementById("node-bulk-ping").addEventListener("click", async () => {
        const ids = getSelectedNodeIds();
        if (ids.length === 0) {
          showStatus("请先勾选节点", "error");
          return;
        }
        try {
          await api.post("/nodes/bulk/ping", { ids });
          showStatus("批量延迟任务已排队", "info");
          await loadNodes();
        } catch (err) {
          showStatus(`批量延迟失败：${err.message}`, "error", 6000);
        }
      });

      document.getElementById("node-bulk-speed").addEventListener("click", async () => {
        const ids = getSelectedNodeIds();
        if (ids.length === 0) {
          showStatus("请先勾选节点", "error");
          return;
        }
        try {
          await api.post("/nodes/reset-speed", { ids });
          await loadNodes();
          for (const id of ids) {
            await api.post(`/nodes/${id}/speedtest`);
          }
          showStatus("批量测速任务已排队", "info");
          await loadNodes();
        } catch (err) {
          showStatus(`批量测速失败：${err.message}`, "error", 6000);
        }
      });

      document.getElementById("config-table").addEventListener("click", async (event) => {
        const button = event.target.closest("button[data-action]");
        if (!button) return;
        const tr = button.closest("tr[data-id]");
        if (!tr) return;
        const id = tr.dataset.id;
        const action = button.dataset.action;
        try {
          if (action === "refresh-config") {
            await api.post(`/configs/${id}/refresh`);
            showStatus("配置刷新完成", "success");
            await Promise.all([loadConfigs(), loadNodes()]);
          } else if (action === "pull-nodes") {
            const nodes = await api.post(`/configs/${id}/pull-nodes`);
            renderNodes(nodes);
            showStatus(`订阅节点已同步（${nodes.length}）`, "success");
            await Promise.all([loadConfigs(), loadNodes()]);
          } else if (action === "delete-config") {
            if (!confirm("确认删除该配置？")) return;
            await api.delete(`/configs/${id}`);
            showStatus("配置已删除", "success");
            await Promise.all([loadConfigs(), loadNodes()]);
          }
        } catch (err) {
          showStatus(`操作失败：${err.message}`, "error", 6000);
        }
      });

      if (systemProxySaveButton) {
        systemProxySaveButton.addEventListener("click", async () => {
          try {
            systemProxySaveButton.disabled = true;
            const payload = {
              enabled: Boolean(systemProxySettings && systemProxySettings.enabled),
              ignoreHosts: collectIgnoreHosts(),
            };
            const response = await api.put("/settings/system-proxy", payload);
            const data = response && response.settings ? response.settings : response;
            systemProxySettings = {
              enabled: Boolean(data.enabled),
              ignoreHosts: Array.isArray(data.ignoreHosts) ? data.ignoreHosts : [...SYSTEM_PROXY_DEFAULTS],
            };
            renderSystemProxy(systemProxySettings);
            updateXrayUI(xrayStatus);
            const msg = response && response.message ? response.message : "系统代理设置已保存";
            showStatus(msg, response && response.message ? "info" : "success");
          } catch (err) {
            showStatus(`保存系统代理失败：${err.message}`, "error", 6000);
          } finally {
            systemProxySaveButton.disabled = false;
          }
        });
      }

      if (systemProxyResetButton) {
        systemProxyResetButton.addEventListener("click", () => {
          systemProxySettings = {
            ...systemProxySettings,
            ignoreHosts: [...SYSTEM_PROXY_DEFAULTS],
          };
          renderSystemProxy(systemProxySettings);
          updateXrayUI(xrayStatus);
        });
      }

      // TUN 设置按钮事件
      const tunSetupBtn = document.getElementById("tun-setup-btn");

      if (tunSetupBtn) {
        tunSetupBtn.addEventListener("click", () => {
          setupTUN();
        });
      }

      renderSystemProxy(systemProxySettings);

      // 设置标签切换
      const settingsNavItems = document.querySelectorAll(".settings-nav-item");
      settingsNavItems.forEach((item) => {
        item.addEventListener("click", () => {
          const tab = item.dataset.settingsTab;

          // 更新导航项状态
          settingsNavItems.forEach((navItem) => navItem.classList.remove("active"));
          item.classList.add("active");

          // 更新内容显示
          document.querySelectorAll(".settings-content").forEach((content) => {
            content.classList.remove("active");
            content.style.display = "none";
          });

          const targetContent = document.getElementById(`settings-${tab}`);
          if (targetContent) {
            targetContent.classList.add("active");
            targetContent.style.display = "block";
          }
        });
      });

      // ===== 动态设置系统初始化 =====
      const settingsManager = new SettingsManager(SETTINGS_SCHEMA);
      const settingsRenderer = new SettingsRenderer(settingsManager);

      // 类别 ID 映射到 DOM 容器 ID
      const categoryToContainerId = {
        general: 'settings-general',
        proxy: 'settings-proxy',
        tun: 'settings-network',
        singbox: 'settings-singbox',
        xray: 'settings-xray',
        advanced: 'settings-advanced'
      };

      // 渲染所有设置类别
      function renderAllSettings() {
        for (const [categoryId, containerId] of Object.entries(categoryToContainerId)) {
          const container = document.getElementById(containerId);
          if (container) {
            container.innerHTML = settingsRenderer.renderCategory(categoryId);
            settingsRenderer.bindEvents(container);
          }
        }

        // 特殊处理：主题选择器事件绑定
        const themeSelect = document.querySelector('[data-key="theme"]');
        if (themeSelect) {
          themeSelect.addEventListener('change', (e) => {
            switchTheme(e.target.value);
          });
          // 设置当前主题
          const currentFile = window.location.pathname.split('/').pop();
          const currentTheme = currentFile.includes('light') ? 'light' : 'dark';
          themeSelect.value = currentTheme;
        }
      }

      // 初始化渲染
      renderAllSettings();

      // 导入设置按钮
      const settingsImportBtn = document.getElementById('settings-import-btn');
      if (settingsImportBtn) {
        settingsImportBtn.addEventListener('click', () => {
          const input = document.createElement('input');
          input.type = 'file';
          input.accept = '.json';
          input.onchange = async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            try {
              const text = await file.text();
              const result = settingsManager.importJSON(text);
              if (result.success) {
                showStatus(`导入成功：${result.imported} 项设置`, 'success');
                renderAllSettings();
              } else {
                showStatus(`导入失败：${result.error}`, 'error', 5000);
              }
            } catch (err) {
              showStatus(`读取文件失败：${err.message}`, 'error', 5000);
            }
          };
          input.click();
        });
      }

      // 导出设置按钮
      const settingsExportBtn = document.getElementById('settings-export-btn');
      if (settingsExportBtn) {
        settingsExportBtn.addEventListener('click', () => {
          const json = settingsManager.exportJSON();
          const blob = new Blob([json], { type: 'application/json' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `vea-settings-${new Date().toISOString().split('T')[0]}.json`;
          a.click();
          URL.revokeObjectURL(url);
          showStatus('设置已导出', 'success');
        });
      }

      // 恢复默认按钮
      const settingsResetBtn = document.getElementById('settings-reset-btn');
      if (settingsResetBtn) {
        settingsResetBtn.addEventListener('click', () => {
          if (!confirm('确认恢复所有设置为默认值？')) return;
          settingsManager.resetToDefaults();
          renderAllSettings();
          showStatus('已恢复默认设置', 'success');
        });
      }

      // 监听设置变化，保存到后端 API
      let saveTimeout = null;
      for (const category of SETTINGS_SCHEMA.categories) {
        for (const setting of category.settings) {
          settingsManager.on(setting.key, (value, oldValue, key) => {
            // 防抖：300ms 内只保存一次
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(async () => {
              await settingsManager.saveToAPI();
            }, 300);
          });
        }
      }

      // 从后端 API 加载已保存的设置
      (async function loadSettingsFromAPI() {
        await settingsManager.loadFromAPI('http://localhost:18080');
        renderAllSettings();
      })();

      const componentTable = document.getElementById("component-table");
      if (componentTable) {
        componentTable.addEventListener("click", async (event) => {
          const button = event.target.closest("button[data-action]");
          if (!button) return;
          const tr = button.closest("tr[data-id]");
          if (!tr) return;
          const id = tr.dataset.id;
          const kind = tr.dataset.kind;
          const action = button.dataset.action;
          try {
            if (action === "delete-component") {
              if (!confirm("确认删除该组件？")) return;
              await api.delete(`/components/${id}`);
              showStatus("组件已删除", "success");
              await loadComponents();
              await refreshXrayStatus();
            } else if (action === "update-component") {
              if (kind) {
                await ensureComponent(kind);
              } else {
                showStatus("无法识别组件类型", "error");
              }
            }
          } catch (err) {
            showStatus(`组件操作失败：${err.message}`, "error", 6000);
          }
        });
      }

      document.querySelectorAll(".ensure-component").forEach((button) => {
        button.addEventListener("click", async () => {
          const kind = button.dataset.kind;
          if (!kind) return;
          button.disabled = true;
          try {
            await ensureComponent(kind);
          } finally {
            button.disabled = false;
          }
        });
      });

      document.getElementById("profile-form").addEventListener("submit", async (event) => {
        event.preventDefault();
        const form = event.target;
        const payload = {
          defaultNodeId: form.defaultNodeId.value.trim(),
          dns: {
            strategy: form.dnsStrategy.value.trim(),
            servers: parseList(form.dnsServers.value),
          },
        };
        try {
          const updated = await api.put("/traffic/profile", payload);
          renderTrafficProfile(updated);
          showStatus("默认出口与 DNS 已更新", "success");
        } catch (err) {
          showStatus(`更新失败：${err.message}`, "error", 6000);
        }
      });

      const ruleModal = document.getElementById("rule-modal");
      const ruleAddButton = document.getElementById("rule-add-button");
      const ruleModalClose = document.getElementById("rule-modal-close");
      const ruleModalBackdrop = ruleModal?.querySelector(".modal-backdrop");
      const ruleModalReset = document.getElementById("rule-modal-reset");
      const ruleForm = document.getElementById("rule-form");

      function openRuleModal() {
        if (!ruleModal) return;
        ruleModal.classList.add("open");
        if (ruleForm) ruleForm.reset();
      }

      function closeRuleModal() {
        if (!ruleModal) return;
        ruleModal.classList.remove("open");
      }

      if (ruleAddButton) {
        ruleAddButton.addEventListener("click", openRuleModal);
      }
      if (ruleModalClose) {
        ruleModalClose.addEventListener("click", closeRuleModal);
      }
      if (ruleModalBackdrop) {
        ruleModalBackdrop.addEventListener("click", closeRuleModal);
      }
      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape" && ruleModal?.classList.contains("open")) {
          closeRuleModal();
        }
      });
      if (ruleModalReset && ruleForm) {
        ruleModalReset.addEventListener("click", () => {
          ruleForm.reset();
        });
      }

      if (ruleForm) {
        ruleForm.addEventListener("submit", async (event) => {
          event.preventDefault();
          const form = event.target;
          const payload = {
            name: form.name.value.trim(),
            priority: parseNumber(form.priority.value),
            targets: parseList(form.targets.value),
            nodeId: form.nodeId.value.trim(),
          };
          if (!payload.name || !payload.targets.length || !payload.nodeId) {
            showStatus("请完整填写规则信息", "error");
            return;
          }
          try {
            await api.post("/traffic/rules", payload);
            form.reset();
            showStatus("路由规则添加成功", "success");
            closeRuleModal();
            await loadTrafficRules();
          } catch (err) {
            showStatus(`添加规则失败：${err.message}`, "error", 6000);
          }
        });
      }

      document.getElementById("rule-table").addEventListener("click", async (event) => {
        const button = event.target.closest("button[data-action]");
        if (!button) return;
        const tr = button.closest("tr[data-id]");
        if (!tr) return;
        const id = tr.dataset.id;
        const action = button.dataset.action;
        if (action !== "delete-rule") return;
        try {
          if (!confirm("确认删除该分流规则？")) return;
          await api.delete(`/traffic/rules/${id}`);
          showStatus("规则已删除", "success");
          await loadTraffic();
        } catch (err) {
          showStatus(`删除失败：${err.message}`, "error", 6000);
        }
      });

      // Initial load
      loadNodes();
      loadIPGeo();
      loaders[currentPanel]?.();
      ensureNodesPolling();
    })();

    // 窗口控制按钮事件
    if (window.electronAPI) {
      document.getElementById('minimize-btn').addEventListener('click', () => {
        window.electronAPI.minimizeWindow();
      });

      document.getElementById('maximize-btn').addEventListener('click', () => {
        window.electronAPI.maximizeWindow();
      });

      document.getElementById('close-btn').addEventListener('click', () => {
        window.electronAPI.closeWindow();
      });
    }

    // Theme settings - Switch between HTML files
    // Theme selector
    const themeSelector = document.getElementById("theme-selector");

    function switchTheme(theme) {
      localStorage.setItem("theme", theme);
      const file = theme === "dark" ? "dark.html" : "light.html";
      window.location.href = file;
    }

    // Get current theme from filename
    const currentFile = window.location.pathname.split('/').pop();
    const currentTheme = currentFile.includes('light') ? 'light' : 'dark';

    // Check if saved theme is different from current loaded theme
    const savedTheme = localStorage.getItem("theme") || "dark";
    if (savedTheme !== currentTheme) {
      // Auto-redirect to saved theme
      switchTheme(savedTheme);
    }

    // Set selector value to current theme
    if (themeSelector) {
      themeSelector.value = currentTheme;

      // Listen for theme changes
      themeSelector.addEventListener("change", (e) => {
        switchTheme(e.target.value);
      });
    }
  </script>
</body>

</html>