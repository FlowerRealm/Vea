name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. v1.2.3)'
        required: true
      release_notes:
        description: 'Release notes / changelog'
        required: true

permissions:
  contents: write

jobs:
  build-linux:
    runs-on: ubuntu-latest
    env:
      VERSION: ${{ github.event.inputs.version }}
    strategy:
      fail-fast: false
      matrix:
        goarch: [amd64, arm64, arm]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Prepare workspace
        run: mkdir -p dist
        shell: bash

      - name: Build & package
        run: ./scripts/package-linux.sh "${{ env.VERSION }}" "${{ matrix.goarch }}" dist
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: vea-linux-${{ matrix.goarch }}
          path: dist/vea-${{ env.VERSION }}-linux-${{ matrix.goarch }}.tar.gz

  build-macos:
    runs-on: macos-latest
    env:
      VERSION: ${{ github.event.inputs.version }}
    strategy:
      fail-fast: false
      matrix:
        goarch: [amd64, arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Prepare workspace
        run: mkdir -p dist
        shell: bash

      - name: Build & package
        run: ./scripts/package-macos.sh "${{ env.VERSION }}" "${{ matrix.goarch }}" dist
        shell: bash

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: vea-macos-${{ matrix.goarch }}
          path: dist/vea-${{ env.VERSION }}-darwin-${{ matrix.goarch }}.tar.gz

  build-windows:
    runs-on: windows-latest
    env:
      VERSION: ${{ github.event.inputs.version }}
    strategy:
      fail-fast: false
      matrix:
        goarch: [amd64, arm64]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Prepare workspace
        shell: pwsh
        run: |
          New-Item -ItemType Directory -Path dist -Force | Out-Null

      - name: Build & package
        shell: pwsh
        run: |
          ./scripts/package-windows.ps1 -Version "${{ env.VERSION }}" -GoOS "windows" -GoArch "${{ matrix.goarch }}"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: vea-windows-${{ matrix.goarch }}
          path: dist/vea-${{ env.VERSION }}-windows-${{ matrix.goarch }}.zip

  release:
    runs-on: ubuntu-latest
    needs:
      - build-linux
      - build-macos
      - build-windows
    env:
      VERSION: ${{ github.event.inputs.version }}
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-dist

      - name: Assemble release assets
        working-directory: release-dist
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p ../dist
          rm -f ../dist/*
          find . -type f -name 'vea-*' -print0 | while IFS= read -r -d '' file; do
            mv "$file" ../dist/
          done
          cd ../dist
          sha256sum * | sort -k2 > "vea-${VERSION}-SHA256SUMS"

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: ${{ github.event.inputs.version }}
          body: ${{ github.event.inputs.release_notes }}
          token: ${{ secrets.RELEASE_TOKEN }}
          files: dist/*
