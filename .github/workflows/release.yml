name: Build and Release Electron App

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g. v1.0.0)'
        required: true
        type: string
      release_notes:
        description: 'Release notes / changelog'
        required: true
        type: string

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  # ===================================
  # 1. æž„å»ºGoåŽç«¯ï¼ˆè·¨å¹³å°ï¼‰
  # ===================================
  build-backend:
    name: Build Backend - ${{ matrix.os }}-${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Linux
          - os: linux
            arch: amd64
            goos: linux
            goarch: amd64
            binary: vea
          - os: linux
            arch: arm64
            goos: linux
            goarch: arm64
            binary: vea
          # macOS
          - os: darwin
            arch: x64
            goos: darwin
            goarch: amd64
            binary: vea
          - os: darwin
            arch: arm64
            goos: darwin
            goarch: arm64
            binary: vea
          # Windows
          - os: windows
            arch: x64
            goos: windows
            goarch: amd64
            binary: vea.exe

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build backend
        env:
          CGO_ENABLED: 0
          GOOS: ${{ matrix.goos }}
          GOARCH: ${{ matrix.goarch }}
        run: |
          go build -trimpath -ldflags "-s -w" -o ${{ matrix.binary }} .
          ls -lh ${{ matrix.binary }}

      - name: Upload backend artifact
        uses: actions/upload-artifact@v4
        with:
          name: backend-${{ matrix.os }}-${{ matrix.arch }}
          path: ${{ matrix.binary }}
          retention-days: 1

  # ===================================
  # 2. æž„å»ºSDK
  # ===================================
  build-sdk:
    name: Build SDK
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/sdk/package.json

      - name: Install SDK dependencies
        working-directory: frontend/sdk
        run: npm ci

      - name: Build SDK
        working-directory: frontend/sdk
        run: npm run build

      - name: Verify SDK build
        working-directory: frontend/sdk
        run: |
          ls -lh dist/vea-sdk.esm.js
          echo "SDK size: $(stat -f%z dist/vea-sdk.esm.js 2>/dev/null || stat -c%s dist/vea-sdk.esm.js) bytes"

      - name: Upload SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: sdk-dist
          path: frontend/sdk/dist/vea-sdk.esm.js
          retention-days: 1

  # ===================================
  # 3. æ‰“åŒ…Linuxåº”ç”¨
  # ===================================
  package-linux:
    name: Package Linux App
    runs-on: ubuntu-latest
    needs: [build-backend, build-sdk]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package.json

      - name: Download backend artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: backend-linux-*
          path: backend-bins

      - name: Download SDK artifact
        uses: actions/download-artifact@v4
        with:
          name: sdk-dist
          path: frontend/sdk/dist

      - name: Prepare backend binaries
        run: |
          # å¤åˆ¶æ‰€æœ‰LinuxåŽç«¯åˆ°æ ¹ç›®å½•ï¼ˆelectron-builderä¼šæ ¹æ®æž¶æž„é€‰æ‹©ï¼‰
          cp backend-bins/backend-linux-amd64/vea ./vea-x64
          cp backend-bins/backend-linux-arm64/vea ./vea-arm64
          chmod +x vea-*
          ls -lh vea-*

      - name: Set version
        working-directory: frontend
        run: |
          VERSION="${{ github.event.inputs.version }}"
          VERSION="${VERSION#v}"  # åŽ»æŽ‰ v å‰ç¼€
          npm version $VERSION --no-git-tag-version --allow-same-version
          echo "Version set to: $VERSION"

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Prepare release directory
        run: |
          rm -rf release
          mkdir -p release
          rm -rf release-updates
          mkdir -p release-updates

      - name: Build Linux x64 packages
        working-directory: frontend
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cp ../vea-x64 ../vea
          chmod +x ../vea
          echo "=== Verifying x64 binary ==="
          file ../vea
          npm run build:linux -- --x64
          echo "=== Staging build outputs ==="
          ls -lh ../dist/electron/ || true
          echo "=== Collecting installers ==="
          cp -f ../dist/electron/*.deb ../release/ 2>/dev/null || true
          ls -lh ../release/ || true
          echo "=== Collecting updater assets ==="
          cp -f ../dist/electron/latest-linux*.yml ../release-updates/ 2>/dev/null || true
          ls -lh ../release-updates/ || true

      - name: Clean for arm64 build
        run: |
          rm -rf frontend/node_modules/.cache/electron-builder
          rm -rf ~/.cache/electron-builder
          rm -rf dist/electron
          rm -f vea

      - name: Build Linux arm64 packages
        working-directory: frontend
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cp ../vea-arm64 ../vea
          chmod +x ../vea
          echo "=== Verifying arm64 binary ==="
          file ../vea
          npm run build:linux -- --arm64
          echo "=== Staging build outputs ==="
          ls -lh ../dist/electron/ || true
          echo "=== Collecting installers ==="
          cp -f ../dist/electron/*.deb ../release/ 2>/dev/null || true
          ls -lh ../release/ || true
          echo "=== Collecting updater assets ==="
          # electron-builder å¯èƒ½åªè¾“å‡º latest-linux.ymlï¼›è¿™é‡Œä¿è¯ arm64 æœ‰ç‹¬ç«‹çš„ update info æ–‡ä»¶ã€‚
          cp -n ../dist/electron/latest-linux*.yml ../release-updates/ 2>/dev/null || true
          if [ -f ../dist/electron/latest-linux.yml ] && [ ! -f ../release-updates/latest-linux-arm64.yml ]; then
            cp -f ../dist/electron/latest-linux.yml ../release-updates/latest-linux-arm64.yml 2>/dev/null || true
          fi
          ls -lh ../release-updates/ || true

      - name: List build outputs
        working-directory: release
        run: ls -lh

      - name: Upload Linux packages
        uses: actions/upload-artifact@v4
        with:
          name: linux-packages
          path: |
            release/*.deb
            release-updates/latest-linux*.yml
          retention-days: 1

  # ===================================
  # 4. æ‰“åŒ…macOSåº”ç”¨
  # ===================================
  package-macos:
    name: Package macOS App
    runs-on: macos-latest
    needs: [build-backend, build-sdk]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package.json

      - name: Download backend artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: backend-darwin-*
          path: backend-bins

      - name: Download SDK artifact
        uses: actions/download-artifact@v4
        with:
          name: sdk-dist
          path: frontend/sdk/dist

      - name: Prepare backend binaries
        run: |
          cp backend-bins/backend-darwin-x64/vea ./vea-x64
          cp backend-bins/backend-darwin-arm64/vea ./vea-arm64
          chmod +x vea-*
          ls -lh vea-*

      - name: Set version
        working-directory: frontend
        run: |
          VERSION="${{ github.event.inputs.version }}"
          VERSION="${VERSION#v}"  # åŽ»æŽ‰ v å‰ç¼€
          npm version $VERSION --no-git-tag-version --allow-same-version
          echo "Version set to: $VERSION"

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Prepare release directories
        run: |
          rm -rf release
          rm -rf release-updates
          mkdir -p release
          mkdir -p release-updates

      - name: Build macOS x64 package
        working-directory: frontend
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cp ../vea-x64 ../vea
          chmod +x ../vea
          echo "=== Verifying x64 binary ==="
          file ../vea
          npm run build:mac -- --x64
          echo "=== Staging build outputs ==="
          ls -lh ../dist/electron/ || true
          echo "=== Collecting installers ==="
          cp -f ../dist/electron/*.dmg ../release/ 2>/dev/null || true
          cp -f ../dist/electron/*.zip ../release/ 2>/dev/null || true
          ls -lh ../release/ || true
          echo "=== Collecting updater assets ==="
          yml="$(ls ../dist/electron/latest-mac*.yml 2>/dev/null | head -n 1)"
          if [ -z "$yml" ]; then
            echo "latest-mac*.yml not found in dist/electron"
            exit 1
          fi
          cp -f "$yml" ../release-updates/latest-mac-x64.yml
          ls -lh ../release-updates/ || true

      - name: Clean for arm64 build
        run: |
          rm -rf frontend/node_modules/.cache/electron-builder
          rm -rf ~/Library/Caches/electron-builder
          rm -rf dist/electron
          rm -f vea

      - name: Build macOS arm64 package
        working-directory: frontend
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cp ../vea-arm64 ../vea
          chmod +x ../vea
          echo "=== Verifying arm64 binary ==="
          file ../vea
          npm run build:mac -- --arm64
          echo "=== Staging build outputs ==="
          ls -lh ../dist/electron/ || true
          echo "=== Collecting installers ==="
          cp -f ../dist/electron/*.dmg ../release/ 2>/dev/null || true
          cp -f ../dist/electron/*.zip ../release/ 2>/dev/null || true
          ls -lh ../release/ || true
          echo "=== Collecting updater assets ==="
          yml="$(ls ../dist/electron/latest-mac*.yml 2>/dev/null | head -n 1)"
          if [ -z "$yml" ]; then
            echo "latest-mac*.yml not found in dist/electron"
            exit 1
          fi
          cp -f "$yml" ../release-updates/latest-mac-arm64.yml
          ls -lh ../release-updates/ || true

      - name: Merge macOS updater yml
        working-directory: frontend
        run: |
          node - <<'NODE'
          const fs = require('fs')
          const yaml = require('js-yaml')

          const x64Path = '../release-updates/latest-mac-x64.yml'
          const arm64Path = '../release-updates/latest-mac-arm64.yml'
          const outPath = '../release-updates/latest-mac.yml'

          const x64 = yaml.load(fs.readFileSync(x64Path, 'utf8'))
          const arm64 = yaml.load(fs.readFileSync(arm64Path, 'utf8'))

          const files = []
          for (const src of [x64, arm64]) {
            const list = Array.isArray(src && src.files) ? src.files : []
            for (const f of list) files.push(f)
          }

          const dedup = new Map()
          for (const f of files) {
            if (!f || !f.url) continue
            dedup.set(f.url, f)
          }

          const merged = {
            version: (x64 && x64.version) || (arm64 && arm64.version),
            releaseDate: (x64 && x64.releaseDate) || (arm64 && arm64.releaseDate),
            files: Array.from(dedup.values()),
          }

          if (!merged.version) {
            throw new Error('Missing version in merged latest-mac.yml')
          }
          if (!merged.files.length) {
            throw new Error('Missing files in merged latest-mac.yml')
          }

          fs.writeFileSync(outPath, yaml.dump(merged), 'utf8')

          fs.rmSync(x64Path, { force: true })
          fs.rmSync(arm64Path, { force: true })
          NODE

      - name: Upload macOS packages
        uses: actions/upload-artifact@v4
        with:
          name: macos-packages
          path: |
            release/*.dmg
            release/*.zip
            release-updates/latest-mac.yml
          retention-days: 1

  # ===================================
  # 5. æ‰“åŒ…Windowsåº”ç”¨
  # ===================================
  package-windows:
    name: Package Windows App
    runs-on: windows-latest
    needs: [build-backend, build-sdk]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: frontend/package.json

      - name: Download backend artifact
        uses: actions/download-artifact@v4
        with:
          name: backend-windows-x64
          path: backend-bins

      - name: Download SDK artifact
        uses: actions/download-artifact@v4
        with:
          name: sdk-dist
          path: frontend/sdk/dist

      - name: Prepare backend binary
        shell: pwsh
        run: |
          Copy-Item backend-bins/vea.exe ./vea.exe
          Get-ChildItem vea.exe

      - name: Set version
        working-directory: frontend
        shell: pwsh
        run: |
          $VERSION = "${{ github.event.inputs.version }}"
          $VERSION = $VERSION -replace '^v', ''
          npm version $VERSION --no-git-tag-version --allow-same-version
          Write-Host "Version set to: $VERSION"

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Build Windows package
        working-directory: frontend
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: npm run build:win

      - name: Collect Windows installers
        shell: pwsh
        run: |
          Remove-Item -Recurse -Force release -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force release | Out-Null
          Remove-Item -Recurse -Force release-updates -ErrorAction SilentlyContinue
          New-Item -ItemType Directory -Force release-updates | Out-Null
          Copy-Item dist/electron/*.exe release/ -Force -ErrorAction SilentlyContinue
          Copy-Item dist/electron/*.zip release/ -Force -ErrorAction SilentlyContinue
          Copy-Item dist/electron/latest*.yml release-updates/ -Force -ErrorAction SilentlyContinue
          Get-ChildItem release
          Get-ChildItem release-updates

      - name: List build outputs
        working-directory: release
        shell: pwsh
        run: Get-ChildItem

      - name: Upload Windows package
        uses: actions/upload-artifact@v4
        with:
          name: windows-packages
          path: |
            release/*.exe
            release/*.zip
            release-updates/latest*.yml
          retention-days: 1

  # ===================================
  # 6. åˆ›å»ºGitHub Release
  # ===================================
  release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [package-linux, package-macos, package-windows]
    steps:
      - name: Download all packages
        uses: actions/download-artifact@v4
        with:
          pattern: '*-packages'
          path: release-dist

      - name: Organize release files
        working-directory: release-dist
        run: |
          mkdir -p ../dist
          find . -type f \( -name "*.deb" -o -name "*.dmg" -o -name "*.exe" -o -name "*.zip" \) -exec mv {} ../dist/ \;
          ls -lh ../dist/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: Vea ${{ github.event.inputs.version }}
          body: |
            # Vea ${{ github.event.inputs.version }}

            ${{ github.event.inputs.release_notes }}

            ## ä¸‹è½½

            ### Linux
            - **deb** (x64/arm64) - Debian/Ubuntu ç³»ç»Ÿ

            ### macOS
            - **dmg** (Intel/Apple Silicon) - æ”¯æŒ x64 å’Œ arm64
            - **zip** (Intel/Apple Silicon) - è‡ªåŠ¨æ›´æ–°ä½¿ç”¨ï¼ˆä¸€èˆ¬æ— éœ€æ‰‹åŠ¨ä¸‹è½½ï¼‰

            ### Windows
            - **exe** (x64) - NSIS å®‰è£…ç¨‹åº
            - **zip** (x64) - å…å®‰è£…åŽ‹ç¼©åŒ…ï¼ˆè§£åŽ‹å³ç”¨ï¼‰

            ## å®‰è£…è¯´æ˜Ž

            ### Linux (deb)
            \`\`\`bash
            sudo dpkg -i Vea-*-linux-amd64.deb
            \`\`\`

            ### macOS (dmg)
            åŒå‡»dmgæ–‡ä»¶ï¼Œæ‹–åŠ¨Veaåˆ°Applicationsæ–‡ä»¶å¤¹

            ### Windows (exe)
            åŒå‡»exeå®‰è£…ç¨‹åºï¼ŒæŒ‰æç¤ºå®‰è£…

            ---

            ðŸ¤– Generated with [Claude Code](https://claude.com/claude-code)
          draft: false
          prerelease: false
          files: dist/*
          token: ${{ secrets.GITHUB_TOKEN }}

  # ===================================
  # 7. éƒ¨ç½²è‡ªåŠ¨æ›´æ–°èµ„æºåˆ° GitHub Pages
  # ===================================
  deploy-pages:
    name: Deploy Updater Assets to GitHub Pages
    runs-on: ubuntu-latest
    needs: [package-linux, package-macos, package-windows]
    permissions:
      contents: read
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download all packages
        uses: actions/download-artifact@v4
        with:
          pattern: '*-packages'
          path: release-dist

      - name: Configure GitHub Pages
        uses: actions/configure-pages@v5

      - name: Prepare Pages content
        run: |
          rm -rf pages
          mkdir -p pages/updates
          touch pages/.nojekyll
          cat > pages/index.html <<'HTML'
          <!doctype html>
          <meta charset="utf-8">
          <title>Vea Updates</title>
          <p>This site hosts Vea auto-update artifacts.</p>
          HTML

          # Update metadata (Windows/macOS)
          find release-dist -type f -name "latest.yml" -exec cp -f {} pages/updates/ \;
          find release-dist -type f -name "latest-mac.yml" -exec cp -f {} pages/updates/ \;

          # Updater payloads
          find release-dist -type f \( -name "*.exe" -o -name "*-macos-*.zip" \) -exec cp -f {} pages/updates/ \;

          ls -lah pages/updates || true

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: pages

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
